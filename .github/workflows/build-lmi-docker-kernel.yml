
name: Build Docker-ready kernel (SM8250/lmi) — v3.3

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: "Kernel repo URL"
        required: false
        default: "https://github.com/liyafe1997/kernel_xiaomi_sm8250_mod"
      branch:
        description: "Kernel branch"
        required: true
        default: "android15-lineage22-mod"
      device:
        description: "Device codename"
        required: true
        default: "lmi"
      enable_docker_configs:
        description: "Force-enable Docker-required CONFIG_*"
        required: true
        default: "true"
      ak3_kernel_string:
        description: "AnyKernel3 display string"
        required: false
        default: "Docker-ready SM8250 kernel for lmi (crDroid)"
      ak3_supported_versions:
        description: "ROM Android versions (list or range)"
        required: false
        default: "14, 15"
      release_tag:
        description: "Release tag (auto if empty)"
        required: false
        default: ""

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
      SUBARCH: arm64
      OUT: out
      CC: clang
      LLVM: 1
      KBUILD_BUILD_USER: "gh-actions"
      KBUILD_BUILD_HOST: "ubuntu"
      TZ: "Asia/Shanghai"

    steps:
      - name: Checkout current repo (for patches & scripts)
        uses: actions/checkout@v4

      - name: Clone kernel source
        run: |
          set -e
          git clone --depth=1 -b "${{ inputs.branch }}" "${{ inputs.repo_url }}" kernel_src
          cd kernel_src
          git rev-parse --short HEAD

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y             bc bison flex             libssl-dev libelf-dev dwarves             git curl wget zip unzip             python3 python3-pip             build-essential             clang-15 llvm-15 lld-15             gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          sudo ln -sf /usr/bin/clang-15 /usr/bin/clang
          sudo ln -sf /usr/bin/ld.lld-15 /usr/bin/ld.lld

      - name: Prepare .config from defconfig (lmi_defconfig)
        working-directory: kernel_src
        run: |
          set -e
          mkdir -p ${OUT}
          make O=${OUT} ARCH=${ARCH} lmi_defconfig
          make O=${OUT} ARCH=${ARCH} scripts

      - name: Normalize kernel/Makefile rule for config_data.gz (robust)
        working-directory: kernel_src
        run: |
          set -e
          bash ../.ci/scripts/fix_makefile.sh

      - name: Try applying local xt_qtaguid patch (non-fatal)
        working-directory: kernel_src
        run: |
          set -e
          if [ -f ../.ci/patches/0002-netfilter-xt_qtaguid-use-no_dev_stats.patch ]; then
            echo "[INFO] Attempt to apply local xt_qtaguid patch"
            if ! git apply --reject --verbose ../.ci/patches/0002-netfilter-xt_qtaguid-use-no_dev_stats.patch; then
              echo "[WARN] git apply failed, try patch -p1 (non-fatal)"
              patch -p1 < ../.ci/patches/0002-netfilter-xt_qtaguid-use-no_dev_stats.patch || echo "[WARN] xt_qtaguid local patch failed; continue"
            fi
          else
            echo "[INFO] No local xt_qtaguid patch found; continue"
          fi

      - name: Force-enable Docker-required CONFIGs
        if: ${{ inputs.enable_docker_configs == 'true' }}
        working-directory: kernel_src
        run: |
          set -e
          CFG="${OUT}/.config"
          SC="./scripts/config"
          enable_y () { ${SC} --file "${CFG}" --enable "$1" || true; }
          enable_m () { ${SC} --file "${CFG}" --module "$1" || true; }

          # /proc/config.gz embedding and localversion marker
          enable_y CONFIG_IKCONFIG
          enable_y CONFIG_IKCONFIG_PROC
          ${SC} --file "${CFG}" --set-str CONFIG_LOCALVERSION "-docker-ready" || true

          # Namespaces
          for K in NAMESPACES UTS_NS IPC_NS PID_NS NET_NS USER_NS; do enable_y CONFIG_${K}; done
          # cgroups
          for K in CGROUPS CGROUP_DEVICE CPUSETS CGROUP_CPUACCT BLK_CGROUP MEMCG CGROUP_PIDS CGROUP FREEZER CGROUP SCHED CGROUP WRITEBACK; do enable_y CONFIG_${K}; done
          # overlayfs
          enable_y CONFIG_OVERLAY_FS
          # networking & netfilter
          for K in VETH BRIDGE BRIDGE_NETFILTER NETFILTER NETFILTER_XTABLES                    NF_CONNTRACK NF_NAT IP_NF_IPTABLES IP_NF_FILTER IP_NF_MANGLE IP_NF_RAW IP_NF_SECURITY                    IP_NF_TARGET_MASQUERADE NETFILTER_XT_MATCH_ADDRTYPE NETFILTER_XT_MATCH_CONNTRACK NETFILTER_XT_MATCH STATE NETFILTER_XT_MATCH_STATISTIC; do
            enable_y CONFIG_${K}
          done
          # Docker 28+ ipset
          enable_m CONFIG_IP_SET
          enable_m CONFIG_IP_SET_HASH_NET
          enable_m CONFIG_NETFILTER_XT_SET

          make O=${OUT} ARCH=${ARCH} olddefconfig
          egrep -i 'CONFIG_(IKCONFIG|LOCALVERSION|NAMESPACES|CGROUP|OVERLAY|VETH|BRIDGE|NETFILTER|IP_SET|XT_SET|NF_|IP_NF_)' ${OUT}/.config | sort

      - name: Validate container compatibility (Moby check-config.sh)
        working-directory: kernel_src
        run: |
          set -e
          wget -O /tmp/check-config.sh https://raw.githubusercontent.com/moby/moby/master/contrib/check-config.sh
          chmod +x /tmp/check-config.sh
          /tmp/check-config.sh ${OUT}/.config || true

      - name: Build kernel (Image.gz / Image.gz-dtb)
        working-directory: kernel_src
        run: |
          set -e
          export ARCH=${ARCH}
          export SUBARCH=${SUBARCH}
          export CC=clang
          export LD=ld.lld
          make O=${OUT} -j$(nproc)
          ls -la ${OUT}/arch/arm64/boot || true

      - name: Fetch AnyKernel3 & pack zip
        run: |
          set -e
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          cd ak3
          sed -i "s|^kernel.string=.*|kernel.string="${{ inputs.ak3_kernel_string }}"|" anykernel.sh
          sed -i "s|^device.name1=.*|device.name1=${{ inputs.device }}|" anykernel.sh
          sed -i "s|^supported.versions=.*|supported.versions=${{ inputs.ak3_supported_versions }}|" anykernel.sh

          mkdir -p kernel
          if [ -f ../kernel_src/${OUT}/arch/arm64/boot/Image.gz-dtb ]; then
            cp ../kernel_src/${OUT}/arch/arm64/boot/Image.gz-dtb kernel/
          elif [ -f ../kernel_src/${OUT}/arch/arm64/boot/Image.gz ]; then
            cp ../kernel_src/${OUT}/arch/arm64/boot/Image.gz kernel/
          else
            echo "No Image.gz[-dtb] found!" && exit 1
          fi

          ZIP="../Docker-ready-kernel-${{ inputs.device }}-${{ inputs.branch }}.zip"
          zip -r9 "$ZIP" ./
          echo "AK3 zip: $ZIP"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lmi-docker-kernel-${{ inputs.branch }}-v3.3
          path: |
            Docker-ready-kernel-${{ inputs.device }}-${{ inputs.branch }}.zip
            kernel_src/out/arch/arm64/boot/*
            kernel_src/out/.config

      - name: Prepare Release metadata
        id: meta
        run: |
          set -e
          DATE=$(date +'%Y%m%d')
          if [ -z "${{ inputs.release_tag }}" ]; then
            TAG="lmi-docker-${{ inputs.branch }}-${DATE}-v3.3"
          else
            TAG="${{ inputs.release_tag }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "name=Docker-ready kernel for lmi (${TAG})" >> $GITHUB_OUTPUT
          echo "body=          ## Docker-ready kernel for lmi — v3.3
          - Repo: ${{ inputs.repo_url }}
          - Branch: ${{ inputs.branch }}
          - Defconfig: lmi_defconfig
          - Includes Docker CONFIGs (namespaces/cgroups/overlayfs/netfilter/ipset/veth/bridge)
          - Makefile normalized to use $(KCONFIG_CONFIG) for config_data.gz
          - Packed with AnyKernel3

          ### Notes
          - overlay2 requires CONFIG_OVERLAY_FS and proper backing FS.
          - Docker 28+ requires ipset-related kernel options.
          " >> $GITHUB_OUTPUT

      - name: Create Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.name }}
          body: ${{ steps.meta.outputs.body }}
          draft: false
          prerelease: false
          files: |
            Docker-ready-kernel-${{ inputs.device }}-${{ inputs.branch }}.zip
            kernel_src/out/arch/arm64/boot/Image*
            kernel_src/out/.config
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
