name: Build Docker-ready kernel (SM8250/lmi) - v3.8

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: "Kernel repo URL"
        required: true
        default: "https://github.com/liyafe1997/kernel_xiaomi_sm8250_mod"
      branch:
        description: "Kernel branch"
        required: true
        default: "android15-lineage22-mod"
      device:
        description: "Device codename"
        required: true
        default: "lmi"
      release_tag:
        description: "Release tag (auto if empty)"
        required: false
        default: ""

permissions:
  contents: write

concurrency:
  group: docker-kernel-lmi-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
      SUBARCH: arm64
      OUT: out
      CC: clang
      LD: ld.lld
      LLVM: -15
      KBUILD_BUILD_USER: "gh-actions"
      KBUILD_BUILD_HOST: "ubuntu"
      TZ: "Asia/Shanghai"

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Clone kernel source
        run: |
          set -e
          git clone --depth=1 -b "${{ inputs.branch }}" "${{ inputs.repo_url }}" kernel_src
          cd kernel_src
          git rev-parse --short HEAD

      - name: Install build deps (clang/llvm/binutils)
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y \
            bc bison flex \
            libssl-dev libelf-dev dwarves \
            git curl wget zip unzip \
            python3 python3-pip \
            build-essential \
            clang-15 llvm-15 lld-15 \
            llvm-15-tools \
            binutils-aarch64-linux-gnu \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          # unsuffixed symlinks for CC/LD; other llvm-* use LLVM=-15
          sudo ln -sf /usr/bin/clang-15 /usr/bin/clang
          sudo ln -sf /usr/bin/ld.lld-15 /usr/bin/ld.lld
          sudo ln -sf /usr/bin/llvm-objdump-15 /usr/bin/llvm-objdump
          sudo ln -sf /usr/bin/llvm-objcopy-15 /usr/bin/llvm-objcopy
          sudo ln -sf /usr/bin/llvm-ar-15 /usr/bin/llvm-ar
          sudo ln -sf /usr/bin/llvm-nm-15 /usr/bin/llvm-nm

      - name: Verify LLVM toolchain presence
        run: |
          set -e
          for t in clang-15 ld.lld-15 llvm-objdump-15 llvm-objcopy-15 llvm-ar-15 llvm-nm-15; do
            which $t && $t --version || true; done
          for t in clang ld.lld llvm-objdump llvm-objcopy llvm-ar llvm-nm; do
            which $t && $t --version || true; done

      #####################################################################
      # PATCHES — apply BEFORE configuration & build
      #####################################################################

      - name: Apply REQUIRED cgroup.patch (must succeed)
        working-directory: kernel_src
        run: |
          set -e
          URL="https://raw.githubusercontent.com/MIGHTYBLANK001/kernel-build-by-AI/refs/heads/main/patch/cgroup.patch"
          echo "[INFO] Fetch: $URL"
          curl -L -o /tmp/cgroup.patch "$URL"
          # try git apply; fallback to patch; if all fail → exit 1
          if ! git apply --reject --verbose /tmp/cgroup.patch; then
            echo "[WARN] git apply failed; trying patch -p0/-p1"
            patch -p0 < /tmp/cgroup.patch || patch -p1 < /tmp/cgroup.patch
          fi
          echo "[INFO] cgroup.patch applied successfully."

      - name: Conditionally apply xt_qtaguid.patch (only if module/config present)
        working-directory: kernel_src
        run: |
          set -e
          URL="https://raw.githubusercontent.com/MIGHTYBLANK001/kernel-build-by-AI/refs/heads/main/patch/xt_qtaguid.patch"
          echo "[INFO] Fetch: $URL"
          curl -L -o /tmp/xt_qtaguid.patch "$URL"

          TARGET_FILE=""
          for cand in \
            net/netfilter/xt_qtaguid.c \
            kernel/net/netfilter/xt_qtaguid.c \
            net/netfilter/xt_qtaguid/xt_qtaguid.c \
            kernel/net/netfilter/xt_qtaguid/xt_qtaguid.c ; do
            if [ -f "$cand" ]; then TARGET_FILE="$cand"; break; fi
          done

          HAS_CFG=$(grep -Rsn "CONFIG_NETFILTER_XT_MATCH_QTAGUID" . || true)
          if [ -n "$TARGET_FILE" ] || [ -n "$HAS_CFG" ]; then
            echo "[INFO] xt_qtaguid detected (file=$TARGET_FILE, cfg=$( [ -n "$HAS_CFG" ] && echo yes || echo no ) ); applying patch."
            if ! git apply --reject --verbose /tmp/xt_qtaguid.patch; then
              echo "[WARN] git apply failed; trying patch -p0/-p1 (non-fatal)"
              patch -p0 < /tmp/xt_qtaguid.patch || patch -p1 < /tmp/xt_qtaguid.patch || echo "[WARN] xt_qtaguid patch failed; continue."
            fi
          else
            echo "[INFO] xt_qtaguid not present in this kernel tree; skip patch."
          fi

      #####################################################################
      # CONFIGURATION — defconfig + force-enable Docker & eBPF configs
      #####################################################################

      - name: Prepare .config from defconfig (lmi_defconfig)
        working-directory: kernel_src
        run: |
          set -e
          mkdir -p ${OUT}
          export ARCH=arm64
          export SUBARCH=arm64
          export CC=clang
          export LD=ld.lld
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CLANG_TRIPLE=aarch64-linux-gnu-
          make LLVM=${LLVM} O=${OUT} ARCH=${ARCH} lmi_defconfig
          make LLVM=${LLVM} O=${OUT} ARCH=${ARCH} scripts

      - name: Force-enable Docker & eBPF configs (maximal set)
        working-directory: kernel_src
        run: |
          set -e
          export ARCH=arm64
          export SUBARCH=arm64
          export CC=clang
          export LD=ld.lld
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CLANG_TRIPLE=aarch64-linux-gnu-
          CFG="${OUT}/.config"
          SC="./scripts/config"

          enable_y () { ${SC} --file "${CFG}" --enable "$1" || true; }
          enable_m () { ${SC} --file "${CFG}" --module "$1" || true; }
          set_str () { ${SC} --file "${CFG}" --set-str "$1" "$2" || true; }

          # /proc/config.gz embedding + localversion
          enable_y CONFIG_IKCONFIG
          enable_y CONFIG_IKCONFIG_PROC
          set_str CONFIG_LOCALVERSION "-docker-ready-ebpf"

          # Namespaces
          for K in NAMESPACES UTS_NS IPC_NS PID_NS NET_NS USER_NS; do enable_y CONFIG_${K}; done

          # cgroups + v2 + perf/hugetlb/bpf
          for K in CGROUPS CGROUP_DEVICE CPUSETS CGROUP_CPUACCT BLK_CGROUP MEMCG CGROUP_PIDS CGROUP_FREEZER CGROUP_SCHED CGROUP_WRITEBACK CGROUP_PERF CGROUP_HUGETLB CGROUP_BPF; do
            enable_y CONFIG_${K}
          done

          # eBPF core (开启 eBPF/JIT/XDP/BPF in net)
          for K in BPF BPF_SYSCALL BPF_JIT HAVE_EBPF_JIT; do enable_y CONFIG_${K}; done
          for K in NET_CLS_BPF NET_ACT_BPF BPFILTER XDP_SOCKETS; do
            # XDP_SOCKETS 在部分内核版本命名为 CONFIG_XDP_SOCKETS；不存在时不报错
            enable_y CONFIG_${K}
          done

          # overlayfs
          enable_y CONFIG_OVERLAY_FS

          # 网络 & netfilter（IPv4/IPv6）
          for K in VETH BRIDGE BRIDGE_NETFILTER NETFILTER NETFILTER_XTABLES \
                   NF_CONNTRACK NF_NAT \
                   IP_NF_IPTABLES IP_NF_FILTER IP_NF_MANGLE IP_NF_RAW IP_NF_SECURITY IP_NF_TARGET_MASQUERADE \
                   IP6_NF_FILTER IP6_NF_MANGLE IP6_NF_RAW IP6_NF_NAT IP6_NF_TARGET_MASQUERADE; do
            enable_y CONFIG_${K}
          done

          # ipset 家族（Docker 28+ 要求）
          enable_m CONFIG_IP_SET
          enable_m CONFIG_IP_SET_HASH_NET
          enable_m CONFIG_NETFILTER_XT_SET

          # nftables 家族（新栈）
          for K in NF_TABLES NFT_CT NFT_MASQ NFT_NAT NFT_FIB_IPV4 NFT_FIB_IPV6; do
            enable_y CONFIG_${K}
          done

          # 可选：IPVS（swarm/k8s IPVS 模式）
          for K in IP_VS IP_VS_NFCT IP_VS_PROTO_TCP IP_VS_PROTO_UDP IP_VS_RR; do
            enable_y CONFIG_${K}
          done

          # 生成最终 .config
          make LLVM=${LLVM} O=${OUT} ARCH=${ARCH} olddefconfig

          echo "[INFO] Effective Docker/eBPF configs in final .config:"
          egrep -i 'CONFIG_(IKCONFIG|LOCALVERSION|NAMESPACES|CGROUP|BPF|XDP|OVERLAY|VETH|BRIDGE|NETFILTER|IP_SET|XT_SET|NF_TABLES|NFT_|IP_VS|IP_NF_)' ${OUT}/.config | sort || true

      - name: Validate with Moby check-config.sh (informational)
        working-directory: kernel_src
        run: |
          set -e
          wget -O /tmp/check-config.sh https://raw.githubusercontent.com/moby/moby/master/contrib/check-config.sh
          chmod +x /tmp/check-config.sh
          /tmp/check-config.sh ${OUT}/.config || true

      #####################################################################
      # BUILD — kernel (no AnyKernel3 packaging)
      #####################################################################

      - name: Build kernel (Image.gz / Image.gz-dtb)
        working-directory: kernel_src
        run: |
          set -e
          export ARCH=arm64
          export SUBARCH=arm64
          export CC=clang
          export LD=ld.lld
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CLANG_TRIPLE=aarch64-linux-gnu-
          # 如需进一步安静掉 LSE 警告，可启用：export KBUILD_CFLAGS="$KBUILD_CFLAGS -march=armv8-a+lse"
          make LLVM=${LLVM} O=${OUT} -j$(nproc)
          ls -la ${OUT}/arch/arm64/boot || true

      - name: Upload artifacts (no AK3 zip)
        uses: actions/upload-artifact@v4
        with:
          name: lmi-docker-kernel-${{ inputs.branch }}-v3.8
          path: |
            kernel_src/out/arch/arm64/boot/Image*
            kernel_src/out/.config

      - name: Prepare Release metadata
        id: meta
        run: |
          set -e
          DATE=$(date +'%Y%m%d')
          if [ -z "${{ inputs.release_tag }}" ]; then
            TAG="lmi-docker-${{ inputs.branch }}-${DATE}-v3.8"
          else
            TAG="${{ inputs.release_tag }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "name=Docker-ready kernel (no AK3) for lmi (${TAG})" >> $GITHUB_OUTPUT
          echo "body=\
          ## Docker-ready kernel for lmi — v3.8 (no AK3)\\n\
          - Repo: ${{ inputs.repo_url }}\\n\
          - Branch: ${{ inputs.branch }}\\n\
          - Defconfig: lmi_defconfig\\n\
          - Patches: cgroup.patch (required) + xt_qtaguid.patch (conditional)\\n\
          - Docker & eBPF configs enabled (namespaces/cgroups/overlayfs/netfilter/ipset/nftables/ebpf/xdp)\\n\
          " >> $GITHUB_OUTPUT

      - name: Create Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.name }}
          body: ${{ steps.meta.outputs.body }}
          draft: false
          prerelease: false
          files: |
            kernel_src/out/arch/arm64/boot/Image*
            kernel_src/out/.config
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
