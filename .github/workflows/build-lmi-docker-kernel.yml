name: Build lmi Kernel → Docker-ready configs → AnyKernel3 → Release

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "要构建的内核源码分支（留空则用远端默认分支）"
        required: false
  push:
    branches: [ "*" ]

permissions:
  contents: write

env:
  ARCH: arm64
  SUBARCH: arm64
  THREADS_DEFAULT: 8
  KERNEL_REPO: https://github.com/ApartTUSITU/kernel_xiaomi_sm8250_mod
  DEFCONFIG_PATH: arch/arm64/configs/lmi_defconfig
  CLANG_URL: https://github.com/kdrag0n/proton-clang/archive/refs/tags/20210522.tar.gz
  CLANG_DIR: toolchains/proton-clang
  ANYKERNEL3_REPO: https://github.com/osm0sis/AnyKernel3.git
  PATCH_CGROUP_URL: https://raw.githubusercontent.com/MIGHTYBLANK001/kernel-build-by-AI/refs/heads/main/patch/cgroup.patch
  PATCH_QTAGUID_URL: https://raw.githubusercontent.com/MIGHTYBLANK001/kernel-build-by-AI/refs/heads/main/patch/xt_qtaguid.patch

jobs:
  build-package-release:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare workspace
        run: mkdir -p workspace

      # 依赖：增加交叉 GCC，满足脚本探测需求（gcc-version.sh）
      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            coreutils util-linux \
            bc bison flex libssl-dev \
            libelf-dev dwarves pkg-config zstd \
            zip unzip python3 rsync ccache git curl tar \
            patch xz-utils gzip \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi

      - name: Clone kernel source
        id: kernel_clone
        run: |
          set -e
          cd workspace
          REPO="${KERNEL_REPO}"
          USER_BRANCH="${{ github.event.inputs.branch }}"
          if [ -n "${USER_BRANCH}" ]; then
            git clone --depth=1 --branch "${USER_BRANCH}" "${REPO}" kernel_src
            echo "branch=${USER_BRANCH}" >> "$GITHUB_OUTPUT"
          else
            DEFAULT_BRANCH="$(git ls-remote --symref "${REPO}" HEAD | awk '/^ref:/ {print $2}' | awk -F'/' '{print $NF}')"
            [ -z "${DEFAULT_BRANCH}" ] && { echo "::error::Detect default branch failed"; exit 1; }
            git clone --depth=1 --branch "${DEFAULT_BRANCH}" "${REPO}" kernel_src
            echo "branch=${DEFAULT_BRANCH}" >> "$GITHUB_OUTPUT"
          fi

      # 下载工具链但不修改 Runner 的全局 PATH（避免 host 阶段误用）
      - name: Fetch Proton-Clang (toolchain)
        run: |
          mkdir -p "${CLANG_DIR}"
          curl -L "${CLANG_URL}" | tar -xz --strip-components=1 -C "${CLANG_DIR}"

      - name: Fetch patches (cgroup + xt_qtaguid)
        run: |
          set -eux
          cd workspace
          curl -L "${PATCH_CGROUP_URL}"  -o cgroup.patch
          curl -L "${PATCH_QTAGUID_URL}" -o xt_qtaguid.patch

      - name: Apply cgroup.patch (mandatory)
        run: |
          set -eux
          cd workspace/kernel_src
          (git apply --index ../cgroup.patch) || (patch -p1 < ../cgroup.patch)

      - name: Conditionally apply xt_qtaguid.patch
        run: |
          set -eux
          cd workspace/kernel_src
          if grep -R -I -nE "qtaguid|XT_QTAGUID|NETFILTER_XT_(MATCH|TARGET)_QTAGUID" . ; then
            (git apply --index ../xt_qtaguid.patch) || (patch -p1 < ../xt_qtaguid.patch)
          else
            echo "xt_qtaguid not found; skip."
          fi

      # --- Host 阶段：清理/defconfig/scripts（只用系统 gcc/ld；不设 LLVM=1/LD） ---
      - name: Kernel clean (host tools only)
        run: |
          set -eux
          cd workspace/kernel_src
          make O=out ARCH=${ARCH} HOSTCC=gcc HOSTCXX=g++ HOSTLD=/usr/bin/ld clean || true
          make O=out ARCH=${ARCH} HOSTCC=gcc HOSTCXX=g++ HOSTLD=/usr/bin/ld mrproper || true

      - name: Defconfig (host tools only)
        run: |
          set -eux
          cd workspace/kernel_src
          [ -f "${DEFCONFIG_PATH}" ] || { echo "::error::DEFCONFIG missing"; exit 1; }
          # ✅ 正确：不要带路径，直接用目标名 lmi_defconfig
          make O=out ARCH=${ARCH} HOSTCC=gcc HOSTCXX=g++ HOSTLD=/usr/bin/ld lmi_defconfig

          # 如果你更偏好显式路径，也可以改成：
          # make O=out ARCH=${ARCH} HOSTCC=gcc HOSTCXX=g++ HOSTLD=/usr/bin/ld \
          #     KCONFIG_DEFCONFIG=${DEFCONFIG_PATH} defconfig

      - name: Build kernel scripts (to get scripts/config)
        run: |
          set -eux
          cd workspace/kernel_src
          make O=out ARCH=${ARCH} HOSTCC=gcc HOSTLD=/usr/bin/ld scripts

      # --- 开启全部 Docker 支持项（参考 moby check-config） ---
      - name: Enable ALL Docker-related kernel configs
        run: |
          set -eux
          cd workspace/kernel_src
          enable() { scripts/config --enable "$1" || true; }
          module() { scripts/config --module "$1" || true; }

          # Generally Necessary
          for K in CONFIG_NAMESPACES CONFIG_NET_NS CONFIG_PID_NS CONFIG_IPC_NS CONFIG_UTS_NS CONFIG_USER_NS \
                   CONFIG_KEYS CONFIG_SECCOMP CONFIG_DEVPTS_MULTIPLE_INSTANCES CONFIG_POSIX_MQUEUE \
                   CONFIG_CGROUPS CONFIG_CGROUP_CPUACCT CONFIG_CGROUP_DEVICE CONFIG_CGROUP_FREEZER \
                   CONFIG_CGROUP_SCHED CONFIG_CPUSETS CONFIG_MEMCG \
                   CONFIG_VETH CONFIG_BRIDGE CONFIG_BRIDGE_NETFILTER \
                   CONFIG_IP_NF_FILTER CONFIG_IP_NF_MANGLE CONFIG_IP_NF_NAT CONFIG_NF_NAT CONFIG_NF_NAT_NEEDED \
                   CONFIG_IP_NF_TARGET_MASQUERADE CONFIG_NETFILTER_XT_MATCH_ADDRTYPE CONFIG_NETFILTER_XT_MATCH_CONNTRACK
          do enable "$K"; done
          module CONFIG_NETFILTER_XT_MATCH_IPVS

          # Optional Features
          for K in CONFIG_CGROUP_PIDS CONFIG_BLK_CGROUP CONFIG_CGROUP_PERF CONFIG_CGROUP_HUGETLB \
                   CONFIG_NET_CLS_CGROUP CONFIG_CGROUP_NET_PRIO CONFIG_CFS_BANDWIDTH CONFIG_FAIR_GROUP_SCHED CONFIG_RT_GROUP_SCHED \
                   CONFIG_MEMCG_SWAP CONFIG_MEMCG_SWAP_ENABLED CONFIG_MEMCG_KMEM
          do enable "$K"; done

          # Network drivers
          for K in CONFIG_VXLAN CONFIG_MACVLAN CONFIG_IPVLAN CONFIG_DUMMY; do module "$K"; done

          # Encrypted networks / IPsec
          for K in CONFIG_CRYPTO CONFIG_CRYPTO_AEAD CONFIG_CRYPTO_GCM CONFIG_CRYPTO_SEQIV CONFIG_CRYPTO_GHASH CONFIG_XFRM CONFIG_XFRM_USER
          do enable "$K"; done
          for K in CONFIG_XFRM_ALGO CONFIG_INET_ESP CONFIG_INET_XFRM_MODE_TRANSPORT; do module "$K"; done

          # Storage drivers
          enable CONFIG_OVERLAY_FS
          module CONFIG_BLK_DEV_DM
          module CONFIG_DM_THIN_PROVISIONING
          module CONFIG_BTRFS_FS
          module CONFIG_BTRFS_FS_POSIX_ACL

          # Docker 28+ ipset
          module CONFIG_IP_SET
          module CONFIG_IP_SET_HASH_NET
          module CONFIG_NETFILTER_XT_SET

          make O=out olddefconfig

      - name: Run moby check-config.sh against out/.config
        run: |
          set -eux
          cd workspace/kernel_src
          curl -L https://github.com/moby/moby/raw/master/contrib/check-config.sh -o check-config.sh
          chmod +x check-config.sh
          ./check-config.sh out/.config | tee ../docker-kernel-check.txt

      # --- 目标内核编译：仅在此步启用 LLVM=1 + CC=clang（局部传工具链根） ---
      - name: Build kernel (target; LLVM/Clang)
        run: |
          set -eux
          cd workspace/kernel_src
          JOBS="$(getconf _NPROCESSORS_ONLN 2>/dev/null || echo ${THREADS_DEFAULT})"
          make -j"${JOBS}" O=out ARCH=${ARCH} \
            LLVM="${PWD}/../../${CLANG_DIR}/bin/" \
            CC=clang LD=ld.lld \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi-

      - name: Locate built image
        id: findimg
        run: |
          set -e
          cd workspace/kernel_src
          for f in out/arch/arm64/boot/Image.gz-dtb out/arch/arm64/boot/Image.gz out/arch/arm64/boot/Image-dtb out/arch/arm64/boot/Image
          do [ -f "$f" ] && { echo "image=$f" >> "$GITHUB_OUTPUT"; echo "Found: $f"; exit 0; }; done
          echo "::error::未找到内核镜像"; exit 1

      - name: Clone AnyKernel3 & disable device check
        run: |
          set -eux
          cd workspace
          git clone --depth=1 "${ANYKERNEL3_REPO}" ak3
          sed -i "s/^do.devicecheck=.*/do.devicecheck=0/" ak3/anykernel.sh
          sed -i '/^device.name[0-9]\+=/d' ak3/anykernel.sh
          BRANCH="${{ steps.kernel_clone.outputs.branch }}"
          sed -i "s/^kernel.string=.*/kernel.string=${BRANCH} $(date +%Y-%m-%d)/" ak3/anykernel.sh

      - name: Prepare AK3 payload (image at zip root)
        run: |
          set -eux
          cd workspace
          cp "kernel_src/${{ steps.findimg.outputs.image }}" ak3/
          if [ -d "kernel_src/out/lib/modules" ]; then
            rsync -a kernel_src/out/lib/modules/ ak3/modules/system/lib/modules/
          fi

      - name: Make flashable zip (zip -9 deflate)
        id: mkzip
        run: |
          set -eux
          cd workspace
          BRANCH="${{ steps.kernel_clone.outputs.branch }}"
          TS="$(date +%Y%m%d-%H%M%S)"
          PKG="${BRANCH}-${TS}"
          (cd ak3 && zip -9 -r "../${PKG}.zip" .)
          echo "pkg=${PKG}" >> "$GITHUB_OUTPUT"
          ls -lh "${PKG}.zip"

      - name: Upload check report artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-kernel-check
          path: workspace/docker-kernel-check.txt

      - name: Create Release & Upload asset
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.mkzip.outputs.pkg }}
          name: ${{ steps.mkzip.outputs.pkg }}
          body: |
            Device: lmi
            Branch: ${{ steps.kernel_clone.outputs.branch }}
            Patches: cgroup (mandatory), xt_qtaguid (conditional)
            Docker configs: enabled per moby check-config; see artifact.
            Package: ${{ steps.mkzip.outputs.pkg }}.zip
            AnyKernel3: devicecheck=0; image at zip root; deflate zip.
          artifacts: workspace/${{ steps.mkzip.outputs.pkg }}.zip
          allowUpdates: true
