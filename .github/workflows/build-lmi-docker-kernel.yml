
name: Build kernel (lmi / AOSP) â€“ expanded workflow (no build.sh, moby check-config)

on:
  workflow_dispatch:
    inputs:
      kernel_repo:
        description: "ç›®æ ‡å†…æ ¸æºç ä»“åº“ï¼ˆowner/repoï¼‰"
        default: "Anr-C/kernel_xiaomi_sm8250_mod"
        required: true
      kernel_branch:
        description: "è¦æ„å»ºçš„åˆ†æ”¯ï¼›ç•™ç©ºåˆ™ä½¿ç”¨ä»“åº“é»˜è®¤åˆ†æ”¯"
        default: ""
        required: false

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      # å›ºå®šå‚æ•°ï¼šæœºå‹ä¸ ROM ç±»å‹
      TARGET_DEVICE: lmi
      BUILD_AOSP: "1"     # å›ºå®šä¸º AOSP
      KSU_ENABLE: "0"     # æ­¤é€»è¾‘ä¸åŒ…å« KernelSU/SukiSU
      # ä¸åŸè„šæœ¬ä¿æŒä¸€è‡´çš„å·¥å…·é“¾å’Œç¼“å­˜è·¯å¾„
      TOOLCHAIN_PATH: ${{ github.workspace }}/../proton-clang/proton-clang-20210522/bin
      CCACHE_DIR: ${{ github.workspace }}/../.cache/ccache_mikernel
      MAKE_ARGS: "ARCH=arm64 SUBARCH=arm64 O=out CC=clang CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- CROSS_COMPILE_COMPAT=arm-linux-gnueabi- CLANG_TRIPLE=aarch64-linux-gnu-"

    steps:
      # 0) æ£€å‡ºæ‰¿è½½å·¥ä½œæµçš„ä»“åº“ï¼ˆè‹¥å·¥ä½œæµä¸åœ¨ç›®æ ‡ä»“åº“ï¼Œæ­¤æ­¥ä¾ç„¶éœ€è¦ï¼‰
      - name: Checkout workflow repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1) å…ˆæ‹‰å–ç›®æ ‡ä»“åº“æºç è‡³ kernel-src â€”â€” æŒ‡å®šåˆ†æ”¯
      - name: Checkout target kernel repo (specific branch) to kernel-src
        if: ${{ inputs.kernel_branch != '' }}
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.kernel_repo }}
          ref: ${{ inputs.kernel_branch }}
          path: kernel-src
          submodules: recursive
          fetch-depth: 0

      # 1b) æ‹‰å–ç›®æ ‡ä»“åº“æºç è‡³ kernel-src â€”â€” é»˜è®¤åˆ†æ”¯
      - name: Checkout target kernel repo (default branch) to kernel-src
        if: ${{ inputs.kernel_branch == '' }}
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.kernel_repo }}
          path: kernel-src
          submodules: recursive
          fetch-depth: 0

      # 2) ä¾èµ–å®‰è£…
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison flex libssl-dev \
            zip unzip git patch \
            build-essential make \
            ccache \
            binutils-aarch64-linux-gnu binutils-arm-linux-gnueabi
          echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV

      # 3) æå‡ ccache å‘½ä¸­ï¼ˆå¯é€‰å¢å¼ºï¼‰
      - name: Enable ccache cache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ github.job }}-${{ inputs.kernel_repo }}-${{ inputs.kernel_branch }}-lmi-aosp
          max-size: 2G
          create-symlink: true

      # 4) æ‹‰å– Proton Clang 20210522ï¼ˆåŸè„šæœ¬è¦æ±‚çš„è·¯å¾„ä¸ç‰ˆæœ¬ï¼‰
      - name: Fetch Proton Clang 20210522 (expected by original logic)
        run: |
          mkdir -p $HOME/proton-clang
          git clone --depth=1 --branch 20210522 https://github.com/kdrag0n/proton-clang \
            $HOME/proton-clang/proton-clang-20210522
          echo "PATH=${TOOLCHAIN_PATH}:$PATH" >> $GITHUB_ENV

      # 5) æ˜¾ç¤ºå·¥å…·é“¾/é“¾æ¥å™¨ç‰ˆæœ¬
      - name: Show toolchain & binutils versions
        run: |
          which clang || true
          clang --version || true
          aarch64-linux-gnu-ld --version || true
          arm-linux-gnueabi-ld --version || true

      # 6) ä»£ç æ¸…ç†
      - name: Clean working tree
        working-directory: kernel-src
        run: |
          git reset --hard HEAD
          git clean -fd

      # 7) é¢„æ£€ï¼šdefconfig ä¸ Patchs æ˜¯å¦å­˜åœ¨
      - name: Preflight checks (defconfig & Patchs)
        working-directory: kernel-src
        run: |
          set -e
          if [[ ! -f "arch/arm64/configs/${TARGET_DEVICE}_defconfig" ]]; then
            echo "::error::æœªæ‰¾åˆ° defconfig: arch/arm64/configs/${TARGET_DEVICE}_defconfig"
            ls arch/arm64/configs/*_defconfig || true
            exit 1
          fi
          if [[ ! -d "Patchs" ]]; then
            echo "::error::æœªæ‰¾åˆ° Patchs/ ç›®å½•ï¼ˆåº”ä½äºä»“åº“æ ¹è·¯å¾„ï¼‰"
            exit 1
          fi

      # 8) å®‰è£… LXC è¡¥ä¸ï¼ˆå®Œå…¨æŒ‰åŸæ¥çš„å±•å¼€é€»è¾‘ï¼‰
      - name: Apply LXC patches (enable Docker, qtaguid, runcpatch)
        working-directory: kernel-src
        run: |
          set -e
          echo "ğŸ”§ æ­£åœ¨ä¸ºå†…æ ¸å®‰è£… LXC è¡¥ä¸..."
          rm -rf utils && unzip -o Patchs/LXC_utils.zip -d utils
          if ! grep -q 'source "utils/Kconfig"' Kconfig; then
            echo 'source "utils/Kconfig"' >> Kconfig
          fi
          # æ‰“å¼€è‡ªå®šä¹‰ Kconfig é¡¹ä»¥å¯ç”¨ LXC/Docker æ”¯æŒ
          if ! grep -q '^CONFIG_DOCKER=y' arch/arm64/configs/${TARGET_DEVICE}_defconfig; then
            echo "CONFIG_DOCKER=y" >> arch/arm64/configs/${TARGET_DEVICE}_defconfig
          fi
          # å…³é—­ ANDROID_PARANOID_NETWORK
          sed -i '/CONFIG_ANDROID_PARANOID_NETWORK/d' arch/arm64/configs/${TARGET_DEVICE}_defconfig
          echo "# CONFIG_ANDROID_PARANOID_NETWORK is not set" >> arch/arm64/configs/${TARGET_DEVICE}_defconfig

          chmod +x utils/runcpatch.sh
          if [[ -f kernel/cgroup/cgroup.c ]]; then
            sh utils/runcpatch.sh kernel/cgroup/cgroup.c
          fi
          if [[ -f kernel/cgroup.c ]]; then
            sh utils/runcpatch.sh kernel/cgroup.c
          fi
          if [[ -f net/netfilter/xt_qtaguid.c && -f utils/xt_qtaguid.patch ]]; then
            patch -p0 < utils/xt_qtaguid.patch || true
          fi
          echo "âœ… LXC è¡¥ä¸å®‰è£…å®Œæˆï¼"

      # 9) åˆå§‹åŒ–æ‰“åŒ…ç›®å½• & AnyKernel3ï¼ˆkona åˆ†æ”¯ï¼‰
      - name: Prepare AnyKernel3
        working-directory: kernel-src
        run: |
          rm -rf out/ anykernel/
          echo "Clone AnyKernel3 (kona)..."
          git clone https://github.com/liyafe1997/AnyKernel3 -b kona --single-branch --depth=1 anykernel

      # 10) åœ¨ defconfig ä¸­è¿½åŠ æ—¥æœŸä¸ commit idï¼ˆä¿ç•™åŸè„šæœ¬è¡Œä¸ºï¼‰
      - name: Stamp local version in defconfig
        working-directory: kernel-src
        run: |
          set -e
          GIT_COMMIT_ID="$(git rev-parse --short=8 HEAD)"
          local_version_str="-perf"
          local_version_date_str="-$(date +%Y%m%d)-${GIT_COMMIT_ID}-perf"
          sed -i "s/${local_version_str}/${local_version_date_str}/g" arch/arm64/configs/${TARGET_DEVICE}_defconfig

      # 11) ç”Ÿæˆ defconfigï¼ˆåˆ° out/.configï¼‰
      - name: make defconfig
        working-directory: kernel-src
        run: |
          make ${MAKE_ARGS} ${TARGET_DEVICE}_defconfig

      # 12) åº”ç”¨â€œåŸºæœ¬ä¼˜åŒ–é…ç½®â€ï¼ˆscripts/configï¼‰
      - name: Apply optimized configurations via scripts/config
        working-directory: kernel-src
        run: |
          set -e
          scripts/config --file out/.config \
            -e KALLSYMS -e KALLSYMS_ALL -e KPROBES -e HAVE_KPROBES -e KPROBE_EVENTS \
            -e TMPFS_XATTR=y -e TMPFS_POSIX_ACL \
            -e IP_NF_TARGET_TTL -e IP6_NF_TARGET_HL -e IP6_NF_MATCH_HL \
            -e UCLAMP_TASK \
            -e TCP_CONG_ADVANCED -e TCP_CONG_BIC -e TCP_CONG_CUBIC -e TCP_CONG_WESTWOOD -e TCP_CONG_HTCP \
            -e TCP_CONG_HSTCP -e TCP_CONG_HYBLA -e TCP_CONG_VEGAS -e TCP_CONG_NV -e TCP_CONG_SCALABLE \
            -e TCP_CONG_LP -e TCP_CONG_VENO -e TCP_CONG_YEAH -e TCP_CONG_ILLINOIS -e TCP_CONG_DCTCP \
            -e TCP_CONG_CDG -e TCP_CONG_BBR -e DEFAULT_BBR \
            -e NET_SCHED -e NET_SCH_HTB -e NET_SCH_HFSC -e NET_SCH_PRIO -e NET_SCH_MULTIQ -e NET_SCH_RED \
            -e NET_SCH_SFB -e NET_SCH_SFQ -e NET_SCH_TEQL -e NET_SCH_TBF -e NET_SCH_CBS -e NET_SCH_ETF \
            -e NET_SCH_TAPRIO -e NET_SCH_GRED -e NET_SCH_NETEM -e NET_SCH_DRR -e NET_SCH_MQPRIO \
            -e NET_SCH_SKBPRIO -e NET_SCH_CHOKE -e NET_SCH_QFQ -e NET_SCH_CODEL -e NET_SCH_FQ_CODEL \
            -e NET_SCH_CAKE -e NET_SCH_FQ -e NET_SCH_HHF -e NET_SCH_PIE -e NET_SCH_FQ_PIE \
            -e NET_SCH_INGRESS -e NET_SCH_PLUG -e NET_SCH_ETS -e NET_SCH_FIFO -e NET_SCH_DEFAULT -e DEFAULT_FQ \
            -e MQ_IOSCHED_DEADLINE -e MQ_IOSCHED_KYBER -e IOSCHED_BFQ -e BFQ_GROUP_IOSCHED \
            -e ENERGY_MODEL -e CPU_IDLE -e CPU_IDLE_GOV_MENU -e CPU_IDLE_GOV_TEO -e ARM_PSCI_CPUIDLE \
            -e CPU_FREQ -e CPU_FREQ_STAT -e CPU_FREQ_TIMES -e CPU_FREQ_GOV_POWERSAVE -e CPU_FREQ_GOV_CONSERVATIVE \
            -e CPU_FREQ_GOV_USERSPACE -e CPU_FREQ_GOV_ONDEMAND \
            -e ZRAM -e ZSMALLOC -e ZRAM_WRITEBACK \
            -e CRYPTO_LZ4 -e CRYPTO_LZ4HC -e CRYPTO_LZ4K -e CRYPTO_LZ4KD -e CRYPTO_ZSTD -e CRYPTO_842 \
            -e CRYPTO_LZO -e CRYPTO_DEFLATE -e ZRAM_DEF_COMP_LZ4KD \
            -e SWAP -e ZSWAP \
            -e ANDROID_SIMPLE_LMK \
            -e CPU_FREQ_GOV_SCHEDHORIZON -e CPU_FREQ_DEFAULT_GOV_SCHEDHORIZON \
            --set-val LITTLE_CPU_MASK 15 \
            --set-val BIG_CPU_MASK 112 \
            --set-val PRIME_CPU_MASK 128 \
            -e LRU_GEN -e LRU_GEN_ENABLED \
            -e NTFS_FS -e NTFS_RW -e EXFAT_FS \
            -e EROFS_FS -e EROFS_FS_XATTR -e EROFS_FS_ZIP \
            -d ANDROID_PARANOID_NETWORK \
            -e PSTORE_LAST_KMSG

      # 12.5) ä½¿ç”¨ Moby çš„ check-config.sh å¯¹ out/.config åšå®Œæ•´ Docker/LXC å…¼å®¹æ€§æ£€æŸ¥
      - name: Verify Docker/LXC requirements via moby check-config.sh
        working-directory: kernel-src
        run: |
          set -e
          echo "ğŸ” Fetching moby check-config.sh ..."
          curl -fsSL https://raw.githubusercontent.com/moby/moby/master/contrib/check-config.sh -o /tmp/check-config.sh
          chmod +x /tmp/check-config.sh
          echo "ğŸ” Running check-config.sh against out/.config ..."
          /tmp/check-config.sh out/.config

      # 13) ç¼–è¯‘
      - name: Build kernel
        working-directory: kernel-src
        run: |
          set -e
          make ${MAKE_ARGS} -j$(nproc)
          if [[ ! -f "out/arch/arm64/boot/Image" ]]; then
            echo "::error::ç¼–è¯‘å¤±è´¥ï¼Œæœªç”Ÿæˆ out/arch/arm64/boot/Image"
            exit 1
          fi
          echo "âœ… Build OK: out/arch/arm64/boot/Image"

      # 14) ç”Ÿæˆèšåˆ dtb
      - name: Generate dtb (concatenate *.dtb)
        working-directory: kernel-src
        run: |
          set -e
          echo "Generating [out/arch/arm64/boot/dtb] ..."
          find out/arch/arm64/boot/dts -name '*.dtb' -exec cat {} + > out/arch/arm64/boot/dtb

      # 15) æ‹·è´åˆ° AnyKernel3 å¹¶æ‰“åŒ…
      - name: Pack AnyKernel3 zip
        working-directory: kernel-src
        run: |
          set -e
          rm -rf anykernel/kernels/ && mkdir -p anykernel/kernels/
          cp out/arch/arm64/boot/Image anykernel/kernels/
          cp out/arch/arm64/boot/dtb anykernel/kernels/
          GIT_COMMIT_ID="$(git rev-parse --short=8 HEAD)"
          ZIP_FILENAME="Kernel_AOSP_${TARGET_DEVICE}_NoKernelSU_$(date +'%Y%m%d_%H%M%S')_anykernel3_${GIT_COMMIT_ID}.zip"
          (cd anykernel && zip -r9 "${ZIP_FILENAME}" ./* -x .git .gitignore out/ ./*.zip)
          mv anykernel/${ZIP_FILENAME} .
          echo "Done. The flashable zip is: ./${ZIP_FILENAME}"

      # 16) æ¢å¤ defconfig çš„ local version å­—ç¬¦ä¸²ï¼ˆä¿æŒä¸åŸè„šæœ¬ä¸€è‡´ï¼‰
      - name: Restore defconfig local version string
        working-directory: kernel-src
        run: |
          git restore --source=HEAD -- arch/arm64/configs/${TARGET_DEVICE}_defconfig || true

      # 17) ä¸Šä¼ åˆ¶å“
      - name: Upload artifacts (zip, Image, dtb)
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ replace(inputs.kernel_repo, '/', '-') }}-${{ inputs.kernel_branch || 'default' }}-lmi-aosp-${{ github.run_id }}
          path: |
            kernel-src/*.zip
            kernel-src/anykernel/kernels/Image
            kernel-src/anykernel/kernels/dtb
            kernel-src/out/arch/arm64/boot/Image
            kernel-src/out/arch/arm64/boot/dts/**/*.dtb
          if-no-files-found: warn
