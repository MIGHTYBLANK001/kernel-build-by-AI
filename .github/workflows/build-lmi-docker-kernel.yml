name: Build Kernel (AOSP/crDroid) → AnyKernel3 (store-only) → Release

on:
  workflow_dispatch:
    inputs:
      defconfig:
        description: "内核 defconfig（例如 vendor/mydevice_defconfig）"
        required: true
      branch:
        description: "ROM/AOSP 分支（例如 crdroid-15.x；用于包名/tag）"
        required: true
  push:
    branches:
      - "*"

permissions:
  contents: write

env:
  ARCH: arm64
  SUBARCH: arm64
  THREADS_DEFAULT: 8
  # 固定 Proton-Clang 版本（可按需升级）
  CLANG_URL: https://github.com/kdrag0n/proton-clang/archive/refs/tags/20210522.tar.gz
  CLANG_DIR: toolchains/proton-clang
  ANYKERNEL3_REPO: https://github.com/osm0sis/AnyKernel3.git

jobs:
  build-package-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---- 安装依赖（必须在任何构建/脚本之前） ----
      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            coreutils util-linux \
            bc bison flex libssl-dev \
            libelf-dev dwarves pkg-config zstd \
            zip unzip python3 rsync ccache

      # ---- 获取 Proton-Clang 并加入 PATH ----
      - name: Fetch Proton-Clang (20210522) & setup PATH
        run: |
          mkdir -p "${CLANG_DIR}"
          curl -L "${CLANG_URL}" | tar -xz --strip-components=1 -C "${CLANG_DIR}"
          echo "${PWD}/${CLANG_DIR}/bin" >> "$GITHUB_PATH"

      # ---- 导出环境变量（遵循 Proton-Clang README 建议） ----
      - name: Export env for LLVM/Clang build
        run: |
          {
            echo "ARCH=${ARCH}"
            echo "SUBARCH=${SUBARCH}"
            echo "CC=clang"
            echo "LD=ld.lld"
            echo "LLVM=1"
            echo "CROSS_COMPILE=aarch64-linux-gnu-"
            echo "CROSS_COMPILE_ARM32=arm-linux-gnueabi-"
          } >> "$GITHUB_ENV"

      # ---- 清理 & defconfig ----
      - name: Kernel clean
        run: |
          make O=out ARCH=${ARCH} clean || true
          make O=out ARCH=${ARCH} mrproper || true

      - name: Kernel defconfig
        run: |
          DEFCONFIG="${{ github.event.inputs.defconfig }}"
          if [ -z "${DEFCONFIG}" ]; then
            echo "No defconfig provided via workflow_dispatch; please set inputs.defconfig"
            exit 1
          fi
          make O=out ARCH=${ARCH} \
            CC=${CC} LD=${LD} LLVM=${LLVM} \
            CROSS_COMPILE=${CROSS_COMPILE} \
            CROSS_COMPILE_ARM32=${CROSS_COMPILE_ARM32} \
            "${DEFCONFIG}"

      # ---- 构建内核 ----
      - name: Build kernel
        run: |
          JOBS="$(getconf _NPROCESSORS_ONLN 2>/dev/null || echo ${THREADS_DEFAULT})"
          make -j"${JOBS}" O=out ARCH=${ARCH} \
            CC=${CC} LD=${LD} LLVM=${LLVM} \
            CROSS_COMPILE=${CROSS_COMPILE} \
            CROSS_COMPILE_ARM32=${CROSS_COMPILE_ARM32}

      # ---- 查找生成的镜像（支持多常见命名）----
      - name: Locate built image
        id: findimg
        run: |
          set -e
          CANDIDATES=(
            "out/arch/arm64/boot/Image"
            "out/arch/arm64/boot/Image.gz"
            "out/arch/arm64/boot/Image.gz-dtb"
            "out/arch/arm64/boot/Image-dtb"
            "arch/arm64/boot/Image"
            "arch/arm64/boot/Image.gz"
            "arch/arm64/boot/Image.gz-dtb"
          )
          for f in "${CANDIDATES[@]}"; do
            if [ -f "$f" ]; then
              echo "image=$f" >> "$GITHUB_OUTPUT"
              echo "Found image: $f"
              exit 0
            fi
          done
          echo "::error::未找到内核镜像（Image*/Image.gz*/Image.gz-dtb 等）。请检查构建产物与 defconfig。"
          exit 1

      # ---- 获取 AnyKernel3 模板并调整 ----
      - name: Clone AnyKernel3
        run: |
          git clone --depth=1 "${ANYKERNEL3_REPO}" ak3
          # 关闭设备检查以适配通用 AOSP/crDroid；如需开启，后续可按机型改写
          sed -i "s/^do.devicecheck=.*/do.devicecheck=0/" ak3/anykernel.sh
          # 显示字符串（便于区分构建来源）
          BRANCH="${{ github.event.inputs.branch || github.ref_name }}"
          sed -i "s/^kernel.string=.*/kernel.string=${BRANCH} $(date +%Y-%m-%d)/" ak3/anykernel.sh

      # ---- 将镜像放在包根目录 & 可选复制模块 ----
      - name: Prepare AK3 payload (image at zip root)
        run: |
          cp "${{ steps.findimg.outputs.image }}" ak3/
          # 若存在内核模块，按 AK3 约定放入 modules 目录（可选）
          if [ -d "out/lib/modules" ]; then
            rsync -a out/lib/modules/ ak3/modules/system/lib/modules/
          fi

      # ---- 以 store-only 方式打包（不压缩）----
      - name: Make flashable zip (zip -0 store-only)
        id: mkzip
        run: |
          BRANCH="${{ github.event.inputs.branch || github.ref_name }}"
          TS="$(date +%Y%m%d-%H%M%S)"
          PKG="${BRANCH}-${TS}"
          (cd ak3 && zip -0 -r "../${PKG}.zip" .)
          echo "pkg=${PKG}" >> "$GITHUB_OUTPUT"
          ls -lh "${PKG}.zip"

      # ---- 发布到 GitHub Release（tag=branch+timestamp）----
      - name: Create Release & Upload asset
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.mkzip.outputs.pkg }}
          name: ${{ steps.mkzip.outputs.pkg }}
          body: |
            ROM: AOSP / crDroid
            Branch: ${{ github.event.inputs.branch || github.ref_name }}
            Package: ${{ steps.mkzip.outputs.pkg }}.zip
            Image placed at zip root; packaged with AnyKernel3 (store-only).
            Built & packaged by GitHub Actions.
          artifacts: ${{ steps.mkzip.outputs.pkg }}.zip
          allowUpdates: true
