name: Build Docker-ready (minimal) Android kernel for lmi with AK3 - v4.1.3

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: "Kernel repo URL"
        required: true
        default: "https://github.com/liyafe1997/kernel_xiaomi_sm8250_mod"
      branch:
        description: "Kernel branch"
        required: true
        default: "android15-lineage22-mod"
      device:
        description: "Device codename (AK3 device check)"
        required: true
        default: "lmi"
      release_tag:
        description: "Release tag (auto if empty)"
        required: false
        default: ""

permissions:
  contents: write

concurrency:
  group: docker-min-android-kernel-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
      SUBARCH: arm64
      OUT: out
      CC: clang
      LD: ld.lld
      LLVM: -15
      KBUILD_BUILD_USER: "gh-actions"
      KBUILD_BUILD_HOST: "ubuntu"
      TZ: "Asia/Shanghai"

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Clone kernel source
        run: |
          set -e
          git clone --depth=1 -b "${{ inputs.branch }}" "${{ inputs.repo_url }}" kernel_src
          cd kernel_src
          git rev-parse --short HEAD

      - name: Install build deps (clang/llvm/binutils)
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y \
            bc bison flex \
            libssl-dev libelf-dev dwarves \
            git curl wget zip unzip \
            python3 python3-pip \
            build-essential \
            clang-15 llvm-15 lld-15 \
            llvm-15-tools \
            binutils-aarch64-linux-gnu \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          sudo ln -sf /usr/bin/clang-15 /usr/bin/clang
          sudo ln -sf /usr/bin/ld.lld-15 /usr/bin/ld.lld
          sudo ln -sf /usr/bin/llvm-objdump-15 /usr/bin/llvm-objdump
          sudo ln -sf /usr/bin/llvm-objcopy-15 /usr/bin/llvm-objcopy
          sudo ln -sf /usr/bin/llvm-ar-15 /usr/bin/llvm-ar
          sudo ln -sf /usr/bin/llvm-nm-15 /usr/bin/llvm-nm

      - name: Verify LLVM toolchain presence
        run: |
          set -e
          for t in clang-15 ld.lld-15 llvm-objdump-15 llvm-objcopy-15 llvm-ar-15 llvm-nm-15; do
            which $t && $t --version || true
          done
          for t in clang ld.lld llvm-objdump llvm-objcopy llvm-ar llvm-nm; do
            which $t && $t --version || true
          done

      ########################################################################
      # DEFCONFIG — use exact defconfig (no global config rewrites)
      ########################################################################
      - name: Validate defconfig exists
        working-directory: kernel_src
        run: |
          set -e
          DEF="arch/arm64/configs/${{ inputs.defconfig_name }}"
          echo "[INFO] Required defconfig: $DEF"
          if [ ! -f "$DEF" ]; then
            echo "[ERROR] $DEF not found. Abort."
            exit 1
          fi
          echo "$DEF" > ../DEFCONFIG_PATH.txt

      - name: Prepare .config from defconfig (NO localversion changes)
        working-directory: kernel_src
        run: |
          set -e
          DEFCONFIG_PATH="$(cat ../DEFCONFIG_PATH.txt)"
          mkdir -p ${OUT}
          export ARCH=arm64
          export SUBARCH=arm64
          export CC=clang
          export LD=ld.lld
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CLANG_TRIPLE=aarch64-linux-gnu-
          make LLVM=${LLVM} O=${OUT} ARCH=${ARCH} $(basename "$DEFCONFIG_PATH")
          make LLVM=${LLVM} O=${OUT} ARCH=${ARCH} scripts

      ########################################################################
      # MINIMAL DOCKER CONFIGS — ONLY Generally Necessary (keep ABI stable)
      ########################################################################
      - name: Enable minimal Docker-required configs (Generally Necessary only)
        working-directory: kernel_src
        run: |
          set -e
          CFG="${OUT}/.config"
          SC="./scripts/config"

          enable_y () { ${SC} --file "${CFG}" --enable "$1" || true; }
          enable_m () { ${SC} --file "${CFG}" --module "$1" || true; }

          # Namespaces
          for K in NAMESPACES NET_NS PID_NS IPC_NS UTS_NS; do enable_y CONFIG_${K}; done

          # cgroups
          for K in CGROUPS CGROUP_DEVICE CPUSETS CGROUP_CPUACCT MEMCG CGROUP_FREEZER CGROUP_SCHED; do
            enable_y CONFIG_${K}
          done

          # 网络 & netfilter：IPv4/IPv6，基础 NAT/连接跟踪
          enable_y CONFIG_VETH
          enable_y CONFIG_BRIDGE
          enable_y CONFIG_BRIDGE_NETFILTER
          enable_y CONFIG_NETFILTER
          enable_y CONFIG_NETFILTER_XTABLES
          enable_y CONFIG_NF_CONNTRACK
          enable_y CONFIG_NF_NAT

          # IPv4
          enable_y CONFIG_IP_NF_FILTER
          enable_y CONFIG_IP_NF_MANGLE
          enable_y CONFIG_IP_NF_RAW
          enable_y CONFIG_IP_NF_TARGET_MASQUERADE

          # IPv6
          enable_y CONFIG_IP6_NF_FILTER
          enable_y CONFIG_IP6_NF_MANGLE
          enable_y CONFIG_IP6_NF_RAW
          enable_y CONFIG_IP6_NF_NAT
          enable_y CONFIG_IP6_NF_TARGET_MASQUERADE

          # xtables 关键匹配
          enable_y CONFIG_NETFILTER_XT_MATCH_ADDRTYPE
          enable_y CONFIG_NETFILTER_XT_MATCH_CONNTRACK

          # IPC 必要
          enable_y CONFIG_POSIX_MQUEUE

          # 生成最终 .config（不改 localversion / 不触碰模块 ABI）
          make LLVM=${LLVM} O=${OUT} ARCH=arm64 olddefconfig

          echo "[INFO] Minimal Docker configs enabled:"
          egrep -i 'CONFIG_(NAMESPACES|NET_NS|PID_NS|IPC_NS|UTS_NS|CGROUP|VETH|BRIDGE|NETFILTER|XT_|NF_CONNTRACK|NF_NAT|IP_NF_|IP6_NF_|POSIX_MQUEUE)' ${OUT}/.config | sort || true

      - name: Validate with Moby check-config.sh (informational)
        working-directory: kernel_src
        run: |
          set -e
          wget -O /tmp/check-config.sh https://raw.githubusercontent.com/moby/moby/master/contrib/check-config.sh
          chmod +x /tmp/check-config.sh
          /tmp/check-config.sh ${OUT}/.config || true

      ########################################################################
      # BUILD — kernel (plain Image)
      ########################################################################
      - name: Build kernel (plain Image)
        working-directory: kernel_src
        run: |
          set -e
          export ARCH=arm64
          export SUBARCH=arm64
          export CC=clang
          export LD=ld.lld
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CLANG_TRIPLE=aarch64-linux-gnu-
          make LLVM=${LLVM} O=${OUT} -j$(nproc)
          ls -la ${OUT}/arch/arm64/boot || true
          test -f ${OUT}/arch/arm64/boot/Image

      ########################################################################
      # PACKAGE — AnyKernel3 flashable zip (Image注入boot；不触ramdisk/dtbo)
      ########################################################################
      - name: Prepare AnyKernel3 template
        run: |
          set -e
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AK3
          cat > AK3/anykernel.sh <<'EOF'
          #!/bin/sh
          # AnyKernel3 by osm0sis @ xda-developers (adapted for lmi)
          properties() {
            kernel.string=Kernel (Docker-minimal) for lmi @ GitHub Actions
            do.devicecheck=1
            do.modules=0
            do.systemless=0
            do.cleanup=1
            do.cleanuponabort=1
            device.name1=lmi
            device.name2=umi
            device.name3=cmi
            is_slot_device=1
            block=/dev/block/bootdevice/by-name/boot
            ramdisk_compression=auto
          }
          . tools/ak3-core.sh
          install() {
            ui_print "  ==> AnyKernel3 start (lmi minimal)"
            split_boot
            if [ ! -f "$ZIPFILEDIR/Image" ]; then
              abort "Image not found in zip root"
            fi
            cp -f "$ZIPFILEDIR/Image" kernel || abort "Copy kernel failed"
            ui_print "  -> Repacking and flashing boot..."
            flash_boot || abort "flash_boot failed"
            ui_print "  ==> AnyKernel3 done"
          }
          EOF
          chmod +x AK3/anykernel.sh

      - name: Copy kernel Image into AK3 root
        run: |
          set -e
          cp -f kernel_src/out/arch/arm64/boot/Image AK3/Image

      - name: Make flashable zip (AK3)
        run: |
          set -e
          cd AK3
          zip -r9 ../lmi-kernel-ak3-min-v4.1.3.zip ./*

      ########################################################################
      # ARTIFACTS & RELEASE
      ########################################################################
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lmi-kernel-android-ak3-min-v4.1.3
          path: |
            kernel_src/out/arch/arm64/boot/Image
            kernel_src/out/.config
            lmi-kernel-ak3-min-v4.1.3.zip

      - name: Prepare Release metadata
        id: meta
        run: |
          set -e
          DATE=$(date +'%Y%m%d')
          if [ -z "${{ inputs.release_tag }}" ]; then
            TAG="lmi-kernel-android-ak3-min-${{ inputs.branch }}-${DATE}-v4.1.3"
          else
            TAG="${{ inputs.release_tag }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "name=Docker-minimal Android kernel (AK3) for lmi (${TAG})" >> $GITHUB_OUTPUT
          echo "body=\
          ## Docker-minimal Android kernel for lmi — v4.1.3\\n\
          - Repo: ${{ inputs.repo_url }}\\n\
          - Branch: ${{ inputs.branch }}\\n\
          - Defconfig: arch/arm64/configs/${{ inputs.defconfig_name }}\\n\
          - Minimal Docker configs: namespaces/cgroups/veth/bridge/netfilter/conntrack/nat/masquerade/xt-addrtype/xt-conntrack/posix_mqueue\\n\
          - Packaging: AnyKernel3 flashable zip (plain Image; inject into boot; keep ramdisk/cmdline)\\n\
          - Notes: Keep ABI stable (no localversion changes; no module ABI toggles)\\n\
          " >> $GITHUB_OUTPUT

      - name: Create Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.name }}
          body: ${{ steps.meta.outputs.body }}
          draft: false
          prerelease: false
          files: |
            kernel_src/out/arch/arm64/boot/Image
            kernel_src/out/.config
            lmi-kernel-ak3-min-v4.1.3.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
