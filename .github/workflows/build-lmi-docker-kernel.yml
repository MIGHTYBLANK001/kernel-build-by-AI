name: Build Docker+Android kernel (SM8250/lmi) with AnyKernel3 - v4.1

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: "Kernel repo URL"
        required: true
        default: "https://github.com/liyafe1997/kernel_xiaomi_sm8250_mod"
      branch:
        description: "Kernel branch"
        required: true
        default: "android15-lineage22-mod"
      device:
        description: "Device codename"
        required: true
        default: "lmi"
      release_tag:
        description: "Release tag (auto if empty)"
        required: false
        default: ""
      android_compat:
        description: "Enable Android compatibility profile (SELinux/VendorHooks/modules/FUSE etc.)"
        required: true
        default: "true"

permissions:
  contents: write

concurrency:
  group: docker-android-kernel-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
      SUBARCH: arm64
      OUT: out
      CC: clang
      LD: ld.lld
      LLVM: -15
      KBUILD_BUILD_USER: "gh-actions"
      KBUILD_BUILD_HOST: "ubuntu"
      TZ: "Asia/Shanghai"

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Clone kernel source
        run: |
          set -e
          git clone --depth=1 -b "${{ inputs.branch }}" "${{ inputs.repo_url }}" kernel_src
          cd kernel_src
          git rev-parse --short HEAD

      - name: Install build deps (clang/llvm/binutils)
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y \
            bc bison flex \
            libssl-dev libelf-dev dwarves \
            git curl wget zip unzip \
            python3 python3-pip \
            build-essential \
            clang-15 llvm-15 lld-15 \
            llvm-15-tools \
            binutils-aarch64-linux-gnu \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          # unsuffixed symlinks for CC/LD; other llvm-* use LLVM=-15
          sudo ln -sf /usr/bin/clang-15 /usr/bin/clang
          sudo ln -sf /usr/bin/ld.lld-15 /usr/bin/ld.lld
          sudo ln -sf /usr/bin/llvm-objdump-15 /usr/bin/llvm-objdump
          sudo ln -sf /usr/bin/llvm-objcopy-15 /usr/bin/llvm-objcopy
          sudo ln -sf /usr/bin/llvm-ar-15 /usr/bin/llvm-ar
          sudo ln -sf /usr/bin/llvm-nm-15 /usr/bin/llvm-nm

      - name: Verify LLVM toolchain presence
        run: |
          set -e
          for t in clang-15 ld.lld-15 llvm-objdump-15 llvm-objcopy-15 llvm-ar-15 llvm-nm-15; do
            which $t && $t --version || true
          done
          for t in clang ld.lld llvm-objdump llvm-objcopy llvm-ar llvm-nm; do
            which $t && $t --version || true
          done

      ########################################################################
      # PATCHES — apply BEFORE configuration & build
      ########################################################################
      - name: Apply REQUIRED cgroup.patch (must succeed)
        working-directory: kernel_src
        run: |
          set -e
          URL="https://raw.githubusercontent.com/MIGHTYBLANK001/kernel-build-by-AI/refs/heads/main/patch/cgroup.patch"
          echo "[INFO] Fetch: $URL"
          curl -L -o /tmp/cgroup.patch "$URL"
          if ! git apply --reject --verbose /tmp/cgroup.patch; then
            echo "[WARN] git apply failed; trying patch -p0/-p1"
            patch -p0 < /tmp/cgroup.patch || patch -p1 < /tmp/cgroup.patch
          fi
          echo "[INFO] cgroup.patch applied successfully."

      - name: Conditionally apply xt_qtaguid.patch (only if module/config present)
        working-directory: kernel_src
        run: |
          set -e
          URL="https://raw.githubusercontent.com/MIGHTYBLANK001/kernel-build-by-AI/refs/heads/main/patch/xt_qtaguid.patch"
          echo "[INFO] Fetch: $URL"
          curl -L -o /tmp/xt_qtaguid.patch "$URL"
          TARGET_FILE=""
          for cand in \
            net/netfilter/xt_qtaguid.c \
            kernel/net/netfilter/xt_qtaguid.c \
            net/netfilter/xt_qtaguid/xt_qtaguid.c \
            kernel/net/netfilter/xt_qtaguid/xt_qtaguid.c ; do
            if [ -f "$cand" ]; then TARGET_FILE="$cand"; break; fi
          done
          HAS_CFG=$(grep -Rsn "CONFIG_NETFILTER_XT_MATCH_QTAGUID" . || true)
          if [ -n "$TARGET_FILE" ] && [ -n "$HAS_CFG" ]; then
            echo "[INFO] xt_qtaguid detected; applying patch."
            if ! git apply --reject --verbose /tmp/xt_qtaguid.patch; then
              echo "[WARN] git apply failed; trying patch -p0/-p1 (non-fatal)"
              patch -p0 < /tmp/xt_qtaguid.patch || patch -p1 < /tmp/xt_qtaguid.patch || echo "[WARN] xt_qtaguid patch failed; continue."
            fi
          else
            echo "[INFO] xt_qtaguid not present; skip patch."
          fi

      ########################################################################
      # CONFIGURATION — defconfig + force-enable Docker & Android compat
      ########################################################################
      - name: Select and validate defconfig (prefer ${device}_defconfig; fallback to lmi_defconfig)
        working-directory: kernel_src
        run: |
          set -e
          DEFCONFIG_CAND="arch/arm64/configs/${{ inputs.device }}_defconfig"
          FALLBACK_DEFCONFIG="arch/arm64/configs/lmi_defconfig"

          echo "[INFO] Preferred defconfig: $DEFCONFIG_CAND"
          if [ -f "$DEFCONFIG_CAND" ]; then
            echo "[INFO] Using device defconfig: $DEFCONFIG_CAND"
            echo "$DEFCONFIG_CAND" > ../DEFCONFIG_PATH.txt
          else
            echo "[WARN] $DEFCONFIG_CAND not found; fallback to $FALLBACK_DEFCONFIG"
            if [ ! -f "$FALLBACK_DEFCONFIG" ]; then
              echo "[ERROR] Fallback defconfig ($FALLBACK_DEFCONFIG) not found. Abort."
              exit 1
            fi
            echo "$FALLBACK_DEFCONFIG" > ../DEFCONFIG_PATH.txt
          fi

      - name: Prepare .config from selected defconfig
        working-directory: kernel_src
        run: |
          set -e
          DEFCONFIG_PATH="$(cat ../DEFCONFIG_PATH.txt)"
          echo "[INFO] Final defconfig path: $DEFCONFIG_PATH"

          mkdir -p ${OUT}
          export ARCH=arm64
          export SUBARCH=arm64
          export CC=clang
          export LD=ld.lld
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CLANG_TRIPLE=aarch64-linux-gnu-
          # 通过明确路径调用 defconfig，确保使用指定机型配置
          make LLVM=${LLVM} O=${OUT} ARCH=${ARCH} $(basename "$DEFCONFIG_PATH")
          make LLVM=${LLVM} O=${OUT} ARCH=${ARCH} scripts

      - name: Force-enable Docker configs + Android-compat profile
        working-directory: kernel_src
        run: |
          set -e
          export ARCH=arm64
          export SUBARCH=arm64
          export CC=clang
          export LD=ld.lld
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CLANG_TRIPLE=aarch64-linux-gnu-
          CFG="${OUT}/.config"
          SC="./scripts/config"
          enable_y () { ${SC} --file "${CFG}" --enable "$1" || true; }
          enable_m () { ${SC} --file "${CFG}" --module "$1" || true; }
          set_str () { ${SC} --file "${CFG}" --set-str "$1" "$2" || true; }

          # /proc/config.gz embedding + localversion
          enable_y CONFIG_IKCONFIG
          enable_y CONFIG_IKCONFIG_PROC
          set_str CONFIG_LOCALVERSION "-docker-android"

          # Namespaces & cgroups (Docker)
          for K in NAMESPACES UTS_NS IPC_NS PID_NS NET_NS USER_NS; do enable_y CONFIG_${K}; done
          for K in CGROUPS CGROUP_DEVICE CPUSETS CGROUP_CPUACCT BLK_CGROUP MEMCG CGROUP_PIDS CGROUP_FREEZER CGROUP_SCHED CGROUP_WRITEBACK CGROUP_PERF CGROUP_HUGETLB CGROUP_BPF; do
            enable_y CONFIG_${K}
          done
          enable_y CONFIG_CFS_BANDWIDTH
          enable_y CONFIG_FAIR_GROUP_SCHED
          enable_y CONFIG_BLK_DEV_THROTTLING
          enable_y CONFIG_NET_CLS_CGROUP
          enable_y CONFIG_CGROUP_NET_PRIO

          # eBPF / XDP
          for K in BPF BPF_SYSCALL BPF_JIT HAVE_EBPF_JIT NET_CLS_BPF NET_ACT_BPF BPFILTER XDP_SOCKETS; do enable_y CONFIG_${K}; done

          # overlayfs
          enable_y CONFIG_OVERLAY_FS

          # Netfilter / iptables (IPv4/IPv6) + xt matches
          for K in VETH BRIDGE BRIDGE_NETFILTER NETFILTER NETFILTER_XTABLES \
                   NF_CONNTRACK NF_NAT \
                   IP_NF_IPTABLES IP_NF_FILTER IP_NF_MANGLE IP_NF_RAW IP_NF_SECURITY IP_NF_TARGET_MASQUERADE \
                   IP6_NF_FILTER IP6_NF_MANGLE IP6_NF_RAW IP6_NF_NAT IP6_NF_TARGET_MASQUERADE; do
            enable_y CONFIG_${K}
          done
          enable_y CONFIG_NETFILTER_XT_MATCH_ADDRTYPE
          enable_y CONFIG_NETFILTER_XT_MATCH_CONNTRACK
          enable_y CONFIG_NETFILTER_XT_MATCH_IPVS
          enable_y CONFIG_NETFILTER_XT_MARK
          enable_y CONFIG_IP_NF_TARGET_REDIRECT

          # ipset 家族
          enable_m CONFIG_IP_SET
          enable_m CONFIG_IP_SET_HASH_NET
          enable_m CONFIG_NETFILTER_XT_SET

          # nftables 家族（包含 FIB）
          for K in NF_TABLES NFT_CT NFT_MASQ NFT_NAT NFT_FIB NFT_FIB_IPV4 NFT_FIB_IPV6; do
            enable_y CONFIG_${K}
          done

          # IPVS
          for K in IP_VS IP_VS_NFCT IP_VS_PROTO_TCP IP_VS_PROTO_UDP IP_VS_RR; do enable_y CONFIG_${K}; done

          # 网络驱动（overlay/macvlan/ipvlan/VLAN）
          enable_y CONFIG_VXLAN
          enable_y CONFIG_BRIDGE_VLAN_FILTERING
          enable_y CONFIG_IPVLAN
          enable_y CONFIG_MACVLAN
          enable_y CONFIG_DUMMY

          # POSIX 消息队列
          enable_y CONFIG_POSIX_MQUEUE

          # 存储（可选）：btrfs 模块
          enable_m CONFIG_BTRFS_FS
          enable_y CONFIG_BTRFS_FS_POSIX_ACL

          # === Android-compat profile ===
          if [ "${{ inputs.android_compat }}" = "true" ]; then
            # SELinux & Audit（Android 必需）
            enable_y CONFIG_SECURITY_SELINUX
            enable_y CONFIG_AUDIT

            # Android Vendor Hooks
            enable_y CONFIG_ANDROID_VENDOR_HOOKS

            # FUSE（Android 文件系统栈）
            enable_y CONFIG_FUSE_FS

            # 模块能力（Android 要求）
            enable_y CONFIG_MODULES
            enable_y CONFIG_MODULE_UNLOAD
            enable_y CONFIG_MODVERSIONS
          fi

          # 生成最终 .config
          make LLVM=${LLVM} O=${OUT} ARCH=${ARCH} olddefconfig

          echo "[INFO] Key configs in final .config:"
          egrep -i 'CONFIG_(IKCONFIG|LOCALVERSION|NAMESPACES|IPC_NS|CGROUP|BPF|XDP|OVERLAY|VETH|BRIDGE|BRIDGE_VLAN_FILTERING|VXLAN|NETFILTER|XT_|IP_SET|NF_TABLES|NFT_|IP_VS|IP_NF_|IP6_NF_|POSIX_MQUEUE|MACVLAN|IPVLAN|BTRFS_FS|SECURITY_SELINUX|ANDROID_VENDOR_HOOKS|AUDIT|FUSE_FS|MODULES|MODVERSIONS)' ${OUT}/.config | sort || true

      - name: Validate with Moby check-config.sh (informational)
        working-directory: kernel_src
        run: |
          set -e
          wget -O /tmp/check-config.sh https://raw.githubusercontent.com/moby/moby/master/contrib/check-config.sh
          chmod +x /tmp/check-config.sh
          /tmp/check-config.sh ${OUT}/.config || true

      ########################################################################
      # BUILD — kernel (Image.gz-dtb)
      ########################################################################
      - name: Build kernel (Image.gz / Image.gz-dtb)
        working-directory: kernel_src
        run: |
          set -e
          export ARCH=arm64
          export SUBARCH=arm64
          export CC=clang
          export LD=ld.lld
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CLANG_TRIPLE=aarch64-linux-gnu-
          make LLVM=${LLVM} O=${OUT} -j$(nproc)
          ls -la ${OUT}/arch/arm64/boot || true
          test -f ${OUT}/arch/arm64/boot/Image.gz-dtb

      ########################################################################
      # PACKAGE — AnyKernel3 flashable zip (image置于包根目录)
      ########################################################################
      - name: Prepare AnyKernel3 template
        run: |
          set -e
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AK3
          cat > AK3/anykernel.sh <<'EOF'
          #!/bin/sh
          # AnyKernel3 by osm0sis @ xda-developers
          properties() {
            kernel.string=Kernel (Docker+Android) for lmi @ GitHub Actions
            do.devicecheck=1
            do.modules=0
            do.systemless=0
            do.cleanup=1
            do.cleanuponabort=1
            device.name1=lmi
            is_slot_device=1
            block=/dev/block/bootdevice/by-name/boot
            ramdisk_compression=auto
          }
          . tools/ak3-core.sh
          patch_bootimage() {
            ui_print "Injecting Image.gz-dtb into boot..."
            split_boot
            if [ ! -f "$ZIPFILEDIR/Image.gz-dtb" ]; then
              abort "Image.gz-dtb not found in zip root"
            fi
            cp -f "$ZIPFILEDIR/Image.gz-dtb" kernel
            flash_boot
          }
          install() { patch_bootimage; }
          EOF
          chmod +x AK3/anykernel.sh

      - name: Copy kernel image into AK3 root
        run: |
          set -e
          cp -f kernel_src/out/arch/arm64/boot/Image.gz-dtb AK3/Image.gz-dtb

      - name: Make flashable zip (AK3)
        run: |
          set -e
          cd AK3
          zip -r9 ../lmi-kernel-ak3-v4.1.zip ./*

      ########################################################################
      # ARTIFACTS & RELEASE
      ########################################################################
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lmi-kernel-android-ak3-v4.1
          path: |
            kernel_src/out/arch/arm64/boot/Image*
            kernel_src/out/.config
            lmi-kernel-ak3-v4.1.zip

      - name: Prepare Release metadata
        id: meta
        run: |
          set -e
          DATE=$(date +'%Y%m%d')
          if [ -z "${{ inputs.release_tag }}" ]; then
            TAG="lmi-kernel-android-ak3-${{ inputs.branch }}-${DATE}-v4.1"
          else
            TAG="${{ inputs.release_tag }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "name=Docker+Android kernel (AK3) for lmi (${TAG})" >> $GITHUB_OUTPUT
          echo "body=\
          ## Docker+Android kernel for lmi — v4.1\\n\
          - Repo: ${{ inputs.repo_url }}\\n\
          - Branch: ${{ inputs.branch }}\\n\
          - Defconfig: arch/arm64/configs/${{ inputs.device }}_defconfig (fallback lmi_defconfig)\\n\
          - Patches: cgroup.patch (required) + xt_qtaguid.patch (conditional)\\n\
          - Packaging: AnyKernel3 flashable zip (Image.gz-dtb in zip root; inject into boot)\\n\
          - Notes: Uses AK3 template; keep ramdisk/cmdline unchanged for best ROM compatibility\\n\
          " >> $GITHUB_OUTPUT

      - name: Create Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.name }}
          body: ${{ steps.meta.outputs.body }}
          draft: false
          prerelease: false
          files: |
            kernel_src/out/arch/arm64/boot/Image*
            kernel_src/out/.config
            lmi-kernel-ak3-v4.1.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
