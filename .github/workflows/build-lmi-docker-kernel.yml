name: Build lmi Kernel → Docker-ready configs → AnyKernel3 → Release

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "要构建的内核源码分支（留空则使用远端默认分支）"
        required: false
  push:
    branches:
      - "*"

permissions:
  contents: write

env:
  ARCH: arm64
  SUBARCH: arm64
  THREADS_DEFAULT: 8
  KERNEL_REPO: https://github.com/ApartTUSITU/kernel_xiaomi_sm8250_mod
  DEFCONFIG_PATH: arch/arm64/configs/lmi_defconfig
  CLANG_URL: https://github.com/kdrag0n/proton-clang/archive/refs/tags/20210522.tar.gz
  CLANG_DIR: toolchains/proton-clang
  ANYKERNEL3_REPO: https://github.com/osm0sis/AnyKernel3.git
  PATCH_CGROUP_URL: https://raw.githubusercontent.com/MIGHTYBLANK001/kernel-build-by-AI/refs/heads/main/patch/cgroup.patch
  PATCH_QTAGUID_URL: https://raw.githubusercontent.com/MIGHTYBLANK001/kernel-build-by-AI/refs/heads/main/patch/xt_qtaguid.patch

jobs:
  build-package-release:
    runs-on: ubuntu-latest

    steps:
      - name: Prepare workspace
        run: |
          mkdir -p workspace

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            coreutils util-linux \
            bc bison flex libssl-dev \
            libelf-dev dwarves pkg-config zstd \
            zip unzip python3 rsync ccache git curl tar \
            patch xz-utils gzip \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi

      - name: Clone kernel source
        id: kernel_clone
        run: |
          set -e
          cd workspace
          REPO="${KERNEL_REPO}"
          USER_BRANCH="${{ github.event.inputs.branch }}"
          if [ -n "${USER_BRANCH}" ]; then
            git clone --depth=1 --branch "${USER_BRANCH}" "${REPO}" kernel_src
            echo "branch=${USER_BRANCH}" >> "$GITHUB_OUTPUT"
          else
            DEFAULT_BRANCH="$(git ls-remote --symref "${REPO}" HEAD | awk '/^ref:/ {print $2}' | awk -F'/' '{print $NF}')"
            [ -z "${DEFAULT_BRANCH}" ] && { echo "::error::Detect default branch failed"; exit 1; }
            git clone --depth=1 --branch "${DEFAULT_BRANCH}" "${REPO}" kernel_src
            echo "branch=${DEFAULT_BRANCH}" >> "$GITHUB_OUTPUT"
          fi

      - name: Fetch Proton-Clang & setup PATH
        run: |
          mkdir -p "${CLANG_DIR}"
          curl -L "${CLANG_URL}" | tar -xz --strip-components=1 -C "${CLANG_DIR}"
          echo "${PWD}/${CLANG_DIR}/bin" >> "$GITHUB_PATH"

      - name: Fetch patches (cgroup + xt_qtaguid)
        run: |
          set -eux
          cd workspace
          curl -L "${PATCH_CGROUP_URL}"  -o cgroup.patch
          curl -L "${PATCH_QTAGUID_URL}" -o xt_qtaguid.patch

      - name: Apply cgroup.patch (mandatory)
        run: |
          set -eux
          cd workspace/kernel_src
          (git apply --index ../cgroup.patch) || (patch -p1 < ../cgroup.patch)

      - name: Conditionally apply xt_qtaguid.patch
        run: |
          set -eux
          cd workspace/kernel_src
          if grep -R -I -nE "qtaguid|XT_QTAGUID|NETFILTER_XT_(MATCH|TARGET)_QTAGUID" . ; then
            (git apply --index ../xt_qtaguid.patch) || (patch -p1 < ../xt_qtaguid.patch)
          else
            echo "xt_qtaguid not found; skip."
          fi

      - name: Kernel clean & defconfig (lmi)
        run: |
          set -eux
          cd workspace/kernel_src

          make O=out ARCH=${ARCH} \
            HOSTCC=gcc HOSTCXX=g++ HOSTLD=/usr/bin/ld \
            LLVM=1 CC=clang LD=ld.lld \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
            clean || true

          make O=out ARCH=${ARCH} \
            HOSTCC=gcc HOSTCXX=g++ HOSTLD=/usr/bin/ld \
            LLVM=1 CC=clang LD=ld.lld \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
            mrproper || true

          [ -f "${DEFCONFIG_PATH}" ] || { echo "::error::DEFCONFIG missing"; exit 1; }

          make O=out ARCH=${ARCH} \
            HOSTCC=gcc HOSTCXX=g++ HOSTLD=/usr/bin/ld \
            LLVM=1 CC=clang LD=ld.lld \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
            "${DEFCONFIG_PATH}"

      - name: Build kernel scripts (to get scripts/config)
        run: |
          set -eux
          cd workspace/kernel_src
          make O=out ARCH=${ARCH} \
            HOSTCC=gcc HOSTLD=/usr/bin/ld \
            scripts

      # === 开启“全部”Docker 支持项（来自 moby check-config 的必要+常见可选）===
      - name: Enable ALL Docker-related kernel configs
        run: |
          set -eux
          cd workspace/kernel_src

          # Helper
          enable() { scripts/config --enable "$1" || true; }
          module() { scripts/config --module "$1" || true; }

          # --- Generally Necessary ---
          enable CONFIG_NAMESPACES
          enable CONFIG_NET_NS
          enable CONFIG_PID_NS
          enable CONFIG_IPC_NS
          enable CONFIG_UTS_NS
          enable CONFIG_USER_NS          # rootless/docker 推荐
          enable CONFIG_KEYS
          enable CONFIG_SECCOMP
          enable CONFIG_DEVPTS_MULTIPLE_INSTANCES
          enable CONFIG_POSIX_MQUEUE

          enable CONFIG_CGROUPS
          enable CONFIG_CGROUP_CPUACCT
          enable CONFIG_CGROUP_DEVICE
          enable CONFIG_CGROUP_FREEZER
          enable CONFIG_CGROUP_SCHED
          enable CONFIG_CPUSETS
          enable CONFIG_MEMCG

          enable CONFIG_VETH
          enable CONFIG_BRIDGE
          enable CONFIG_BRIDGE_NETFILTER

          # IPv4/iptables/NAT/MASQUERADE/conntrack/ipvs
          enable CONFIG_IP_NF_FILTER
          enable CONFIG_IP_NF_MANGLE
          enable CONFIG_IP_NF_NAT
          enable CONFIG_NF_NAT
          enable CONFIG_NF_NAT_NEEDED
          enable CONFIG_IP_NF_TARGET_MASQUERADE
          enable CONFIG_NETFILTER_XT_MATCH_ADDRTYPE
          enable CONFIG_NETFILTER_XT_MATCH_CONNTRACK
          module CONFIG_NETFILTER_XT_MATCH_IPVS

          # --- Optional Features (常见场景启用以减少报错) ---
          enable CONFIG_CGROUP_PIDS
          enable CONFIG_BLK_CGROUP
          enable CONFIG_CGROUP_PERF
          enable CONFIG_CGROUP_HUGETLB
          enable CONFIG_NET_CLS_CGROUP
          enable CONFIG_CGROUP_NET_PRIO
          enable CONFIG_CFS_BANDWIDTH
          enable CONFIG_FAIR_GROUP_SCHED
          enable CONFIG_RT_GROUP_SCHED     # 如不需要实时组，可改为禁用
          enable CONFIG_MEMCG_SWAP         || true
          enable CONFIG_MEMCG_SWAP_ENABLED || true
          enable CONFIG_MEMCG_KMEM         || true

          # --- Network drivers for Docker networks (overlay/macvlan/ipvlan 等) ---
          module CONFIG_VXLAN
          module CONFIG_MACVLAN
          module CONFIG_IPVLAN
          module CONFIG_DUMMY

          # --- Optional for encrypted networks/IPsec/XFRM ---
          enable CONFIG_CRYPTO
          enable CONFIG_CRYPTO_AEAD
          enable CONFIG_CRYPTO_GCM
          enable CONFIG_CRYPTO_SEQIV
          enable CONFIG_CRYPTO_GHASH
          enable CONFIG_XFRM
          enable CONFIG_XFRM_USER
          module CONFIG_XFRM_ALGO
          module CONFIG_INET_ESP
          module CONFIG_INET_XFRM_MODE_TRANSPORT

          # --- Storage drivers（保持 overlay 必开，其它驱动尽量模块化）---
          enable CONFIG_OVERLAY_FS
          module CONFIG_BLK_DEV_DM
          module CONFIG_DM_THIN_PROVISIONING
          module CONFIG_BTRFS_FS
          module CONFIG_BTRFS_FS_POSIX_ACL
          # AUFS/ZFS 通常为外部树，不强制

          # --- Docker 28.0.0+ ipset 新增检查 ---
          module CONFIG_IP_SET
          module CONFIG_IP_SET_HASH_NET
          module CONFIG_NETFILTER_XT_SET

          # 固化依赖
          make O=out olddefconfig

      - name: Run moby check-config.sh against out/.config
        run: |
          set -eux
          cd workspace/kernel_src
          curl -L https://github.com/moby/moby/raw/master/contrib/check-config.sh -o check-config.sh
          chmod +x check-config.sh
          ./check-config.sh out/.config | tee ../docker-kernel-check.txt

      - name: Build kernel
        run: |
          set -eux
          cd workspace/kernel_src
          JOBS="$(getconf _NPROCESSORS_ONLN 2>/dev/null || echo ${THREADS_DEFAULT})"
          make -j"${JOBS}" O=out ARCH=${ARCH} \
            HOSTCC=gcc HOSTCXX=g++ HOSTLD=/usr/bin/ld \
            LLVM=1 CC=clang LD=ld.lld \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi-

      - name: Locate built image
        id: findimg
        run: |
          set -e
          cd workspace/kernel_src
          for f in \
            out/arch/arm64/boot/Image.gz-dtb \
            out/arch/arm64/boot/Image.gz \
            out/arch/arm64/boot/Image-dtb \
            out/arch/arm64/boot/Image \
          ; do [ -f "$f" ] && { echo "image=$f" >> "$GITHUB_OUTPUT"; echo "Found: $f"; exit 0; }; done
          echo "::error::未找到内核镜像"; exit 1

      - name: Clone AnyKernel3 & disable device check
        run: |
          set -eux
          cd workspace
          git clone --depth=1 "${ANYKERNEL3_REPO}" ak3
          sed -i "s/^do.devicecheck=.*/do.devicecheck=0/" ak3/anykernel.sh
          sed -i '/^device.name[0-9]\+=/d' ak3/anykernel.sh
          BRANCH="${{ steps.kernel_clone.outputs.branch }}"
          sed -i "s/^kernel.string=.*/kernel.string=${BRANCH} $(date +%Y-%m-%d)/" ak3/anykernel.sh

      - name: Prepare AK3 payload (image at zip root)
        run: |
          set -eux
          cd workspace
          cp "kernel_src/${{ steps.findimg.outputs.image }}" ak3/
          if [ -d "kernel_src/out/lib/modules" ]; then
            rsync -a kernel_src/out/lib/modules/ ak3/modules/system/lib/modules/
          fi

      - name: Make flashable zip (zip -9 deflate)
        id: mkzip
        run: |
          set -eux
          cd workspace
          BRANCH="${{ steps.kernel_clone.outputs.branch }}"
          TS="$(date +%Y%m%d-%H%M%S)"
          PKG="${BRANCH}-${TS}"
          (cd ak3 && zip -9 -r "../${PKG}.zip" .)
          echo "pkg=${PKG}" >> "$GITHUB_OUTPUT"
          ls -lh "${PKG}.zip"

      - name: Upload check report artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-kernel-check
          path: workspace/docker-kernel-check.txt

      - name: Create Release & Upload asset
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.mkzip.outputs.pkg }}
          name: ${{ steps.mkzip.outputs.pkg }}
          body: |
            Device: lmi
            Branch: ${{ steps.kernel_clone.outputs.branch }}
            Patches: cgroup (mandatory), xt_qtaguid (conditional)
            Docker configs: enabled per moby check-config; see artifact.
            Package: ${{ steps.mkzip.outputs.pkg }}.zip
            AnyKernel3: devicecheck=0; image at zip root; deflate zip.
          artifacts: workspace/${{ steps.mkzip.outputs.pkg }}.zip
          allowUpdates: true
