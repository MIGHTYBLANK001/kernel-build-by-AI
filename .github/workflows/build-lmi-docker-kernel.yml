
name: Build kernel (lmi/aosp, retain full script features)

on:
  workflow_dispatch:
    inputs:
      device:
        description: "目标机型（defconfig 前缀），如 lmi/umi 等"
        default: "lmi"
        required: true
      rom_type:
        description: "ROM 类型：aosp 或 miui（按原脚本的判断触发不同逻辑）"
        default: "aosp"
        required: true
      enable_ksu:
        description: "是否启用 SukiSU/KernelSU 补丁（第三参数传入 ksu）"
        default: "false"
        required: true

  # 如需在默认分支 push 时也触发，取消注释并把分支名改成你的默认分支（如 main 或 master）
  # push:
  #   branches:
  #     - main

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # 与原脚本保持一致的工具链和缓存路径
      TOOLCHAIN_PATH: ${{ github.workspace }}/../proton-clang/proton-clang-20210522/bin
      CCACHE_DIR: ${{ github.workspace }}/../.cache/ccache_mikernel

    steps:
      - name: Checkout kernel source (full history to allow restoring Patchs from another branch)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0  # 需要从 android15-lineage22-mod 恢复 Patchs

      - name: Ensure Patchs directory exists (restore from android15-lineage22-mod if missing)
        shell: bash
        run: |
          set -e
          if [[ -d "Patchs" ]]; then
            echo "Patchs/ already exists in current branch."
          else
            echo "Patchs/ not found. Restoring from branch: android15-lineage22-mod ..."
            # 获取该分支并仅恢复 Patchs 目录到当前工作树（不切换 HEAD）
            git fetch origin android15-lineage22-mod --depth=1
            git restore --source=origin/android15-lineage22-mod -- Patchs
            if [[ ! -d "Patchs" ]]; then
              echo "::error::无法从 android15-lineage22-mod 分支恢复 Patchs/ 目录，请检查分支与路径。"
              exit 1
            fi
          fi
          # 校验 LXC/其他补丁 zip 是否存在（脚本将依赖这些文件）
          ls -l Patchs || true

      - name: Preflight checks (defconfig existence)
        shell: bash
        run: |
          set -e
          dev="${{ github.event.inputs.device }}"
          if [[ ! -f "arch/arm64/configs/${dev}_defconfig" ]]; then
            echo "::error::未找到 defconfig: arch/arm64/configs/${dev}_defconfig"
            ls arch/arm64/configs/*_defconfig || true
            exit 1
          fi

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison flex libssl-dev \
            zip unzip git patch \
            build-essential make \
            ccache \
            binutils-aarch64-linux-gnu binutils-arm-linux-gnueabi
          # 为 ccache 建立 PATH 前缀（Ubuntu 推荐用法）
          echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV

      - name: Enable ccache cache (optional boost, does not change script behavior)
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ github.job }}-${{ github.event.inputs.device }}-${{ github.event.inputs.rom_type }}
          max-size: 2G
          create-symlink: true

      - name: Fetch Proton Clang 20210522 (expected by build.sh)
        run: |
          mkdir -p $HOME/proton-clang
          git clone --depth=1 --branch 20210522 https://github.com/kdrag0n/proton-clang \
            $HOME/proton-clang/proton-clang-20210522
          echo "PATH=${TOOLCHAIN_PATH}:$PATH" >> $GITHUB_ENV

      - name: Show toolchain & binutils versions
        run: |
          which clang || true
          clang --version || true
          aarch64-linux-gnu-ld --version || true
          arm-linux-gnueabi-ld --version || true

      - name: Run original build.sh with proper arguments (retain ALL features)
        shell: bash
        run: |
          set -e
          device="${{ github.event.inputs.device }}"
          rom="${{ github.event.inputs.rom_type }}"
          # 原脚本对 AOSP 的判断：第二或第三参数等于 aosp 则 BUILD_AOSP=1
          if [[ "$rom" == "aosp" ]]; then
            aosp_arg="aosp"
          else
            aosp_arg=""
          fi
          # KSU 补丁（第三参数为 ksu 时启用）
          if [[ "${{ github.event.inputs.enable_ksu }}" == "true" ]]; then
            ksu_arg="ksu"
          else
            ksu_arg=""
          fi

          echo ">>> Invoking: bash build.sh ${device} ${aosp_arg} ${ksu_arg}"
          bash build.sh "${device}" "${aosp_arg}" "${ksu_arg}"

      - name: Upload artifacts (zip, Image, dtb)
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ github.event.inputs.device }}-${{ github.event.inputs.rom_type }}-${{ github.run_id }}
          path: |
            ./*.zip
            anykernel/kernels/Image
            anykernel/kernels/dtb
            out/arch/arm64/boot/Image
            out/arch/arm64/boot/dts/**/*.dtb
          if-no-files-found: warn
