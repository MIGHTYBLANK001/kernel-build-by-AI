
name: Driftwood Kernel CI

on:
  workflow_dispatch:
    inputs:
      operation:
        description: "ÈÄâÊã©ÊûÑÂª∫Êìç‰ΩúÔºöall / cleanbuild / flashable / defconfig / kernelonly / version / savedefconfig"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - cleanbuild
          - flashable
          - defconfig
          - kernelonly
          - version
          - savedefconfig
      with_kernelsu:
        description: "ÊòØÂê¶ÂåÖÂê´ KernelSUÔºàtrue=ÂåÖÂê´Ôºåfalse=Á¶ÅÁî®Ôºâ"
        required: true
        default: "true"
        type: boolean
      kernel_repo_url:
        description: "ÂÜÖÊ†∏Ê∫êÁ†Å‰ªìÂ∫ìÈìæÊé•ÔºàÁïôÁ©∫Êó∂‰ΩøÁî®ÂΩìÂâç‰ªìÂ∫ìÔºâ"
        required: false
        default: ""
        type: string
      kernel_repo_ref:
        description: "ÂÜÖÊ†∏Ê∫êÁ†ÅÂàÜÊîØÊàñÊ†áÁ≠æÔºà‰ªÖÂú®ÊåáÂÆö‰ªìÂ∫ìÈìæÊé•Êó∂ÁîüÊïàÔºâ"
        required: false
        default: "main"
        type: string
      kernelsu_repo_url:
        description: "KernelSU ‰ªìÂ∫ìÈìæÊé•ÔºàWITH_KERNELSU=true Êó∂ÁîüÊïàÔºâ"
        required: false
        default: "https://github.com/tiann/KernelSU.git"
        type: string
      kernelsu_repo_ref:
        description: "KernelSU ÂàÜÊîØÊàñÊ†áÁ≠æÔºàWITH_KERNELSU=true Êó∂ÁîüÊïàÔºâ"
        required: false
        default: "main"
        type: string

  push:
    branches:
      - main
    paths:
      - "**/*.c"
      - "**/*.h"
      - "arch/**"
      - "include/**"
      - "drivers/**"
      - "Makefile"
      - "Kbuild"
      - ".github/workflows/kernel-build.yml"

  pull_request:
    branches:
      - main

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build (${{ matrix.device }})
    runs-on: ubuntu-latest
    timeout-minutes: 120

    strategy:
      fail-fast: false
      matrix:
        include:
          - device: picasso
            defconfig_name: vendor/picasso_user_defconfig
            target_kernel_name: Driftwood-Kernel-picasso
            anykernel_url: https://codeload.github.com/EndCredits/AnyKernel3/zip/refs/heads/picasso
            anykernel_path: AnyKernel3-picasso
            anykernel_file: anykernel.zip

    env:
      ARCH: arm64
      CC: clang
      LD: ld.lld
      CLANG_TRIPLE: aarch64-linux-gnu-
      CROSS_COMPILE: aarch64-linux-gnu-
      CROSS_COMPILE_COMPAT: arm-linux-gnueabi-
      CC_ADDITION_FLAGS: "LD=ld.lld"
      OUT: .out

      DEFCONFIG_PATH: arch/arm64/configs
      DISABLE_KSU_FRAGMENT: vendor/disable_ksu.config
      TARGET_KERNEL_FILE: arch/arm64/boot/Image
      TARGET_KERNEL_DTB: arch/arm64/boot/dtb
      TARGET_KERNEL_DTBO: arch/arm64/boot/dtbo.img

      DEFCONFIG_NAME: ${{ matrix.defconfig_name }}
      TARGET_KERNEL_NAME: ${{ matrix.target_kernel_name }}
      ANYKERNEL_URL: ${{ matrix.anykernel_url }}
      ANYKERNEL_PATH: ${{ matrix.anykernel_path }}
      ANYKERNEL_FILE: ${{ matrix.anykernel_file }}

      CCACHE_DIR: ${{ github.workspace }}/.ccache
      LXC_UTILS_URL: https://raw.githubusercontent.com/MIGHTYBLANK001/kernel-build-by-AI/refs/heads/main/Patchs/LXC_utils.zip
      KERNEL_SRC_DIR: kernel-src

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache APT packages
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/apt
            /var/lib/apt/lists
          key: apt-${{ runner.os }}-${{ hashFiles('.github/workflows/kernel-build.yml') }}
          restore-keys: |
            apt-${{ runner.os }}-

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            gcc-arm-linux-gnueabi \
            g++-arm-linux-gnueabi \
            clang \
            lld \
            llvm \
            bc \
            flex \
            bison \
            libssl-dev \
            libncurses-dev \
            zip \
            unzip \
            curl \
            git \
            rsync \
            python3 \
            ca-certificates \
            ccache \
            patch
          clang --version
          ld.lld --version
          ccache --version

      - name: Resolve kernel source directory
        shell: bash
        run: |
          set -e
          if [ -z "${{ inputs.kernel_repo_url }}" ]; then
            echo "Êú™ÊåáÂÆöÂÜÖÊ†∏Ê∫êÁ†Å‰ªìÂ∫ìÈìæÊé•Ôºå‰ΩøÁî®ÂΩìÂâç‰ªìÂ∫ì‰Ωú‰∏∫Ê∫êÁ†ÅÁõÆÂΩï"
            echo "KERNEL_SRC_DIR=." >> $GITHUB_ENV
          else
            echo "Â∞Ü‰ªéÂ§ñÈÉ®‰ªìÂ∫ìÂÖãÈöÜÂÜÖÊ†∏Ê∫êÁ†ÅÂà∞ kernel-src"
            echo "KERNEL_SRC_DIR=kernel-src" >> $GITHUB_ENV
          fi

      - name: Clone kernel source (if provided)
        if: ${{ inputs.kernel_repo_url != '' }}
        shell: bash
        run: |
          set -e
          rm -rf kernel-src
          echo "Cloning: ${{ inputs.kernel_repo_url }} (ref: ${{ inputs.kernel_repo_ref }})"
          git clone --depth 1 --branch "${{ inputs.kernel_repo_ref }}" "${{ inputs.kernel_repo_url }}" kernel-src
          echo "ÂÖãÈöÜÂÆåÊàêÔºö$(ls -la kernel-src | wc -l) È°πÁõÆÊñá‰ª∂"

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ runner.os }}-${{ matrix.device }}-${{ inputs.with_kernelsu }}-${{ inputs.kernel_repo_url }}-${{ inputs.kernel_repo_ref }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ matrix.device }}-
            ccache-${{ runner.os }}-

      - name: Cache build output (.out)
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/${{ env.KERNEL_SRC_DIR }}/.out
          key: out-${{ runner.os }}-${{ matrix.device }}-${{ inputs.with_kernelsu }}-${{ inputs.kernel_repo_url }}-${{ inputs.kernel_repo_ref }}
          restore-keys: |
            out-${{ runner.os }}-${{ matrix.device }}-
            out-${{ runner.os }}-

      - name: Prepare environment
        id: prep
        shell: bash
        working-directory: ${{ env.KERNEL_SRC_DIR }}
        run: |
          set -e
          THREADS=$(nproc --all)
          echo "THREADS=$THREADS" >> $GITHUB_ENV

          START_SEC=$(date +%s)
          CURRENT_TIME=$(date '+%Y-%m%d%H%M')
          echo "START_SEC=$START_SEC" >> $GITHUB_ENV
          echo "CURRENT_TIME=$CURRENT_TIME" >> $GITHUB_ENV

          echo "CC=ccache clang" >> $GITHUB_ENV

          DEFCONFIG_FILE="$DEFCONFIG_PATH/$DEFCONFIG_NAME"
          if [ ! -f "$DEFCONFIG_FILE" ]; then
            echo "‚ùå Êú™ÊâæÂà∞ defconfig: $DEFCONFIG_FILE"
            ls -la "$DEFCONFIG_PATH" || true
            exit 1
          fi

          LOCAL_VERSION_NUMBER=$(grep -E '^CONFIG_LOCALVERSION=' "$DEFCONFIG_FILE" | cut -d '=' -f 2 | sed 's/"//g' | sed 's/-Driftwood-//g')
          echo "LOCAL_VERSION_NUMBER=$LOCAL_VERSION_NUMBER" >> $GITHUB_ENV

          KVER=$(make kernelversion)
          TARGET_KERNEL_MOD_VERSION="${KVER}-${LOCAL_VERSION_NUMBER}"
          echo "TARGET_KERNEL_MOD_VERSION=$TARGET_KERNEL_MOD_VERSION" >> $GITHUB_ENV

          if [ "${{ inputs.with_kernelsu }}" = "false" ]; then
            echo "WITH_KERNELSU=0" >> $GITHUB_ENV
            echo "KernelSU disabled"
          else
            echo "WITH_KERNELSU=1" >> $GITHUB_ENV
          fi

          echo "operation: ${{ inputs.operation }}"
          echo "device: ${{ matrix.device }}"
          echo "defconfig: $DEFCONFIG_NAME"
          echo "threads: $THREADS"
          echo "kernel source dir: $PWD"

      # ---------- KernelSU ÈõÜÊàê‰øÆÂ§ç ----------
      - name: Prepare KernelSU integration
        shell: bash
        working-directory: ${{ env.KERNEL_SRC_DIR }}
        run: |
          set -e
          echo "üîß KernelSU ÈõÜÊàêÊ£ÄÊü•..."

          # 1) Ëã•ÂêØÁî® KernelSUÔºöÊãâÂèñÊ∫êÁ†ÅÂà∞ drivers/kernelsu
          if [ "$WITH_KERNELSU" = "1" ]; then
            if [ ! -d drivers/kernelsu ]; then
              echo "‚ûú ÂÖãÈöÜ KernelSU: ${{ inputs.kernelsu_repo_url }} (ref: ${{ inputs.kernelsu_repo_ref }})"
              git clone --depth 1 --branch "${{ inputs.kernelsu_repo_ref }}" "${{ inputs.kernelsu_repo_url }}" drivers/kernelsu
            else
              echo "‚Ä¢ Â∑≤Â≠òÂú® drivers/kernelsuÔºåË∑≥ËøáÂÖãÈöÜ"
            fi
          fi

          # 2) Ëã•Á¶ÅÁî® KernelSUÔºöÈò≤Ê≠¢ Kconfig Á°¨ÂºïÁî®ÂØºËá¥Êä•Èîô
          if [ "$WITH_KERNELSU" = "0" ]; then
            if grep -q 'source "drivers/kernelsu/Kconfig"' drivers/Kconfig; then
              echo "‚ö†Ô∏è Ê£ÄÊµãÂà∞ drivers/Kconfig ÂºïÁî®‰∫Ü KernelSUÔºåÁ¶ÅÁî®Ê®°Âºè‰∏ãËøõË°åÂÖºÂÆπÂ§ÑÁêÜ"
              # Ê≥®ÈáäËØ•Ë°åÔºåÈÅøÂÖç make defconfig Êä•Èîô
              sed -i 's|^\s*source "drivers/kernelsu/Kconfig"|# source "drivers/kernelsu/Kconfig" (disabled by workflow)|' drivers/Kconfig
            fi
            # Êèê‰æõ‰∏Ä‰∏™Âç†‰ΩçÁõÆÂΩï‰∏éÁ©∫ KconfigÔºåÈÅøÂÖçÂÖ∂ÂÆÉÂú∞ÊñπÂºïÁî®
            mkdir -p drivers/kernelsu
            echo 'menu "KernelSU (disabled)"\nendmenu' > drivers/kernelsu/Kconfig
          fi

          # ÊèêÁ§∫ÊúÄÁªàÁä∂ÊÄÅ
          if [ -d drivers/kernelsu ]; then
            echo "‚úì drivers/kernelsu ÁõÆÂΩïÂ≠òÂú®"
            ls -la drivers/kernelsu | head -n 20 || true
          else
            echo "‚Ä¢ drivers/kernelsu ÁõÆÂΩï‰∏çÂ≠òÂú®ÔºàÂ¶ÇÊûú WITH_KERNELSU=1ÔºåËøôÂ∞ÜÂØºËá¥Â§±Ë¥•Ôºâ"
          fi

      # ---------- LXC Ë°•‰∏ÅÔºàÁºñËØëÂâçÔºâ ----------
      - name: Apply LXC patches (enable Docker, qtaguid, runcpatch)
        shell: bash
        working-directory: ${{ env.KERNEL_SRC_DIR }}
        run: |
          set -e
          echo "üîß Ê≠£Âú®‰∏∫ÂÜÖÊ†∏ÂÆâË£Ö LXC Ë°•‰∏Å..."

          rm -rf utils LXC_utils.zip
          echo "‚ûú ‰∏ãËΩΩ LXC utils: $LXC_UTILS_URL"
          curl -L "$LXC_UTILS_URL" -o LXC_utils.zip
          unzip -o LXC_utils.zip -d utils

          if ! grep -q 'source "utils/Kconfig"' Kconfig; then
            echo 'source "utils/Kconfig"' >> Kconfig
            echo "‚úì Â∑≤Âú® Kconfig ÂºïÂÖ• utils/Kconfig"
          else
            echo "‚Ä¢ Kconfig Â∑≤ÂåÖÂê´ utils/Kconfig"
          fi

          DEFCONFIG_FILE="$DEFCONFIG_PATH/$DEFCONFIG_NAME"
          if [ ! -f "$DEFCONFIG_FILE" ]; then
            echo "‚ùå Êú™ÊâæÂà∞ defconfig: $DEFCONFIG_FILE"
            exit 1
          fi

          if ! grep -q '^CONFIG_DOCKER=y' "$DEFCONFIG_FILE"; then
            echo "CONFIG_DOCKER=y" >> "$DEFCONFIG_FILE"
            echo "‚úì Â∑≤ÂêØÁî® CONFIG_DOCKER=y"
          else
            echo "‚Ä¢ Â∑≤Â≠òÂú® CONFIG_DOCKER=y"
          fi

          sed -i '/CONFIG_ANDROID_PARANOID_NETWORK/d' "$DEFCONFIG_FILE"
          echo "# CONFIG_ANDROID_PARANOID_NETWORK is not set" >> "$DEFCONFIG_FILE"
          echo "‚úì Â∑≤Á¶ÅÁî® ANDROID_PARANOID_NETWORK"

          chmod +x utils/runcpatch.sh
          if [[ -f kernel/cgroup/cgroup.c ]]; then
            sh utils/runcpatch.sh kernel/cgroup/cgroup.c || true
            echo "‚úì Â∑≤ÂØπ kernel/cgroup/cgroup.c Â∫îÁî® runcpatch"
          fi
          if [[ -f kernel/cgroup.c ]]; then
            sh utils/runcpatch.sh kernel/cgroup.c || true
            echo "‚úì Â∑≤ÂØπ kernel/cgroup.c Â∫îÁî® runcpatch"
          fi

          if [[ -f net/netfilter/xt_qtaguid.c && -f utils/xt_qtaguid.patch ]]; then
            patch -p0 < utils/xt_qtaguid.patch || true
            echo "‚úì Â∑≤Â∫îÁî® xt_qtaguid.patch"
          else
            echo "‚Ä¢ Ë∑≥Ëøá xt_qtaguid.patchÔºàÊñá‰ª∂‰∏çÂ≠òÂú®Ôºâ"
          fi

          echo "‚úÖ LXC Ë°•‰∏ÅÂÆâË£ÖÂÆåÊàêÔºÅ"

      # ---------- cleanÔºà‰ªÖ cleanbuildÔºâ ----------
      - name: clean (for cleanbuild)
        if: ${{ inputs.operation == 'cleanbuild' }}
        shell: bash
        working-directory: ${{ env.KERNEL_SRC_DIR }}
        run: |
          set -e
          echo "Clean source tree and build files..."
          make mrproper -j$(nproc --all) || true
          make clean -j$(nproc --all) || true
          rm -rf "$OUT" || true

      # ---------- defconfig ----------
      - name: make_defconfig
        if: ${{ inputs.operation == 'all' || inputs.operation == 'cleanbuild' || inputs.operation == 'defconfig' || inputs.operation == 'kernelonly' }}
        shell: bash
        working-directory: ${{ env.KERNEL_SRC_DIR }}
        run: |
          set -e
          echo "------------------------------"
          echo " Building Kernel Defconfig.."
          echo "------------------------------"

          DEF_FRAG="$DEFCONFIG_NAME"
          if [ "$WITH_KERNELSU" = "0" ]; then
            DEF_FRAG="$DEF_FRAG $DISABLE_KSU_FRAGMENT"
            echo "KernelSU disabled: using fragments -> $DEF_FRAG"
          fi

          mkdir -p "$OUT"
          ccache -z || true
          make CC="$CC" ARCH="$ARCH" \
               CROSS_COMPILE="$CROSS_COMPILE" \
               CROSS_COMPILE_COMPAT="$CROSS_COMPILE_COMPAT" \
               CLANG_TRIPLE="$CLANG_TRIPLE" \
               LLVM=1 LLVM_IAS=1 \
               $CC_ADDITION_FLAGS \
               O="$OUT" -j"$THREADS" \
               $DEF_FRAG
          ccache -s || true

      # ---------- kernel ----------
      - name: build_kernel
        if: ${{ inputs.operation == 'all' || inputs.operation == 'cleanbuild' || inputs.operation == 'kernelonly' }}
        shell: bash
        working-directory: ${{ env.KERNEL_SRC_DIR }}
        run: |
          set -e
          echo "------------------------------"
          echo " Building Kernel ..........."
          echo "------------------------------"

          make CC="$CC" ARCH="$ARCH" \
               CROSS_COMPILE="$CROSS_COMPILE" \
               CROSS_COMPILE_COMPAT="$CROSS_COMPILE_COMPAT" \
               CLANG_TRIPLE="$CLANG_TRIPLE" \
               LLVM=1 LLVM_IAS=1 \
               $CC_ADDITION_FLAGS \
               O="$OUT" -j"$THREADS"
          ccache -s || true

          END_SEC=$(date +%s)
          COST_SEC=$(( END_SEC-START_SEC ))
          echo "Kernel Build Costed $((COST_SEC/60))min $((COST_SEC%60))s"

      # ---------- link dtb ----------
      - name: link_all_dtb_files
        if: ${{ inputs.operation == 'all' || inputs.operation == 'cleanbuild' }}
        shell: bash
        working-directory: ${{ env.KERNEL_SRC_DIR }}
        run: |
          set -e
          echo "------------------------------"
          echo " Linking DTB files .........."
          echo "------------------------------"

          find "$OUT/arch/arm64/boot/dts/vendor/qcom" -name '*.dtb' -exec cat {} + > "$OUT/arch/arm64/boot/dtb"

      # ---------- flashable ----------
      - name: generate_flashable
        if: ${{ inputs.operation == 'all' || inputs.operation == 'cleanbuild' || inputs.operation == 'flashable' }}
        shell: bash
        working-directory: ${{ env.KERNEL_SRC_DIR }}
        run: |
          set -e
          echo "------------------------------"
          echo " Generating Flashable Kernel"
          echo "------------------------------"

          cd "$OUT"

          if [ ! -d "$ANYKERNEL_PATH" ]; then
            echo " Getting AnyKernel "
            curl -L "$ANYKERNEL_URL" -o "$ANYKERNEL_FILE"
            unzip -o "$ANYKERNEL_FILE"
          else
            echo " AnyKernel3 Detected. Skipping download "
          fi

          echo " Removing old package files "
          rm -rf "$ANYKERNEL_PATH/$TARGET_KERNEL_NAME"* || true

          echo " Copying Kernel Files "
          cp -r "$TARGET_KERNEL_FILE" "$ANYKERNEL_PATH"/
          cp -r "$TARGET_KERNEL_DTB" "$ANYKERNEL_PATH"/
          cp -r "$TARGET_KERNEL_DTBO" "$ANYKERNEL_PATH"/

          echo " Packaging flashable Kernel "
          cd "$ANYKERNEL_PATH"
          PKG_NAME="$TARGET_KERNEL_NAME-$CURRENT_TIME-$TARGET_KERNEL_MOD_VERSION.zip"
          zip -q -r "$PKG_NAME" *

          echo "PKG_NAME=$PKG_NAME" >> $GITHUB_ENV
          echo "TARGET_PKG_PATH=$OUT/$ANYKERNEL_PATH/$PKG_NAME" >> $GITHUB_ENV

          echo " Target File: $OUT/$ANYKERNEL_PATH/$PKG_NAME "

      # ---------- savedefconfig ----------
      - name: savedefconfig
        if: ${{ inputs.operation == 'savedefconfig' }}
        shell: bash
        working-directory: ${{ env.KERNEL_SRC_DIR }}
        run: |
          set -e
          echo "------------------------------"
          echo " Saving kernel config ........"
          echo "------------------------------"

          mkdir -p "$OUT"
          make CC="$CC" ARCH="$ARCH" \
               CROSS_COMPILE="$CROSS_COMPILE" \
               CROSS_COMPILE_COMPAT="$CROSS_COMPILE_COMPAT" \
               CLANG_TRIPLE="$CLANG_TRIPLE" \
               $CC_ADDITION_FLAGS \
               O="$OUT" -j"$THREADS" savedefconfig

          END_SEC=$(date +%s)
          COST_SEC=$(( END_SEC-START_SEC ))
          echo "Finished. Kernel config saved to $OUT/defconfig"
          echo "Moving kernel defconfig to source tree"
          mv "$OUT/defconfig" "$DEFCONFIG_PATH/$DEFCONFIG_NAME"
          echo "Kernel Config Build Costed $((COST_SEC/60))min $((COST_SEC%60))s"

      # ---------- version ----------
      - name: version
        if: ${{ inputs.operation == 'version' }}
        shell: bash
        working-directory: ${{ env.KERNEL_SRC_DIR }}
        run: |
          echo "Current version is: $LOCAL_VERSION_NUMBER"

      - name: Upload flashable zip
        if: ${{ inputs.operation == 'all' || inputs.operation == 'cleanbuild' || inputs.operation == 'flashable' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TARGET_KERNEL_NAME }}-${{ env.CURRENT_TIME }}-${{ env.TARGET_KERNEL_MOD_VERSION }}
          path: ${{ env.TARGET_PKG_PATH }}
          if-no-files-found: error

      - name: Publish Release (tag only)
        if: startsWith(github.ref, 'refs/tags/') && (inputs.operation == 'all' || inputs.operation == 'cleanbuild' || inputs.operation == 'flashable')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.TARGET_PKG_PATH }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
