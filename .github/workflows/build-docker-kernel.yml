
name: Build Native-like ROM Kernel (Shell-logic) + LXC + AnyKernel3 + Release

on:
  workflow_dispatch:
    inputs:
      kernel_repo_url:
        description: "å†…æ ¸æºç ä»“åº“åœ°å€ï¼ˆä¾‹å¦‚ï¼šhttps://github.com/august-aosp/android_kernel_xiaomi_sm7250ï¼‰"
        required: true
        default: "https://github.com/august-aosp/android_kernel_xiaomi_sm7250"
        type: string
      device_codename:
        description: "æœºå‹ä»£å·ï¼ˆä¾‹å¦‚ï¼špicassoã€beryllium ç­‰ï¼‰"
        required: true
        default: "picasso"
        type: string
      defconfig_path:
        description: "defconfig è·¯å¾„æˆ–æ–‡ä»¶åï¼ˆå¦‚ï¼švendor/picasso_defconfig æˆ– arch/arm64/configs/vendor/picasso_defconfigï¼‰"
        required: true
        default: "vendor/picasso_defconfig"
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      - name: Show inputs
        shell: bash
        run: |
          echo "kernel_repo_url=${{ inputs.kernel_repo_url }}"
          echo "device_codename=${{ inputs.device_codename }}"
          echo "defconfig_path=${{ inputs.defconfig_path }}"

      # ä»…å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆä¸åšä»»ä½• LLVM ç‰ˆæœ¬æ˜ å°„/æ›¿æ¢ï¼›éµå¾ª sh è„šæœ¬â€œPATH æœ‰ clang å³å¯â€çš„æ€è·¯ï¼‰
      - name: Install minimal build dependencies (clang, lld, etc.)
        shell: bash
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y \
            bc bison flex \
            build-essential git curl wget zip unzip patch \
            libssl-dev libelf-dev \
            python3 rsync ccache \
            dwarves lz4 clang lld \
            binutils-aarch64-linux-gnu

      - name: Clone kernel source
        shell: bash
        run: |
          set -eux
          git clone --depth=1 "${{ inputs.kernel_repo_url }}" kernel-src

      - name: Init submodules (if any)
        working-directory: kernel-src
        shell: bash
        run: |
          set -eux
          git submodule update --init --recursive || true

      # è§£æ defconfig è·¯å¾„ï¼ˆæ”¯æŒ vendor å­ç›®å½•ï¼‰ï¼›ä»…ç”¨äºè¡¥ä¸æ³¨å…¥æ—¶å®šä½ç›®æ ‡æ–‡ä»¶
      - name: Resolve defconfig path
        id: defcfg
        working-directory: kernel-src
        shell: bash
        env:
          ARCH_IN: "arm64"
        run: |
          set -eux
          DF_IN="${{ inputs.defconfig_path }}"
          if [ -f "$DF_IN" ]; then
            DF_PATH="$DF_IN"
          else
            CANDIDATES=(
              "arch/${ARCH_IN}/configs/${DF_IN}"
              "arch/${ARCH_IN}/configs/$(basename "$DF_IN")"
              "arch/${ARCH_IN}/configs/vendor/$(basename "$DF_IN")"
              "vendor/$(basename "$DF_IN")"
              "${DF_IN}"
            )
            DF_PATH=""
            for p in "${CANDIDATES[@]}"; do
              if [ -f "$p" ]; then DF_PATH="$p"; break; fi
            done
            if [ -z "$DF_PATH" ]; then
              echo "âŒ æœªæ‰¾åˆ° defconfig æ–‡ä»¶ï¼Œå°è¯•è¿‡ä»¥ä¸‹ï¼š"
              printf ' - %s\n' "${CANDIDATES[@]}"
              exit 1
            fi
          fi
          echo "DF_PATH=${DF_PATH}" >> "$GITHUB_OUTPUT"
          echo "âœ” defconfigï¼š$DF_PATH"

      #####################################################################
      # ç¼–è¯‘å‰æ‰“ LXC è¡¥ä¸ï¼ˆä¸¥æ ¼éµå¾ª sh é€»è¾‘ï¼šçº¯ bash æ“ä½œæºç  + æ”¹ defconfigï¼‰
      #####################################################################
      - name: Fetch LXC utils
        working-directory: kernel-src
        shell: bash
        run: |
          set -eux
          mkdir -p Patchs
          wget -O Patchs/LXC_utils.zip \
            "https://raw.githubusercontent.com/MIGHTYBLANK001/kernel-build-by-AI/refs/heads/main/Patchs/LXC_utils.zip"
          ls -l Patchs/LXC_utils.zip

      - name: Apply LXC patches (Docker, runcpatch, xt_qtaguid)
        working-directory: kernel-src
        shell: bash
        env:
          DF_PATH: ${{ steps.defcfg.outputs.DF_PATH }}
        run: |
          set -euo pipefail
          echo "ğŸ”§ åº”ç”¨ LXC ç›¸å…³æ”¹åŠ¨..."
          rm -rf utils && unzip -o Patchs/LXC_utils.zip -d utils

          # åœ¨é¡¶å±‚ Kconfig åŠ å…¥ utils/Kconfig
          if ! grep -q 'source "utils/Kconfig"' Kconfig; then
            echo 'source "utils/Kconfig"' >> Kconfig
          fi

          # ä¿®æ”¹ defconfigï¼šå¯ç”¨ Dockerï¼Œå…³é—­ ANDROID_PARANOID_NETWORK
          if [ -f "$DF_PATH" ]; then
            if ! grep -q '^CONFIG_DOCKER=y' "$DF_PATH"; then
              echo "CONFIG_DOCKER=y" >> "$DF_PATH"
            fi
            sed -i '/CONFIG_ANDROID_PARANOID_NETWORK/d' "$DF_PATH" || true
            echo "# CONFIG_ANDROID_PARANOID_NETWORK is not set" >> "$DF_PATH"
          fi

          # runcpatchï¼šä¸¤æ¡å¸¸è§è·¯å¾„éƒ½å°è¯•
          chmod +x utils/runcpatch.sh
          [ -f kernel/cgroup/cgroup.c ] && sh utils/runcpatch.sh kernel/cgroup/cgroup.c || true
          [ -f kernel/cgroup.c ]       && sh utils/runcpatch.sh kernel/cgroup.c       || true

          # xt_qtaguid è¡¥ä¸ï¼ˆå­˜åœ¨åˆ™åº”ç”¨ï¼›å¤±è´¥ä¸è‡´å‘½ï¼‰
          if [ -f net/netfilter/xt_qtaguid.c ] && [ -f utils/xt_qtaguid.patch ]; then
            patch -p0 < utils/xt_qtaguid.patch || true
          fi
          echo "âœ… LXC è¡¥ä¸å®Œæˆ"

      #####################################################################
      # çº¯ sh è„šæœ¬é€»è¾‘ï¼šmake_defconfig â†’ build_kernel â†’ link_all_dtb â†’ æ‰“åŒ…
      #####################################################################
      - name: Build kernel via Shell-logic
        working-directory: kernel-src
        shell: bash
        env:
          DEFCONFIG_NAME: ${{ inputs.defconfig_path }}
        run: |
          set -eux

          # ===== å˜é‡ï¼ˆå®Œå…¨éµå¾ª sh è„šæœ¬ï¼‰ =====
          ARCH=arm64
          CC=clang
          LD=ld.lld
          CLANG_TRIPLE=aarch64-linux-gnu-
          CROSS_COMPILE=aarch64-linux-gnu-
          CROSS_COMPILE_COMPAT=arm-linux-gnueabi-
          THREAD=$(nproc --all)
          OUT="../out"

          # ===== defconfigï¼ˆçº¯ sh é€»è¾‘ï¼‰ =====
          echo ">>> Building defconfig ($DEFCONFIG_NAME)"
          make CC=$CC ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE CROSS_COMPILE_COMPAT=$CROSS_COMPILE_COMPAT \
               CLANG_TRIPLE=$CLANG_TRIPLE LLVM=1 LLVM_IAS=1 LD=$LD O=$OUT -j$THREAD "$DEFCONFIG_NAME"

          # ===== ç¼–è¯‘ï¼ˆçº¯ sh é€»è¾‘ï¼‰ =====
          echo ">>> Building kernel"
          make CC=$CC ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE CROSS_COMPILE_COMPAT=$CROSS_COMPILE_COMPAT \
               CLANG_TRIPLE=$CLANG_TRIPLE LLVM=1 LLVM_IAS=1 LD=$LD O=$OUT -j$THREAD

          # ===== é“¾æ¥æ‰€æœ‰ dtbï¼ˆçº¯ sh é€»è¾‘ï¼‰ =====
          echo ">>> Linking all DTB files"
          if [ -d "$OUT/arch/arm64/boot/dts" ]; then
            # å¸¸è§è·¯å¾„ï¼ˆå‚å•†æ ‘å¯èƒ½ä¸åŒï¼‰ï¼Œè¿™é‡Œä»¥ vendor/qcom ä¸ºä¾‹å¹¶æä¾›å…œåº•
            if [ -d "$OUT/arch/arm64/boot/dts/vendor/qcom" ]; then
              find "$OUT/arch/arm64/boot/dts/vendor/qcom" -name '*.dtb' -exec cat {} + > "$OUT/arch/arm64/boot/dtb"
            else
              # å…œåº•ï¼šæ”¶é›†æ‰€æœ‰ dtb
              find "$OUT/arch/arm64/boot/dts" -name '*.dtb' -exec cat {} + > "$OUT/arch/arm64/boot/dtb" || true
            fi
          fi

      # æŸ¥æ‰¾ Image/dtb/dtboï¼ˆç”¨äº AnyKernel3 æ‰“åŒ…ï¼‰
      - name: Locate kernel images
        id: locateimg
        shell: bash
        run: |
          set -eux
          ARCH_DIR="out/arch/arm64/boot"
          KIMG=$(ls ${ARCH_DIR}/Image*.lz4-dtb ${ARCH_DIR}/Image*.gz-dtb ${ARCH_DIR}/Image*-dtb ${ARCH_DIR}/Image.gz ${ARCH_DIR}/Image 2>/dev/null | head -n 1 || true)
          if [ -z "$KIMG" ]; then
            echo "No kernel image found under ${ARCH_DIR}" >&2
            exit 1
          fi
          DTB=$(ls ${ARCH_DIR}/dtb 2>/dev/null || true)
          DTBO=$(ls ${ARCH_DIR}/dtbo.img 2>/dev/null || true)
          echo "KIMG=$KIMG"  >> $GITHUB_OUTPUT
          echo "DTB=$DTB"    >> $GITHUB_OUTPUT
          echo "DTBO=$DTBO"  >> $GITHUB_OUTPUT
          echo "Found kernel image: $KIMG"
          [ -n "$DTB" ]  && echo "Found dtb: $DTB"
          [ -n "$DTBO" ] && echo "Found dtbo: $DTBO"

      #####################################################################
      # AnyKernel3 æ‰“åŒ…ï¼ˆéµå¾ª sh æ€è·¯ï¼šæŠŠ Imageã€dtbã€dtbo å¡«åˆ° AK3ï¼‰
      #####################################################################
      - name: Clone AnyKernel3
        shell: bash
        run: |
          set -eux
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AnyKernel3

      - name: Prepare AnyKernel3 payload
        shell: bash
        run: |
          set -eux
          cp "${{ steps.locateimg.outputs.KIMG }}" AnyKernel3/
          if [ -n "${{ steps.locateimg.outputs.DTB }}" ];  then cp "${{ steps.locateimg.outputs.DTB }}"  AnyKernel3/; fi
          if [ -n "${{ steps.locateimg.outputs.DTBO }}" ]; then cp "${{ steps.locateimg.outputs.DTBO }}" AnyKernel3/; fi

          # è‹¥å­˜åœ¨ modulesï¼Œåˆ™ä¸€å¹¶æ‰“å…¥
          if [ -d "out/lib/modules" ]; then
            mkdir -p AnyKernel3/modules
            rsync -a "out/lib/modules/" AnyKernel3/modules/ || true
          fi

      - name: Patch anykernel.sh (device tag)
        working-directory: AnyKernel3
        shell: bash
        run: |
          set -eux
          if grep -q '^device.name1=' anykernel.sh; then
            sed -i "s|^device.name1=.*|device.name1=${{ inputs.device_codename }}|" anykernel.sh
          else
            sed -i "1idevice.name1=${{ inputs.device_codename }}" anykernel.sh
          fi
          if grep -q '^kernel.string=' anykernel.sh; then
            sed -i "s|^kernel.string=.*|kernel.string=Kernel for ${{ inputs.device_codename }} (clang+lld)|" anykernel.sh
          else
            sed -i "1ikernel.string=Kernel for ${{ inputs.device_codename }} (clang+lld)" anykernel.sh
          fi

      - name: Make flashable ZIP
        id: makezip
        working-directory: AnyKernel3
        shell: bash
        run: |
          set -eux
          DATESTR="$(date +%Y%m%d-%H%M)"
          ZIPNAME="AK3-${{ inputs.device_codename }}-${DATESTR}.zip"
          zip -r9 "../${ZIPNAME}" .
          echo "ZIPPATH=${ZIPNAME}" >> $GITHUB_OUTPUT
          echo "DATESTR=${DATESTR}" >> $GITHUB_OUTPUT
          echo "Flashable zip: ${ZIPNAME}"

      - name: Create Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ format('ak3-{0}-{1}', inputs.device_codename, steps.makezip.outputs.DATESTR) }}
          name: "AnyKernel3 for ${{ inputs.device_codename }} (clang+lld)"
          body: |
            - Device: ${{ inputs.device_codename }}
            - Kernel repo: ${{ inputs.kernel_repo_url }}
            - Defconfig: ${{ inputs.defconfig_path }}
            - Arch: arm64
            - Toolchain: clang + lld (LLVM_IAS=1)
            - LXC patches: Docker enabled, runcpatch applied, xt_qtaguid patched (if present)
            - Built at: ${{ env.TZ }}
          draft: false
          prerelease: false
          files: |
            ${{ steps.makezip.outputs.ZIPPATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
