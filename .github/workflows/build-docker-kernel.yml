
name: Rosemary Kernel Build (segmented + LXC patch, strict from build.sh)

on:
  workflow_dispatch:
    inputs:
      kernel_repo_url:
        description: "å†…æ ¸æºç ä»“åº“åœ°å€ï¼ˆä¾‹å¦‚ https://github.com/YourOrg/your-kernel.git ï¼‰"
        required: true
        type: string
      device_codename:
        description: "æœºå‹ä»£å·ï¼ˆç”¨äº AnyKernel3 åˆ†æ”¯ä¸ç›®å½•åï¼Œä¾‹å¦‚ picassoï¼‰"
        required: true
        type: string
      defconfig_path:
        description: "å®Œæ•´çš„ defconfig è·¯å¾„ï¼ˆä¾‹å¦‚ arch/arm64/configs/vendor/picasso_user_defconfigï¼‰"
        required: true
        type: string
      operation:
        description: "build.sh æ“ä½œï¼šall | cleanbuild | flashable | kernelonly | defconfig | savedefconfig | version"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - cleanbuild
          - flashable
          - kernelonly
          - defconfig
          - savedefconfig
          - version
      noksu:
        description: "ä¸å¯ç”¨ KernelSUï¼ˆä»…å¯¹ all/defconfig ç”Ÿæ•ˆï¼›ç­‰ä»·äºä¼ å…¥ 'noksu'ï¼‰"
        required: false
        default: false
        type: boolean

jobs:
  prep_01:
    name: 01 Â· å‡†å¤‡ç¯å¢ƒä¸å·¥å…·é“¾
    runs-on: ubuntu-latest
    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4
      - name: Install toolchain & utilities
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang llvm lld \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            gcc-arm-linux-gnueabi g++-arm-linux-gnueabi \
            bc curl unzip zip git patch
          echo "PATH=/usr/bin:${PATH}" >> $GITHUB_ENV

  fetch_02:
    name: 02 Â· æ‹‰å–å†…æ ¸æºç ä¸è¾“å…¥æ ¡éªŒ
    runs-on: ubuntu-latest
    needs: [prep_01]
    outputs:
      kernel_dir: ${{ steps.outvars.outputs.kernel_dir }}
    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4
      - name: Clone kernel source
        id: outvars
        run: |
          set -euo pipefail
          git clone --depth=1 "${{ inputs.kernel_repo_url }}" kernel
          echo "kernel_dir=${GITHUB_WORKSPACE}/kernel" >> $GITHUB_OUTPUT
      - name: Validate inputs
        run: |
          set -euo pipefail
          DEFCONFIG_FULL="${{ inputs.defconfig_path }}"
          if [[ ! "${DEFCONFIG_FULL}" =~ ^arch/arm64/configs/.+ ]]; then
            echo "âŒ defconfig_path ä¸åœ¨ arch/arm64/configs ä¸‹ï¼š${DEFCONFIG_FULL}"
            exit 1
          fi
          CODENAME="${{ inputs.device_codename }}"
          if [[ -z "${CODENAME}" ]]; then
            echo "âŒ device_codename ä¸èƒ½ä¸ºç©º"
            exit 1
          fi
          echo "âœ… è¾“å…¥æ ¡éªŒé€šè¿‡ï¼šdefconfig=${DEFCONFIG_FULL}ï¼Œcodename=${CODENAME}"

  derive_vars_03:
    name: 03 Â· è®¡ç®—æ´¾ç”Ÿå˜é‡ï¼ˆTHREAD/ç‰ˆæœ¬ç­‰ï¼‰
    runs-on: ubuntu-latest
    needs: [fetch_02]
    outputs:
      DEFCONFIG_PATH: ${{ steps.vars.outputs.DEFCONFIG_PATH }}
      DEFCONFIG_NAME: ${{ steps.vars.outputs.DEFCONFIG_NAME }}
      LOCAL_VERSION_NUMBER: ${{ steps.vars.outputs.LOCAL_VERSION_NUMBER }}
      TARGET_KERNEL_MOD_VERSION: ${{ steps.vars.outputs.TARGET_KERNEL_MOD_VERSION }}
      CURRENT_TIME: ${{ steps.vars.outputs.CURRENT_TIME }}
      START_SEC: ${{ steps.vars.outputs.START_SEC }}
    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4
      - name: Derive variables (strict from build.sh)
        id: vars
        working-directory: ${{ needs.fetch_02.outputs.kernel_dir }}
        run: |
          set -euo pipefail
          echo "THREAD=$(nproc --all)" >> $GITHUB_ENV

          DEFCONFIG_FULL="${{ inputs.defconfig_path }}"
          DEFCONFIG_PATH="$(dirname "${DEFCONFIG_FULL}")"
          DEFCONFIG_NAME="$(basename "${DEFCONFIG_FULL}")"

          LOCAL_VERSION_NUMBER="$(cat "${DEFCONFIG_PATH}/${DEFCONFIG_NAME}" \
            | grep CONFIG_LOCALVERSION= \
            | cut -d '=' -f 2 \
            | sed 's/"//g' \
            | sed 's/-Driftwood-//g')"

          TARGET_KERNEL_MOD_VERSION="$(make kernelversion)-${LOCAL_VERSION_NUMBER}"
          CURRENT_TIME="$(date '+%Y-%m%d%H%M')"
          START_SEC="$(date +%s)"

          echo "DEFCONFIG_PATH=${DEFCONFIG_PATH}" >> $GITHUB_OUTPUT
          echo "DEFCONFIG_NAME=${DEFCONFIG_NAME}" >> $GITHUB_OUTPUT
          echo "LOCAL_VERSION_NUMBER=${LOCAL_VERSION_NUMBER}" >> $GITHUB_OUTPUT
          echo "TARGET_KERNEL_MOD_VERSION=${TARGET_KERNEL_MOD_VERSION}" >> $GITHUB_OUTPUT
          echo "CURRENT_TIME=${CURRENT_TIME}" >> $GITHUB_OUTPUT
          echo "START_SEC=${START_SEC}" >> $GITHUB_OUTPUT

  prebuild_04a:
    name: 04a Â· ç¼–è¯‘å‰ï¼ˆclean + defconfigï¼‰
    runs-on: ubuntu-latest
    needs: [fetch_02, derive_vars_03]
    if: ${{ inputs.operation != 'version' && inputs.operation != 'savedefconfig' }}
    outputs:
      OUT_DIR: ${{ steps.outpath.outputs.OUT_DIR }}
    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4
      - name: Pre-Build steps (strictly mirror build.sh)
        id: pre
        shell: bash
        working-directory: ${{ needs.fetch_02.outputs.kernel_dir }}
        env:
          ARCH: arm64
          CC: clang
          LD: ld.lld
          CLANG_TRIPLE: aarch64-linux-gnu-
          CROSS_COMPILE: aarch64-linux-gnu-
          CROSS_COMPILE_COMPAT: arm-linux-gnueabi-
          OUT: ../out
          DISABLE_KSU_FRAGMENT: vendor/disable_ksu.config
          DEFCONFIG_PATH: ${{ needs.derive_vars_03.outputs.DEFCONFIG_PATH }}
          DEFCONFIG_NAME: ${{ needs.derive_vars_03.outputs.DEFCONFIG_NAME }}
        run: |
          set -euo pipefail
          THREAD="$(nproc --all)"
          CC_ADDITION_FLAGS="LD=${LD}"
          WITH_KERNELSU=1
          [[ "${{ inputs.noksu }}" == "true" ]] && WITH_KERNELSU=0

          clean() {
            echo "--- Cleaning source tree & out ---"
            make mrproper -j"${THREAD}"
            make clean -j"${THREAD}"
            rm -rf "${OUT}"
          }

          make_defconfig() {
            echo "--- Building Defconfig ---"
            DEFCONF_NAME="${DEFCONFIG_NAME}"
            if [[ "${WITH_KERNELSU}" == "0" ]]; then
              DEFCONF_NAME="${DEFCONF_NAME} ${DISABLE_KSU_FRAGMENT}"
            fi
            make CC="$CC" ARCH="$ARCH" CROSS_COMPILE="$CROSS_COMPILE" CROSS_COMPILE_COMPAT="$CROSS_COMPILE_COMPAT" \
                 CLANG_TRIPLE="$CLANG_TRIPLE" LLVM=1 LLVM_IAS=1 ${CC_ADDITION_FLAGS} O="$OUT" -j"${THREAD}" ${DEFCONF_NAME}
          }

          op="${{ inputs.operation }}"
          if [[ "${op}" == "cleanbuild" ]]; then
            clean
            make_defconfig
          elif [[ "${op}" == "kernelonly" || "${op}" == "all" || "${op}" == "defconfig" ]]; then
            make_defconfig
          elif [[ "${op}" == "flashable" ]]; then
            echo "flashable: ä¸æ‰§è¡Œ defconfigï¼ˆä¸è„šæœ¬ä¸€è‡´ï¼šéœ€å·²æœ‰æ„å»ºï¼‰"
          else
            echo "version/savedefconfig åœ¨å…¶ä»–é˜¶æ®µå¤„ç†ï¼Œè¿™é‡Œä¸è¿è¡Œã€‚"
          fi
      - name: OUT dir path
        id: outpath
        run: |
          echo "OUT_DIR=out" >> $GITHUB_OUTPUT
          echo "OUT_DIR_UP=../out" >> $GITHUB_OUTPUT
      - name: Upload pre-build snapshot
        uses: actions/upload-artifact@v4
        with:
          name: pre-build-out
          path: |
            out
            ../out
          if-no-files-found: ignore
          retention-days: 3

  prebuild_apply_lxc_04a2:
    name: 04a2 Â· ç¼–è¯‘å‰æ‰“ LXC è¡¥ä¸ï¼ˆDocker/qtaguid/runcpatchï¼‰
    runs-on: ubuntu-latest
    needs: [fetch_02, derive_vars_03, prebuild_04a]
    if: ${{ inputs.operation == 'cleanbuild' || inputs.operation == 'kernelonly' || inputs.operation == 'all' }}
    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4
      - name: Apply LXC patches (enable Docker, qtaguid, runcpatch)
        shell: bash
        working-directory: ${{ needs.fetch_02.outputs.kernel_dir }}
        env:
          DEFCONFIG_PATH: ${{ needs.derive_vars_03.outputs.DEFCONFIG_PATH }}
          DEFCONFIG_NAME: ${{ needs.derive_vars_03.outputs.DEFCONFIG_NAME }}
        run: |
          set -euo pipefail
          echo "ğŸ”§ æ­£åœ¨ä¸ºå†…æ ¸å®‰è£… LXC è¡¥ä¸..."

          # ä¼˜å…ˆä½¿ç”¨ä»“åº“å†… Patchs/LXC_utils.zipï¼›è‹¥ä¸å­˜åœ¨åˆ™ä»è¿œç¨‹ä¸‹è½½
          if [[ -f "Patchs/LXC_utils.zip" ]]; then
            echo "ä½¿ç”¨ä»“åº“å†… Patchs/LXC_utils.zip"
            rm -rf utils && unzip -o "Patchs/LXC_utils.zip" -d utils
          else
            echo "ä»è¿œç¨‹ä¸‹è½½ LXC_utils.zip"
            curl -L "https://raw.githubusercontent.com/MIGHTYBLANK001/kernel-build-by-AI/refs/heads/main/Patchs/LXC_utils.zip" -o LXC_utils.zip
            rm -rf utils && unzip -o LXC_utils.zip -d utils
          fi

          # åŸºæœ¬æ–‡ä»¶æ ¡éªŒ
          test -f utils/Kconfig || { echo "âŒ utils/Kconfig ç¼ºå¤±"; ls -la utils || true; exit 1; }
          test -f utils/runcpatch.sh || { echo "âŒ utils/runcpatch.sh ç¼ºå¤±"; ls -la utils || true; exit 1; }

          # åœ¨æ ¹ Kconfig å¼•å…¥ utils/Kconfig
          if ! grep -q 'source "utils/Kconfig"' Kconfig; then
            echo 'source "utils/Kconfig"' >> Kconfig
          fi

          DEFCONF_FILE="${DEFCONFIG_PATH}/${DEFCONFIG_NAME}"

          # æ‰“å¼€ Docker å¹¶å…³é—­ ANDROID_PARANOID_NETWORK
          if ! grep -q '^CONFIG_DOCKER=y' "${DEFCONF_FILE}"; then
            echo "CONFIG_DOCKER=y" >> "${DEFCONF_FILE}"
          fi
          sed -i '/^CONFIG_ANDROID_PARANOID_NETWORK/d' "${DEFCONF_FILE}"
          echo "# CONFIG_ANDROID_PARANOID_NETWORK is not set" >> "${DEFCONF_FILE}"

          # è¿è¡Œ runcpatchï¼ˆå…¼å®¹ä¸åŒç›®å½•ç»“æ„ï¼‰
          chmod +x utils/runcpatch.sh
          [[ -f kernel/cgroup/cgroup.c ]] && sh utils/runcpatch.sh kernel/cgroup/cgroup.c || true
          [[ -f kernel/cgroup.c ]] && sh utils/runcpatch.sh kernel/cgroup.c || true

          # qtaguid è¡¥ä¸ï¼ˆè‹¥å­˜åœ¨æºæ–‡ä»¶ä¸è¡¥ä¸ï¼‰
          if [[ -f net/netfilter/xt_qtaguid.c && -f utils/xt_qtaguid.patch ]]; then
            echo "åº”ç”¨ xt_qtaguid.patch"
            patch -p0 < utils/xt_qtaguid.patch || true
          else
            echo "è·³è¿‡ xt_qtaguid.patchï¼ˆæ–‡ä»¶ä¸å­˜åœ¨ï¼‰"
          fi
          echo "âœ… LXC è¡¥ä¸å®‰è£…å®Œæˆï¼"

  compile_04b:
    name: 04b Â· ç¼–è¯‘ï¼ˆmakeï¼‰
    runs-on: ubuntu-latest
    needs: [fetch_02, derive_vars_03, prebuild_04a, prebuild_apply_lxc_04a2]
    if: ${{ inputs.operation == 'cleanbuild' || inputs.operation == 'kernelonly' || inputs.operation == 'all' }}
    outputs:
      BUILD_DONE: ${{ steps.flag.outputs.BUILD_DONE }}
    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4
      - name: Compile (strict make from build.sh)
        id: compile
        shell: bash
        working-directory: ${{ needs.fetch_02.outputs.kernel_dir }}
        env:
          ARCH: arm64
          CC: clang
          LD: ld.lld
          CLANG_TRIPLE: aarch64-linux-gnu-
          CROSS_COMPILE: aarch64-linux-gnu-
          CROSS_COMPILE_COMPAT: arm-linux-gnueabi-
          OUT: ../out
          START_SEC: ${{ needs.derive_vars_03.outputs.START_SEC }}
        run: |
          set -euo pipefail
          THREAD="$(nproc --all)"
          CC_ADDITION_FLAGS="LD=${LD}"
          echo "--- Building Kernel (make) ---"
          make CC="$CC" ARCH="$ARCH" CROSS_COMPILE="$CROSS_COMPILE" CROSS_COMPILE_COMPAT="$CROSS_COMPILE_COMPAT" \
               CLANG_TRIPLE="$CLANG_TRIPLE" LLVM=1 LLVM_IAS=1 ${CC_ADDITION_FLAGS} O="$OUT" -j"${THREAD}"
          END_SEC="$(date +%s)"
          COST_SEC=$(( END_SEC - START_SEC ))
          echo "â±  Kernel Build Costed $((COST_SEC/60))min $((COST_SEC%60))s"
      - name: Flag build done
        id: flag
        run: |
          echo "BUILD_DONE=true" >> $GITHUB_OUTPUT
      - name: Upload compile snapshot
        uses: actions/upload-artifact@v4
        with:
          name: compile-out
          path: |
            out
            ../out
          if-no-files-found: ignore
          retention-days: 3

  link_dtb_04c:
    name: 04c Â· Link DTBï¼ˆæ‹¼æ¥ dtbï¼‰
    runs-on: ubuntu-latest
    needs: [fetch_02, compile_04b]
    if: ${{ inputs.operation == 'cleanbuild' || inputs.operation == 'all' }}
    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4
      - name: Link all dtb files (strict from build.sh)
        shell: bash
        working-directory: ${{ needs.fetch_02.outputs.kernel_dir }}
        env:
          OUT: ../out
        run: |
          set -euo pipefail
          echo "--- Linking DTB files ---"
          find "$OUT/arch/arm64/boot/dts/vendor/qcom" -name '*.dtb' -exec cat {} + > "$OUT/arch/arm64/boot/dtb"

  package_ak3_04d:
    name: 04d Â· æ‰“åŒ… AnyKernel3 åˆ·å†™åŒ…
    runs-on: ubuntu-latest
    needs: [fetch_02, derive_vars_03, prebuild_04a]
    if: ${{ inputs.operation == 'cleanbuild' || inputs.operation == 'all' || inputs.operation == 'flashable' }}
    outputs:
      FLASH_ZIP_PATH: ${{ steps.pkg.outputs.FLASH_ZIP_PATH }}
    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4
      - name: Package AK3 (strict from build.sh)
        id: pkg
        shell: bash
        working-directory: ${{ needs.fetch_02.outputs.kernel_dir }}
        env:
          OUT: ../out
          TARGET_KERNEL_FILE: arch/arm64/boot/Image
          TARGET_KERNEL_DTB: arch/arm64/boot/dtb
          TARGET_KERNEL_DTBO: arch/arm64/boot/dtbo.img
          TARGET_KERNEL_NAME: Driftwood-Kernel
          CURRENT_TIME: ${{ needs.derive_vars_03.outputs.CURRENT_TIME }}
          TARGET_KERNEL_MOD_VERSION: ${{ needs.derive_vars_03.outputs.TARGET_KERNEL_MOD_VERSION }}
        run: |
          set -euo pipefail
          echo "--- Generating AnyKernel3 package ---"
          cd "$OUT" || { echo "âŒ OUT ç›®å½•ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ‰§è¡Œæ„å»º"; exit 1; }

          DEVICE="${{ inputs.device_codename }}"
          ANYKERNEL_URL="https://codeload.github.com/EndCredits/AnyKernel3/zip/refs/heads/${DEVICE}"
          ANYKERNEL_PATH="AnyKernel3-${DEVICE}"
          ANYKERNEL_FILE="anykernel.zip"

          if [ ! -d "$ANYKERNEL_PATH" ]; then
            echo "Fetching AnyKernel3: $ANYKERNEL_URL"
            curl "$ANYKERNEL_URL" -o "$ANYKERNEL_FILE"
            unzip -o "$ANYKERNEL_FILE"
          else
            echo "AnyKernel3 detected. Skip download."
          fi

          echo "Cleaning old package files ..."
          rm -rf "$ANYKERNEL_PATH/${TARGET_KERNEL_NAME}"*

          echo "Copying kernel artifacts ..."
          if [[ ! -f "$TARGET_KERNEL_FILE" ]]; then
            echo "âŒ æœªæ‰¾åˆ° $TARGET_KERNEL_FILEï¼Œè¯·ç¡®è®¤å·²å®Œæˆç¼–è¯‘æˆ–å·²æœ‰å†å²æ„å»º"
            exit 1
          fi
          cp -r "$TARGET_KERNEL_FILE" "$ANYKERNEL_PATH/"
          cp -r "$TARGET_KERNEL_DTB" "$ANYKERNEL_PATH/" || true
          cp -r "$TARGET_KERNEL_DTBO" "$ANYKERNEL_PATH/" || true

          echo "Zipping ..."
          cd "$ANYKERNEL_PATH"
          ZIP_NAME="${TARGET_KERNEL_NAME}-${CURRENT_TIME}-${TARGET_KERNEL_MOD_VERSION}.zip"
          zip -q -r "${ZIP_NAME}" *
          echo " Target File: $OUT/$ANYKERNEL_PATH/${ZIP_NAME}"
          echo "FLASH_ZIP_PATH=$OUT/$ANYKERNEL_PATH/${ZIP_NAME}" >> $GITHUB_OUTPUT
      - name: Upload AK3 package artifact
        uses: actions/upload-artifact@v4
        with:
          name: flashable-kernel
          path: ${{ steps.pkg.outputs.FLASH_ZIP_PATH }}

  release_05:
    name: 05 Â· å‘å¸ƒ Release
    runs-on: ubuntu-latest
    needs: [derive_vars_03, package_ak3_04d]
    steps:
      - name: Compose tag & name
        id: meta
        run: |
          TAG="driftwood-${{ needs.derive_vars_03.outputs.CURRENT_TIME }}-${{ needs.derive_vars_03.outputs.TARGET_KERNEL_MOD_VERSION }}"
          NAME="Driftwood Kernel ${{ inputs.device_codename }} ${{ needs.derive_vars_03.outputs.CURRENT_TIME }}"
          echo "TAG_NAME=${TAG}" >> $GITHUB_ENV
          echo "RELEASE_NAME=${NAME}" >> $GITHUB_ENV
      - name: Create GitHub Release & upload asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: ${{ env.RELEASE_NAME }}
          body: |
            Operation: `${{ inputs.operation }}`  
            Device: `${{ inputs.device_codename }}`  
            Kernel repo: `${{ inputs.kernel_repo_url }}`  
            Defconfig: `${{ inputs.defconfig_path }}`  
            Local version: `${{ needs.derive_vars_03.outputs.LOCAL_VERSION_NUMBER }}`  
            Kernel mod version: `${{ needs.derive_vars_03.outputs.TARGET_KERNEL_MOD_VERSION }}`  
          files: ${{ needs.package_ak3_04d.outputs.FLASH_ZIP_PATH }}
          draft: "false"
          prerelease: "false"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary_06:
    name: 06 Â· æ±‡æ€»
    runs-on: ubuntu-latest
    needs: [prep_01, fetch_02, derive_vars_03, prebuild_04a, prebuild_apply_lxc_04a2, compile_04b, link_dtb_04c, package_ak3_04d, release_05]
    steps:
      - name: Final summary
        run: |
          echo "âœ… å®Œæˆã€‚"
          echo "Operation=${{ inputs.operation }} | noksu=${{ inputs.noksu }}"
          echo "Kernel repo=${{ inputs.kernel_repo_url }}"
          echo "Device=${{ inputs.device_codename }}"
          echo "Defconfig=${{ inputs.defconfig_path }}"
          echo "Version=${{ needs.derive_vars_03.outputs.LOCAL_VERSION_NUMBER }}"
          echo "ModVersion=${{ needs.derive_vars_03.outputs.TARGET_KERNEL_MOD_VERSION }}"
