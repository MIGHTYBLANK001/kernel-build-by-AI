
name: Build Android Kernel (LLVM) + LXC Patches + AnyKernel3 + Release

on:
  workflow_dispatch:
    inputs:
      kernel_repo_url: https://github.com/august-aosp/android_kernel_xiaomi_sm7250
        description: "å†…æ ¸æºç ä»“åº“åœ°å€ï¼ˆä¾‹å¦‚ https://github.com/<org>/<repo>.gitï¼‰"
        required: true
        type: string
      kernel_branch: stable
        description: "å†…æ ¸æºç åˆ†æ”¯æˆ–æ ‡ç­¾ï¼ˆé»˜è®¤ mainï¼‰"
        required: true
        type: string
      device_codename: picasso
        description: "æœºå‹ä»£å·ï¼ˆä¾‹å¦‚ 'beryllium'ã€'xaga' ç­‰ï¼‰"
        required: true
        type: string
      defconfig_path: vendor/picasso_defconfig
        description: "defconfig è·¯å¾„æˆ–æ–‡ä»¶åï¼ˆå¦‚ 'arch/arm64/configs/<codename>_defconfig' æˆ– '<codename>_defconfig'ï¼‰"
        required: true
        type: string
      arch:
        description: "ç¼–è¯‘æ¶æ„ï¼ˆé»˜è®¤ arm64ï¼‰"
        required: false
        default: "arm64"
        type: string
      llvm_version:
        description: "LLVM/Clang ä¸»ç‰ˆæœ¬ï¼ˆé»˜è®¤ 20ï¼Œå¯é€‰ 19/18â€¦ï¼‰"
        required: false
        default: "20"
        type: string
      anykernel3_repo:
        description: "AnyKernel3 ä»“åº“ï¼ˆé»˜è®¤ osm0sis/AnyKernel3ï¼‰"
        required: false
        default: "https://github.com/osm0sis/AnyKernel3.git"
        type: string
      anykernel3_branch:
        description: "AnyKernel3 åˆ†æ”¯ï¼ˆé»˜è®¤ masterï¼‰"
        required: false
        default: "master"
        type: string
      release_tag:
        description: "å‘å¸ƒç”¨çš„æ ‡ç­¾ï¼ˆé»˜è®¤ auto-ç”Ÿæˆï¼šak3-<device>-<date>ï¼‰"
        required: false
        default: ""
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v5

      - name: Show inputs
        run: |
          echo "kernel_repo_url=${{ inputs.kernel_repo_url }}"
          echo "kernel_branch=${{ inputs.kernel_branch }}"
          echo "device_codename=${{ inputs.device_codename }}"
          echo "defconfig_path=${{ inputs.defconfig_path }}"
          echo "arch=${{ inputs.arch }}"
          echo "llvm_version=${{ inputs.llvm_version }}"
          echo "anykernel3_repo=${{ inputs.anykernel3_repo }}"
          echo "anykernel3_branch=${{ inputs.anykernel3_branch }}"

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison flex \
            build-essential git curl wget zip unzip patch \
            libssl-dev libelf-dev \
            python3 rsync ccache \
            dwarves lz4 llvm \
            e2fsprogs util-linux

      - name: Install specific LLVM/Clang via apt.llvm.org
        run: |
          set -eux
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${{ inputs.llvm_version }}
          clang-${{ inputs.llvm_version }} --version || true
          ld.lld-${{ inputs.llvm_version }} --version || true

      - name: Clone kernel source
        run: |
          set -eux
          git clone --depth=1 -b "${{ inputs.kernel_branch }}" "${{ inputs.kernel_repo_url }}" kernel-src

      - name: Resolve defconfig path
        id: defcfg
        working-directory: kernel-src
        run: |
          set -eux
          DF_IN="${{ inputs.defconfig_path }}"
          ARCH_IN="${{ inputs.arch }}"
          DF_TARGET="$(basename "$DF_IN")"
          if [ -f "$DF_IN" ]; then
            DF_PATH="$DF_IN"
          else
            DF_PATH="arch/${ARCH_IN}/configs/${DF_TARGET}"
          fi
          echo "DF_TARGET=${DF_TARGET}" >> "$GITHUB_OUTPUT"
          echo "DF_PATH=${DF_PATH}"     >> "$GITHUB_OUTPUT"

      #####################################################################
      # æ–°å¢ï¼šåˆ›å»º 10G å·¥ä½œç©ºé—´ï¼ˆloopback ext4 æŒ‚è½½ï¼‰ï¼Œç”¨äº O= è¾“å‡ºç›®å½•
      #####################################################################
      - name: Prepare 10G build workspace (loopback ext4)
        id: ws
        run: |
          set -eux
          sudo mkdir -p /mnt/workspace
          # 10G ç¨€ç–é•œåƒæ–‡ä»¶
          sudo dd if=/dev/zero of=/mnt/workspace.img bs=1M count=0 seek=10240
          sudo mkfs.ext4 -F /mnt/workspace.img
          sudo mount -o loop /mnt/workspace.img /mnt/workspace
          sudo chown $USER:$USER /mnt/workspace
          mkdir -p /mnt/workspace/out
          echo "O_OUT=/mnt/workspace/out" >> "$GITHUB_OUTPUT"

      #####################################################################
      # æ–°å¢ï¼šä¸‹è½½å¹¶åº”ç”¨ LXC è¡¥ä¸
      #####################################################################
      - name: Fetch LXC_utils.zip
        working-directory: kernel-src
        run: |
          set -eux
          mkdir -p Patchs
          # ä»ä½ æä¾›çš„åœ°å€ä¸‹è½½è¡¥ä¸åŒ…
          wget -O Patchs/LXC_utils.zip \
            "https://raw.githubusercontent.com/MIGHTYBLANK001/kernel-build-by-AI/refs/heads/main/Patchs/LXC_utils.zip"
          ls -l Patchs/LXC_utils.zip

      - name: Apply LXC patches (enable Docker, qtaguid, runcpatch)
        working-directory: kernel-src
        env:
          TARGET_DEVICE: ${{ inputs.device_codename }}
          DF_PATH: ${{ steps.defcfg.outputs.DF_PATH }}
          ARCH: ${{ inputs.arch }}
        run: |
          set -euo pipefail
          echo "ğŸ”§ æ­£åœ¨ä¸ºå†…æ ¸å®‰è£… LXC è¡¥ä¸..."

          # è§£å‹è‡³ utils/
          if [ ! -f "Patchs/LXC_utils.zip" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ° Patchs/LXC_utils.zipï¼Œè·³è¿‡ LXC è¡¥ä¸æ­¥éª¤ã€‚" >&2
            exit 0
          fi
          rm -rf utils && unzip -o Patchs/LXC_utils.zip -d utils

          # å°† utils/Kconfig å¼•å…¥ä¸» Kconfig
          if ! grep -q 'source "utils/Kconfig"' Kconfig; then
            echo 'source "utils/Kconfig"' >> Kconfig
          fi

          DEFCONFIG_FILE="$DF_PATH"
          if [ ! -f "$DEFCONFIG_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° defconfig æ–‡ä»¶ï¼š$DEFCONFIG_FILE" >&2
            exit 1
          fi

          # å¼€å¯ Dockerï¼›å…³é—­ ANDROID_PARANOID_NETWORK
          if ! grep -q '^CONFIG_DOCKER=y' "$DEFCONFIG_FILE"; then
            echo "CONFIG_DOCKER=y" >> "$DEFCONFIG_FILE"
          fi
          sed -i '/CONFIG_ANDROID_PARANOID_NETWORK/d' "$DEFCONFIG_FILE"
          echo "# CONFIG_ANDROID_PARANOID_NETWORK is not set" >> "$DEFCONFIG_FILE"

          # runcpatchï¼šä¸¤ä¸ªå¸¸è§è·¯å¾„éƒ½å°è¯•
          chmod +x utils/runcpatch.sh
          [ -f kernel/cgroup/cgroup.c ] && sh utils/runcpatch.sh kernel/cgroup/cgroup.c || true
          [ -f kernel/cgroup.c ]       && sh utils/runcpatch.sh kernel/cgroup.c       || true

          # xt_qtaguid è¡¥ä¸ï¼ˆå­˜åœ¨åˆ™å°è¯•åº”ç”¨ï¼›å¤±è´¥ä¸è‡´å‘½ï¼‰
          if [ -f net/netfilter/xt_qtaguid.c ] && [ -f utils/xt_qtaguid.patch ]; then
            patch -p0 < utils/xt_qtaguid.patch || true
          fi
          echo "âœ… LXC è¡¥ä¸å®‰è£…å®Œæˆï¼"

      - name: Build kernel (LLVM=${{ inputs.llvm_version }})
        working-directory: kernel-src
        run: |
          set -eux
          export ARCH="${{ inputs.arch }}"
          export SUBARCH="${{ inputs.arch }}"
          # ä½¿ç”¨ 10G å·¥ä½œç©ºé—´ä½œä¸º O= è¾“å‡ºç›®å½•
          make O="${{ steps.ws.outputs.O_OUT }}" ARCH="${ARCH}" LLVM=-${{ inputs.llvm_version }} "${{ steps.defcfg.outputs.DF_TARGET }}"
          make -j"$(nproc)" O="${{ steps.ws.outputs.O_OUT }}" ARCH="${ARCH}" LLVM=-${{ inputs.llvm_version }}

      - name: Build modules (optional)
        working-directory: kernel-src
        run: |
          set -eux
          export ARCH="${{ inputs.arch }}"
          make -j"$(nproc)" O="${{ steps.ws.outputs.O_OUT }}" ARCH="${ARCH}" LLVM=-${{ inputs.llvm_version }} modules || true

      - name: Locate kernel images
        id: locateimg
        working-directory: kernel-src
        run: |
          set -eux
          ARCH_DIR="${{ steps.ws.outputs.O_OUT }}/arch/${{ inputs.arch }}/boot"
          KIMG=$(ls ${ARCH_DIR}/Image*.lz4-dtb ${ARCH_DIR}/Image*.gz-dtb ${ARCH_DIR}/Image*-dtb ${ARCH_DIR}/Image.gz ${ARCH_DIR}/Image 2>/dev/null | head -n 1 || true)
          DTBO=$(ls ${ARCH_DIR}/dtbo.img 2>/dev/null || true)
          if [ -z "$KIMG" ]; then
            echo "No kernel image found under ${ARCH_DIR}" >&2
            exit 1
          fi
          echo "KIMG=$KIMG" >> $GITHUB_OUTPUT
          echo "DTBO=$DTBO" >> $GITHUB_OUTPUT

      - name: Clone AnyKernel3
        run: |
          set -eux
          git clone --depth=1 -b "${{ inputs.anykernel3_branch }}" "${{ inputs.anykernel3_repo }}" AnyKernel3

      - name: Prepare AnyKernel3 payload
        run: |
          set -eux
          cp "kernel-src/${{ steps.locateimg.outputs.KIMG }}" AnyKernel3/
          if [ -n "${{ steps.locateimg.outputs.DTBO }}" ]; then
            cp "kernel-src/${{ steps.locateimg.outputs.DTBO }}" AnyKernel3/
          fi
          if [ -d "${{ steps.ws.outputs.O_OUT }}/lib/modules" ]; then
            mkdir -p AnyKernel3/modules
            rsync -a "${{ steps.ws.outputs.O_OUT }}/lib/modules/" AnyKernel3/modules/ || true
          fi

      - name: Patch anykernel.sh
        working-directory: AnyKernel3
        run: |
          set -eux
          if grep -q '^kernel.string=' anykernel.sh; then
            sed -i "s|^kernel.string=.*|kernel.string=Kernel for ${{ inputs.device_codename }} (LLVM ${{ inputs.llvm_version }})|" anykernel.sh
          else
            sed -i "1ikernel.string=Kernel for ${{ inputs.device_codename }} (LLVM ${{ inputs.llvm_version }})" anykernel.sh
          fi
          if grep -q '^device.name1=' anykernel.sh; then
            sed -i "s|^device.name1=.*|device.name1=${{ inputs.device_codename }}|" anykernel.sh
          else
            sed -i "1idevice.name1=${{ inputs.device_codename }}" anykernel.sh
          fi

      - name: Make flashable ZIP
        id: makezip
        working-directory: AnyKernel3
        run: |
          set -eux
          DATESTR="$(date +%Y%m%d-%H%M)"
          ZIPNAME="AK3-${{ inputs.device_codename }}-${DATESTR}.zip"
          zip -r9 "../${ZIPNAME}" .
          echo "ZIPPATH=${ZIPNAME}" >> $GITHUB_OUTPUT

      - name: Create Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag != '' && inputs.release_tag || format('ak3-{0}-{1}', inputs.device_codename, steps.makezip.outputs.ZIPPATH) }}
          name: "AnyKernel3 for ${{ inputs.device_codename }} (LLVM ${{ inputs.llvm_version }})"
          body: |
            - Device: ${{ inputs.device_codename }}
            - Kernel repo: ${{ inputs.kernel_repo_url }} @ ${{ inputs.kernel_branch }}
            - Defconfig: ${{ inputs.defconfig_path }}
            - Arch: ${{ inputs.arch }}
            - Toolchain: LLVM/Clang ${{ inputs.llvm_version }} via apt.llvm.org
            - LXC patches: Docker enabled, runcpatch applied, xt_qtaguid patched (if present)
            - Build workspace: 10G loopback ext4 mounted at /mnt/workspace
            - Built at: ${{ env.TZ }}
          draft: false
          prerelease: false
          files: |
            AnyKernel3/${{ steps.makezip.outputs.ZIPPATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ï¼ˆå¯é€‰æ¸…ç†ï¼‰å¸è½½å·¥ä½œç©ºé—´ï¼Œé‡Šæ”¾é•œåƒæ–‡ä»¶
      - name: Cleanup build workspace
        if: always()
        run: |
          set -eux
          sudo umount /mnt/workspace || true
          sudo rm -f /mnt/workspace.img || true
