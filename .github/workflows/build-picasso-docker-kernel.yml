
name: Build kernel (picasso/AOSP) – universal LLVM toolchain + auto-fallback (no KernelSU)

on:
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: "要构建的分支；留空=默认分支"
        default: ""
        required: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      TARGET_DEVICE: picasso
      BUILD_AOSP: "1"
      TOOLCHAIN_ROOT: ${{ github.workspace }}/../aosp-clang

    steps:
      # 1) 检出工作流仓库
      - name: Checkout workflow repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2) 检出目标内核源码
      - name: Checkout target kernel (specific branch)
        if: ${{ inputs.kernel_branch != '' }}
        uses: actions/checkout@v4
        with:
          repository: august-aosp/android_kernel_xiaomi_sm7250
          ref: ${{ inputs.kernel_branch }}
          path: kernel-src
          fetch-depth: 1

      - name: Checkout target kernel (default branch)
        if: ${{ inputs.kernel_branch == '' }}
        uses: actions/checkout@v4
        with:
          repository: august-aosp/android_kernel_xiaomi_sm7250
          path: kernel-src
          fetch-depth: 1

      - name: Clean working tree
        working-directory: kernel-src
        shell: bash
        run: |
          git reset --hard HEAD
          git clean -fd

      # 3) 安装依赖（包含 GNU binutils；不安装 ccache）
      - name: Install build dependencies
        shell: bash
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y \
            bc bison flex libssl-dev \
            zip unzip git patch curl \
            build-essential make \
            binutils-aarch64-linux-gnu binutils-arm-linux-gnueabi

      # 4) 拉取 AOSP Clang 预编译（统一版本）
      - name: Fetch AOSP Clang prebuilts (clang-r547379)
        shell: bash
        run: |
          set -e
          mkdir -p "${TOOLCHAIN_ROOT}"
          git clone --depth=1 https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 "${TOOLCHAIN_ROOT}/repo"
          TOOLCHAIN_PATH="${TOOLCHAIN_ROOT}/repo/clang-r547379/bin"
          echo "TOOLCHAIN_PATH=${TOOLCHAIN_PATH}" >> "$GITHUB_ENV"
          echo "PATH=$PATH:${TOOLCHAIN_PATH}"     >> "$GITHUB_ENV"

      - name: Show selected toolchain versions
        shell: bash
        run: |
          which clang || true; clang --version || true
          which ld.lld || true; ld.lld --version || true

      # 5) AnyKernel3
      - name: Prepare AnyKernel3
        working-directory: kernel-src
        shell: bash
        run: |
          set -e
          rm -rf out/ anykernel/
          git clone --depth=1 https://github.com/liyafe1997/AnyKernel3 -b kona anykernel

      # 6) 给 defconfig 打版本戳（仅字符串）
      - name: Stamp local version in defconfig
        working-directory: kernel-src
        shell: bash
        run: |
          set -e
          GIT_COMMIT_ID="$(git rev-parse --short=8 HEAD)"
          sed -i "s/-perf/-$(date +%Y%m%d)-${GIT_COMMIT_ID}-perf/g" arch/arm64/configs/vendor/picasso_defconfig

      # 7) 动态移除 KernelSU 引用（保持不含 KernelSU）
      - name: Drop KernelSU from Kconfig/defconfig (no kernelsu)
        working-directory: kernel-src
        shell: bash
        run: |
          set -e
          if [[ -f drivers/Kconfig ]]; then
            sed -i 's|^[[:space:]]*source[[:space:]]*"drivers/kernelsu/Kconfig"[[:space:]]*$||' drivers/Kconfig || true
          fi
          if [[ -f arch/arm64/configs/vendor/picasso_defconfig ]]; then
            sed -i '/^CONFIG_KERNELSU/d' arch/arm64/configs/vendor/picasso_defconfig || true
            sed -i '/^CONFIG_KERNEL_SU/d' arch/arm64/configs/vendor/picasso_defconfig || true
            sed -i '/^CONFIG_KSU/d'       arch/arm64/configs/vendor/picasso_defconfig || true
          fi


      # 9) 生成 defconfig（使用 LLVM=1；Host 使用系统 gcc/g++）
      - name: make vendor/picasso_defconfig (LLVM=1)
        working-directory: kernel-src
        shell: bash
        run: |
          set -e
          make LLVM=1 O=out ARCH=arm64 SUBARCH=arm64 \
               HOSTCC=gcc HOSTCXX=g++ \
               vendor/picasso_defconfig

      # 10) 精简调试选项（提速） + olddefconfig（不再用 yes 管道）
      - name: Speed-focused config tuning
        working-directory: kernel-src
        shell: bash
        run: |
          set -e
          scripts/config --file out/.config \
            -d DEBUG_INFO \
            -d GDB_SCRIPTS \
            -d DEBUG_KERNEL
          make LLVM=1 O=out ARCH=arm64 SUBARCH=arm64 olddefconfig

      # 11) 容器内核项校验（moby）
      - name: Verify Docker/LXC requirements via moby check-config.sh
        working-directory: kernel-src
        shell: bash
        run: |
          set -e
          curl -fsSL https://raw.githubusercontent.com/moby/moby/master/contrib/check-config.sh -o /tmp/check-config.sh
          chmod +x /tmp/check-config.sh
          /tmp/check-config.sh out/.config

      # 12) 编译：先 LLVM_IAS=1；失败则自动降级 LLVM_IAS=0 + GNU binutils
      - name: Build kernel (universal toolchain with auto-fallback)
        working-directory: kernel-src
        shell: bash
        run: |
          set -euo pipefail

          echo ">>> Attempt 1: LLVM=1 (integrated assembler ON)"
          if make LLVM=1 O=out ARCH=arm64 SUBARCH=arm64 -j"$(nproc)" 2>&1 | tee out/build_attempt1.log; then
            echo "✅ Build OK on attempt 1"
          else
            echo "⚠️ Attempt 1 failed. Retrying with LLVM_IAS=0 + GNU binutils ..."
            # 清理最小化（避免残留）
            make O=out ARCH=arm64 SUBARCH=arm64 clean

            # 注意：当 LLVM_IAS=0 时，需要提供 CROSS_COMPILE 前缀找到非集成汇编器/objcopy 等（官方建议）：
            # https://docs.kernel.org/kbuild/llvm.html
            if make LLVM=1 LLVM_IAS=0 \
                    O=out ARCH=arm64 SUBARCH=arm64 \
                    CROSS_COMPILE=aarch64-linux-gnu- \
                    CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
                    -j"$(nproc)" 2>&1 | tee out/build_attempt2.log; then
              echo "✅ Build OK on attempt 2 (LLVM_IAS=0 + GNU binutils)"
            else
              echo "::error::Build failed on both attempts. See logs in out/."
              exit 1
            fi
          fi

          [[ -f out/arch/arm64/boot/Image ]] || { echo "::error::未生成 out/arch/arm64/boot/Image"; exit 1; }

      - name: Upload build logs & config (always)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-universal-${{ github.run_id }}
          path: |
            kernel-src/out/build_attempt1.log
            kernel-src/out/build_attempt2.log
            kernel-src/out/.config
          if-no-files-found: warn

      # 13) 生成 dtb
      - name: Generate dtb
        working-directory: kernel-src
        shell: bash
        run: |
          set -e
          find out/arch/arm64/boot/dts -name '*.dtb' -exec cat {} + > out/arch/arm64/boot/dtb

      # 14) 打包 AnyKernel3 刷写包
      - name: Pack AnyKernel3 zip
        working-directory: kernel-src
        shell: bash
        run: |
          set -e
          rm -rf anykernel/kernels/ && mkdir -p anykernel/kernels/
          cp out/arch/arm64/boot/Image anykernel/kernels/
          cp out/arch/arm64/boot/dtb    anykernel/kernels/
          GIT_COMMIT_ID="$(git rev-parse --short=8 HEAD)"
          ZIP_FILENAME="Kernel_AOSP_${TARGET_DEVICE}_UniversalLLVM_$(date +%Y%m%d_%H%M%S)_anykernel3_${GIT_COMMIT_ID}.zip"
          (cd anykernel && zip -r9 "${ZIP_FILENAME}" ./* -x .git .gitignore out/ ./*.zip)
          mv anykernel/"${ZIP_FILENAME}" .
          echo "ZIP_FILENAME=${ZIP_FILENAME}" >> "$GITHUB_ENV"

      - name: Restore defconfig local version string
        working-directory: kernel-src
        shell: bash
        run: |
          git restore --source=HEAD -- arch/arm64/configs/vendor/picasso_defconfig || true

      # 15) 上传制品
      - name: Upload artifacts (zip, Image, dtb)
        uses: actions/upload-artifact@v4
        with:
          name: kernel-universal-${{ github.run_id }}
          path: |
            kernel-src/${{ env.ZIP_FILENAME }}
            kernel-src/out/arch/arm64/boot/Image
            kernel-src/out/arch/arm64/boot/dts/**/*.dtb
          if-no-files-found: warn

      # 16) 打 tag + 发布到 Release（与之前一致）
      - name: Create & push tag
        shell: bash
        run: |
          set -e
          git config user.name  "github-actions"
          git config user.email "github-actions@github.com"
          TAG="picasso-aosp-universal-${{ github.run_id }}-${{ github.run_number }}"
          git tag  "${TAG}"
          git push origin "${TAG}"

      - name: Create GitHub Release & upload AnyKernel ZIP
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            kernel-src/${{ env.ZIP_FILENAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
