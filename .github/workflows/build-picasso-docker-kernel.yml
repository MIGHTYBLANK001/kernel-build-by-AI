
name: Build kernel (picasso/AOSP) – fast workflow + release (fix host ld & explicit target toolchain)

on:
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: "要构建的分支；留空则使用默认分支"
        default: ""
        required: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      TARGET_DEVICE: picasso
      BUILD_AOSP: "1"
      TOOLCHAIN_ROOT: ${{ github.workspace }}/../proton-clang
      TOOLCHAIN_VERSION: "20210522"
      TOOLCHAIN_PATH: ${{ github.workspace }}/../proton-clang/proton-clang-20210522/bin
      CCACHE_DIR: $HOME/.cache/ccache_picasso
      CCACHE_BASEDIR: ${{ github.workspace }}/kernel-src

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Prepare safe names
        id: names
        shell: bash
        run: |
          set -e
          SAFE_REPO="august-aosp-android_kernel_xiaomi_sm7250"
          KBRANCH="${{ inputs.kernel_branch }}"
          [[ -z "${KBRANCH}" ]] && KBRANCH="default"
          echo "safe_repo=${SAFE_REPO}"  >> "$GITHUB_OUTPUT"
          echo "safe_branch=${KBRANCH}" >> "$GITHUB_OUTPUT"

      # 缓存 Proton Clang（避免每次克隆）
      - name: Cache Proton Clang
        id: clangcache
        uses: actions/cache@v4
        with:
          path: ${{ env.TOOLCHAIN_ROOT }}
          key: proton-clang-${{ env.TOOLCHAIN_VERSION }}
          restore-keys: |
            proton-clang-

      - name: Fetch Proton Clang (if cache missed)
        if: steps.clangcache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          set -e
          mkdir -p "${TOOLCHAIN_ROOT}"
          git clone --depth=1 --branch "${TOOLCHAIN_VERSION}" https://github.com/kdrag0n/proton-clang \
            "${TOOLCHAIN_ROOT}/proton-clang-${TOOLCHAIN_VERSION}"
          # Proton Clang 说明：LLVM/Clang 工具链，包含 binutils，且采用 LTO/PGO 优化编译时长。[5](https://github.com/liyafe1997/AnyKernel3)

      # **关键修正**：不要前置 PATH；改为追加到末尾，并显式导出目标工具链变量
      - name: Configure toolchains (keep system ld for host; explicit target tool paths)
        shell: bash
        run: |
          set -e
          # 追加，不要覆盖系统 /usr/bin/ld
          echo "PATH=$PATH:${TOOLCHAIN_PATH}"    >> "$GITHUB_ENV"

          # 目标内核使用的 Clang/LLD/LLVM 工具（显式设置，避免 PATH 影响）
          echo "CC=${TOOLCHAIN_PATH}/clang"       >> "$GITHUB_ENV"
          echo "LD=${TOOLCHAIN_PATH}/ld.lld"      >> "$GITHUB_ENV"
          echo "AR=${TOOLCHAIN_PATH}/llvm-ar"     >> "$GITHUB_ENV"
          echo "NM=${TOOLCHAIN_PATH}/llvm-nm"     >> "$GITHUB_ENV"
          echo "OBJCOPY=${TOOLCHAIN_PATH}/llvm-objcopy" >> "$GITHUB_ENV"
          echo "STRIP=${TOOLCHAIN_PATH}/llvm-strip"     >> "$GITHUB_ENV"

          # 主机侧始终用系统编译器/链接器构建 fixdep 等（避免旧 ld 不支持 .relr.dyn）
          echo "HOSTCC=gcc"                       >> "$GITHUB_ENV"
          echo "HOSTCXX=g++"                      >> "$GITHUB_ENV"
          echo "HOSTLDFLAGS="                     >> "$GITHUB_ENV"   # 可按需追加主机链接标志
          # 参考：Kbuild 对 HOSTCC/HOSTCFLAGS/HOSTLDFLAGS 的定义。[6](https://docs.kernel.org/kbuild/kbuild.html)

      - name: Show host & target toolchain versions
        shell: bash
        run: |
          which cc      || true; cc      --version || true
          which gcc     || true; gcc     --version || true
          which ld      || true; ld      --version  || true
          which clang   || true; clang   --version  || true
          which ld.lld  || true; ld.lld  --version  || true
          echo "CC=${CC}"; echo "LD=${LD}"

      - name: Install build dependencies
        shell: bash
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y \
            bc bison flex libssl-dev \
            zip unzip git patch curl \
            build-essential make \
            ccache \
            binutils-aarch64-linux-gnu binutils-arm-linux-gnueabi
          echo "PATH=/usr/lib/ccache:$PATH" >> "$GITHUB_ENV"

      # ccache：提升命中率与压缩性能
      - name: Enable ccache cache (optimized)
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ github.job }}-${{ steps.names.outputs.safe_repo }}-${{ steps.names.outputs.safe_branch }}-picasso-aosp
          restore-keys: |
            ${{ github.job }}-${{ steps.names.outputs.safe_repo }}-
            ${{ github.job }}-
          max-size: 4G
          create-symlink: true
          job-summary: "CCache 统计"

      - name: Configure ccache knobs
        shell: bash
        run: |
          echo "CCACHE_DIR=${CCACHE_DIR}"                     >> "$GITHUB_ENV"
          echo "CCACHE_BASEDIR=${CCACHE_BASEDIR}"             >> "$GITHUB_ENV"
          echo "CCACHE_COMPRESS=true"                         >> "$GITHUB_ENV"
          echo "CCACHE_COMPRESSLEVEL=5"                       >> "$GITHUB_ENV"
          echo "CCACHE_SLOPPINESS=time_macros,file_stat"      >> "$GITHUB_ENV"
          echo "CCACHE_MAXSIZE=4G"                            >> "$GITHUB_ENV"
          echo "PATH=/usr/lib/ccache:$PATH"                   >> "$GITHUB_ENV"

      # 检出目标内核源码
      - name: Checkout target kernel repo (specific branch) to kernel-src
        if: ${{ inputs.kernel_branch != '' }}
        uses: actions/checkout@v4
        with:
          repository: august-aosp/android_kernel_xiaomi_sm7250
          ref: ${{ inputs.kernel_branch }}
          path: kernel-src
          fetch-depth: 1
          submodules: false

      - name: Checkout target kernel repo (default branch) to kernel-src
        if: ${{ inputs.kernel_branch == '' }}
        uses: actions/checkout@v4
        with:
          repository: august-aosp/android_kernel_xiaomi_sm7250
          path: kernel-src
          fetch-depth: 1
          submodules: false

      - name: Clean working tree
        working-directory: kernel-src
        shell: bash
        run: |
          git reset --hard HEAD
          git clean -fd

      - name: Preflight checks (vendor/picasso_defconfig)
        working-directory: kernel-src
        shell: bash
        run: |
          set -e
          if [[ ! -f "arch/arm64/configs/vendor/picasso_defconfig" ]]; then
            echo "::error::未找到 defconfig: arch/arm64/configs/vendor/picasso_defconfig"
            ls arch/arm64/configs/vendor/*_defconfig || true
            exit 1
          fi

      - name: Apply LXC patches from remote
        working-directory: kernel-src
        shell: bash
        run: |
          set -e
          curl -fsSL "https://raw.githubusercontent.com/MIGHTYBLANK001/kernel-build-by-AI/refs/heads/main/Patchs/LXC_utils.zip" -o /tmp/LXC_utils.zip
          [[ -s /tmp/LXC_utils.zip ]] || { echo "::error::LXC_utils.zip 下载失败"; exit 1; }

          rm -rf utils && unzip -o /tmp/LXC_utils.zip -d utils
          if ! grep -q 'source "utils/Kconfig"' Kconfig; then
            echo 'source "utils/Kconfig"' >> Kconfig
          fi

          DEFCONFIG="arch/arm64/configs/vendor/picasso_defconfig"
          if ! grep -q '^CONFIG_DOCKER=y' "${DEFCONFIG}"; then
            echo "CONFIG_DOCKER=y" >> "${DEFCONFIG}"
          fi
          sed -i '/CONFIG_ANDROID_PARANOID_NETWORK/d' "${DEFCONFIG}"
          echo "# CONFIG_ANDROID_PARANOID_NETWORK is not set" >> "${DEFCONFIG}"

          chmod +x utils/runcpatch.sh
          [[ -f kernel/cgroup/cgroup.c ]] && sh utils/runcpatch.sh kernel/cgroup/cgroup.c
          [[ -f kernel/cgroup.c       ]] && sh utils/runcpatch.sh kernel/cgroup.c

          if [[ -f net/netfilter/xt_qtaguid.c && -f utils/xt_qtaguid.patch ]]; then
            patch -p0 < utils/xt_qtaguid.patch || true
          fi

      - name: Prepare AnyKernel3
        working-directory: kernel-src
        shell: bash
        run: |
          set -e
          rm -rf out/ anykernel/
          git clone --depth=1 https://github.com/liyafe1997/AnyKernel3 -b kona anykernel

      - name: Stamp local version in defconfig (vendor/picasso_defconfig)
        working-directory: kernel-src
        shell: bash
        run: |
          set -e
          GIT_COMMIT_ID="$(git rev-parse --short=8 HEAD)"
          sed -i "s/-perf/-$(date +%Y%m%d)-${GIT_COMMIT_ID}-perf/g" arch/arm64/configs/vendor/picasso_defconfig

      # **注意**：此处 make 会构建 host 工具（fixdep），我们已强制 HOSTCC=gcc 并避免覆盖系统 ld
      - name: make vendor/picasso_defconfig (host uses system ld)
        working-directory: kernel-src
        shell: bash
        run: |
          make O=out ARCH=arm64 SUBARCH=arm64 \
               CC="${CC}" LD="${LD}" AR="${AR}" NM="${NM}" OBJCOPY="${OBJCOPY}" STRIP="${STRIP}" \
               HOSTCC="${HOSTCC}" HOSTCXX="${HOSTCXX}" \
               CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- CROSS_COMPILE_COMPAT=arm-linux-gnueabi- \
               CLANG_TRIPLE=aarch64-linux-gnu- \
               vendor/picasso_defconfig

      # 关闭昂贵的调试项（减少编译时间/体积）
      - name: Speed-focused config tuning
        working-directory: kernel-src
        shell: bash
        run: |
          set -e
          scripts/config --file out/.config \
            -d DEBUG_INFO \
            -d GDB_SCRIPTS \
            -d DEBUG_KERNEL
          yes "" | make O=out ARCH=arm64 SUBARCH=arm64 olddefconfig

      # Docker/LXC 必要项校验（moby 官方脚本）
      - name: Verify Docker/LXC requirements via moby check-config.sh
        working-directory: kernel-src
        shell: bash
        run: |
          set -e
          curl -fsSL https://raw.githubusercontent.com/moby/moby/master/contrib/check-config.sh -o /tmp/check-config.sh
          chmod +x /tmp/check-config.sh
          /tmp/check-config.sh out/.config
        # Docker/Moby 官方脚本用于容器所需内核配置核验。[8](https://linuxvox.com/blog/kern-log-linux/)

      # **兼容方案**：按头文件实际情况改写 fair.c 的 __state/state 引用，避免 YAML heredoc
      - name: Adapt __state usages to current kernel (no heredoc)
        working-directory: kernel-src
        shell: bash
        run: |
          set -e
          if ! grep -R -q '\b__state\b' include/linux/sched.h; then
            echo "Detected task_struct.state (no __state); rewriting kernel/sched/fair.c ..."
            sed -E -i 's/READ_ONCE\(\s*([[:alnum:]_.]+)->__state\s*\)/READ_ONCE(\1->state)/g' kernel/sched/fair.c
            sed -E -i 's/\b([[:alnum:]_.]+)->__state\b/\1->state/g' kernel/sched/fair.c
          else
            echo "__state field present; no rewrite needed."
          fi
        # 字段差异来自上游在 5.14 左右的迁移，按源码树自动适配更稳妥。[9](https://dev.to/arif_hossain/basic-github-actions-checkout-3588)

      # 编译：保存完整日志
      - name: Build kernel (fast, capture logs)
        working-directory: kernel-src
        shell: bash
        run: |
          set -e
          make O=out ARCH=arm64 SUBARCH=arm64 \
               CC="${CC}" LD="${LD}" AR="${AR}" NM="${NM}" OBJCOPY="${OBJCOPY}" STRIP="${STRIP}" \
               HOSTCC="${HOSTCC}" HOSTCXX="${HOSTCXX}" \
               CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- CROSS_COMPILE_COMPAT=arm-linux-gnueabi- \
               CLANG_TRIPLE=aarch64-linux-gnu- \
               -j"$(nproc)" 2>&1 | tee out/build.log
          [[ -f out/arch/arm64/boot/Image ]] || { echo "::error::未生成 out/arch/arm64/boot/Image（详见 out/build.log）"; exit 1; }
          echo "✅ Build OK: out/arch/arm64/boot/Image"

      - name: Upload build logs & config (always)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ steps.names.outputs.safe_repo }}-${{ steps.names.outputs.safe_branch }}-picasso-aosp-${{ github.run_id }}
          path: |
            kernel-src/out/build.log
            kernel-src/out/.config
            kernel-src/.config
          if-no-files-found: warn

      - name: Generate dtb (concatenate *.dtb)
        working-directory: kernel-src
        shell: bash
        run: |
          set -e
          find out/arch/arm64/boot/dts -name '*.dtb' -exec cat {} + > out/arch/arm64/boot/dtb

      - name: Pack AnyKernel3 zip
        working-directory: kernel-src
        shell: bash
        run: |
          set -e
          rm -rf anykernel/kernels/ && mkdir -p anykernel/kernels/
          cp out/arch/arm64/boot/Image anykernel/kernels/
          cp out/arch/arm64/boot/dtb    anykernel/kernels/
          GIT_COMMIT_ID="$(git rev-parse --short=8 HEAD)"
          ZIP_FILENAME="Kernel_AOSP_${TARGET_DEVICE}_NoKernelSU_$(date +%Y%m%d_%H%M%S')_anykernel3_${GIT_COMMIT_ID}.zip"
          (cd anykernel && zip -r9 "${ZIP_FILENAME}" ./* -x .git .gitignore out/ ./*.zip)
          mv anykernel/"${ZIP_FILENAME}" .
          echo "ZIP_FILENAME=${ZIP_FILENAME}" >> "$GITHUB_ENV"
          echo "KERNEL_COMMIT=${GIT_COMMIT_ID}" >> "$GITHUB_ENV"

      - name: Restore defconfig local version string
        working-directory: kernel-src
        shell: bash
        run: |
          git restore --source=HEAD -- arch/arm64/configs/vendor/picasso_defconfig || true

      - name: Upload artifacts (zip, Image, dtb)
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ steps.names.outputs.safe_repo }}-${{ steps.names.outputs.safe_branch }}-picasso-aosp-${{ github.run_id }}
          path: |
            kernel-src/${{ env.ZIP_FILENAME }}
            kernel-src/anykernel/kernels/Image
            kernel-src/anykernel/kernels/dtb
            kernel-src/out/arch/arm64/boot/Image
            kernel-src/out/arch/arm64/boot/dts/**/*.dtb
          if-no-files-found: warn

      # 发布到 Release（创建 tag 并上传 AnyKernel ZIP）
      - name: Prepare release tag/name
        id: relmeta
        shell: bash
        run: |
          set -e
          TAG="picasso-aosp-${{ github.run_id }}-${{ github.run_number }}"
          NAME="Kernel AOSP picasso (${TAG}) [kernel commit: ${KERNEL_COMMIT}]"
          echo "tag=${TAG}"  >> "$GITHUB_OUTPUT"
          echo "name=${NAME}" >> "$GITHUB_OUTPUT"

      - name: Create and push tag
        shell: bash
        run: |
          set -e
          git config user.name  "github-actions"
          git config user.email "github-actions@github.com"
          git tag  "${{ steps.relmeta.outputs.tag }}"
          git push origin "${{ steps.relmeta.outputs.tag }}"

      - name: Create GitHub Release & upload AnyKernel ZIP
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.relmeta.outputs.tag }}
          name:     ${{ steps.relmeta.outputs.name }}
          generate_release_notes: true
          files: |
            kernel-src/${{ env.ZIP_FILENAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
