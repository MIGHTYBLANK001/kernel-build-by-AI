
name: Build Android Kernel (LLVM) + LXC Patches + AnyKernel3 + Release

on:
  workflow_dispatch:
    inputs:
      kernel_repo_url:
        description: "å†…æ ¸æºç ä»“åº“åœ°å€"
        required: true
        default: "https://github.com/august-aosp/android_kernel_xiaomi_sm7250"
        type: string
      kernel_branch:
        description: "å†…æ ¸æºç åˆ†æ”¯æˆ–æ ‡ç­¾ï¼ˆé»˜è®¤ mainï¼‰"
        required: true
        default: "stable"
        type: string
      device_codename:
        description: "æœºå‹ä»£å·ï¼ˆä¾‹å¦‚ 'beryllium'ã€'xaga' ç­‰ï¼‰"
        required: true
        default: "picasso"
        type: string
      defconfig_path:
        description: "defconfig è·¯å¾„æˆ–æ–‡ä»¶åï¼ˆå¦‚ 'arch/arm64/configs/<codename>_defconfig' æˆ– '<codename>_defconfig'ï¼‰"
        required: true
        default: "vendor/picasso_defconfig"
        type: string
      arch:
        description: "ç¼–è¯‘æ¶æ„ï¼ˆé»˜è®¤ arm64ï¼‰"
        required: false
        default: "arm64"
        type: string
      llvm_version:
        description: "LLVM/Clang ä¸»ç‰ˆæœ¬ï¼ˆé»˜è®¤ 20ï¼Œå¯é€‰ 19/18â€¦ï¼‰"
        required: false
        default: "20"
        type: string
      anykernel3_repo:
        description: "AnyKernel3 ä»“åº“ï¼ˆé»˜è®¤ osm0sis/AnyKernel3ï¼‰"
        required: false
        default: "https://github.com/osm0sis/AnyKernel3.git"
        type: string
      anykernel3_branch:
        description: "AnyKernel3 åˆ†æ”¯ï¼ˆé»˜è®¤ masterï¼‰"
        required: false
        default: "master"
        type: string
      release_tag:
        description: "å‘å¸ƒç”¨çš„æ ‡ç­¾ï¼ˆé»˜è®¤ auto-ç”Ÿæˆï¼šak3-<device>-<date>ï¼‰"
        required: false
        default: ""
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v5

      #####################################################################
      # åœ¨æ‰€æœ‰ä¸»è¦å‘½ä»¤å¼€å§‹å‰ï¼šåˆ›å»º 10G å·¥ä½œç©ºé—´ï¼ˆloopback ext4ï¼‰ï¼Œå¹¶ä¾› O= ä½¿ç”¨
      #####################################################################
      - name: Prepare 10G build workspace (loopback ext4)
        id: ws
        shell: bash
        run: |
          set -eux
          # è‹¥å·¥å…·ä¸å­˜åœ¨åˆ™å®‰è£…ï¼ˆé¿å… mkfs.ext4/mount ç¼ºå¤±ï¼‰
          if ! command -v mkfs.ext4 >/dev/null 2>&1 || ! command -v mount >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y e2fsprogs util-linux
          fi

          sudo mkdir -p /mnt/workspace
          # åˆ›å»º 10G ç¨€ç–é•œåƒæ–‡ä»¶å¹¶æ ¼å¼åŒ–ä¸º ext4
          sudo dd if=/dev/zero of=/mnt/workspace.img bs=1M count=0 seek=10240
          sudo mkfs.ext4 -F /mnt/workspace.img
          sudo mount -o loop /mnt/workspace.img /mnt/workspace
          sudo chown $USER:$USER /mnt/workspace
          mkdir -p /mnt/workspace/out

          echo "O_OUT=/mnt/workspace/out" >> "$GITHUB_OUTPUT"

      - name: Show inputs
        shell: bash
        run: |
          echo "kernel_repo_url=${{ inputs.kernel_repo_url }}"
          echo "kernel_branch=${{ inputs.kernel_branch }}"
          echo "device_codename=${{ inputs.device_codename }}"
          echo "defconfig_path=${{ inputs.defconfig_path }}"
          echo "arch=${{ inputs.arch }}"
          echo "llvm_version=${{ inputs.llvm_version }}"
          echo "anykernel3_repo=${{ inputs.anykernel3_repo }}"
          echo "anykernel3_branch=${{ inputs.anykernel3_branch }}"

      - name: Install build dependencies
        shell: bash
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y \
            bc bison flex \
            build-essential git curl wget zip unzip patch \
            libssl-dev libelf-dev \
            python3 rsync ccache \
            dwarves lz4 llvm

      - name: Install specific LLVM/Clang via apt.llvm.org
        shell: bash
        run: |
          set -eux
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${{ inputs.llvm_version }}
          clang-${{ inputs.llvm_version }} --version || true
          ld.lld-${{ inputs.llvm_version }} --version || true

      # æ–°å¢ï¼šå°†æ— åç¼€å·¥å…·æ˜ å°„åˆ°æŒ‡å®šç‰ˆæœ¬ï¼ˆè§£å†³ ld.lld: not foundï¼‰
      - name: Map unsuffixed LLVM tool names to selected version
        shell: bash
        run: |
          set -eux
          VER="${{ inputs.llvm_version }}"
          # ä½¿ç”¨ update-alternatives å»ºç«‹æ— åç¼€åˆ«å
          sudo update-alternatives --install /usr/bin/clang      clang      /usr/bin/clang-${VER}      100
          sudo update-alternatives --install /usr/bin/clang++    clang++    /usr/bin/clang++-${VER}    100
          sudo update-alternatives --install /usr/bin/ld.lld     ld.lld     /usr/bin/ld.lld-${VER}     100
          sudo update-alternatives --install /usr/bin/llvm-ar    llvm-ar    /usr/bin/llvm-ar-${VER}    100
          sudo update-alternatives --install /usr/bin/llvm-nm    llvm-nm    /usr/bin/llvm-nm-${VER}    100
          sudo update-alternatives --install /usr/bin/llvm-objcopy llvm-objcopy /usr/bin/llvm-objcopy-${VER} 100
          sudo update-alternatives --install /usr/bin/llvm-objdump llvm-objdump /usr/bin/llvm-objdump-${VER} 100
          sudo update-alternatives --install /usr/bin/llvm-strip llvm-strip /usr/bin/llvm-strip-${VER} 100
          # éªŒè¯æ— åç¼€å‘½ä»¤
          ld.lld --version
          clang  --version

      - name: Clone kernel source
        shell: bash
        run: |
          set -eux
          git clone --depth=1 -b "${{ inputs.kernel_branch }}" "${{ inputs.kernel_repo_url }}" kernel-src



      - name: Resolve defconfig path
        id: defcfg
        working-directory: kernel-src
        shell: bash
        env:
          ARCH_IN: ${{ inputs.arch }}
        run: |
          set -eux
          DF_IN="${{ inputs.defconfig_path }}"
          DF_BASENAME="$(basename "$DF_IN")"

          if [ -f "$DF_IN" ]; then
            DF_PATH="$DF_IN"
          else
            CANDIDATES=(
              "arch/${ARCH_IN}/configs/${DF_BASENAME}"
              "arch/${ARCH_IN}/configs/vendor/${DF_BASENAME}"
              "vendor/${DF_BASENAME}"
              "${DF_IN}"
            )
            DF_PATH=""
            for p in "${CANDIDATES[@]}"; do
              if [ -f "$p" ]; then
                DF_PATH="$p"
                break
              fi
            done
            if [ -z "$DF_PATH" ]; then
              echo "âŒ æœªæ‰¾åˆ° defconfig æ–‡ä»¶ï¼Œå°è¯•è¿‡ä»¥ä¸‹ä½ç½®ï¼š"
              printf ' - %s\n' "${CANDIDATES[@]}"
              exit 1
            fi
          fi

          echo "DF_TARGET=${DF_BASENAME}" >> "$GITHUB_OUTPUT"
          echo "DF_PATH=${DF_PATH}"       >> "$GITHUB_OUTPUT"
          echo "âœ” è§£æåˆ° defconfigï¼š$DF_PATH"

      #####################################################################
      # ä¸‹è½½å¹¶åº”ç”¨ LXC è¡¥ä¸
      #####################################################################
      - name: Fetch LXC_utils.zip
        working-directory: kernel-src
        shell: bash
        run: |
          set -eux
          mkdir -p Patchs
          wget -O Patchs/LXC_utils.zip \
            "https://raw.githubusercontent.com/MIGHTYBLANK001/kernel-build-by-AI/refs/heads/main/Patchs/LXC_utils.zip"
          ls -l Patchs/LXC_utils.zip

      - name: Apply LXC patches (enable Docker, qtaguid, runcpatch)
        working-directory: kernel-src
        shell: bash
        env:
          TARGET_DEVICE: ${{ inputs.device_codename }}
          DF_PATH: ${{ steps.defcfg.outputs.DF_PATH }}
          ARCH: ${{ inputs.arch }}
        run: |
          set -euo pipefail
          echo "ğŸ”§ æ­£åœ¨ä¸ºå†…æ ¸å®‰è£… LXC è¡¥ä¸..."

          # è§£å‹è‡³ utils/
          if [ ! -f "Patchs/LXC_utils.zip" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ° Patchs/LXC_utils.zipï¼Œè·³è¿‡ LXC è¡¥ä¸æ­¥éª¤ã€‚" >&2
            exit 0
          fi
          rm -rf utils && unzip -o Patchs/LXC_utils.zip -d utils

          # å¼•å…¥ utils/Kconfig åˆ°ä¸» Kconfigï¼ˆé¿å…é‡å¤æ·»åŠ ï¼‰
          if ! grep -q 'source "utils/Kconfig"' Kconfig; then
            echo 'source "utils/Kconfig"' >> Kconfig
          fi

          DEFCONFIG_FILE="$DF_PATH"
          if [ ! -f "$DEFCONFIG_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° defconfig æ–‡ä»¶ï¼š$DEFCONFIG_FILE" >&2
            exit 1
          fi

          # å¼€å¯ Dockerï¼›å…³é—­ ANDROID_PARANOID_NETWORK
          if ! grep -q '^CONFIG_DOCKER=y' "$DEFCONFIG_FILE"; then
            echo "CONFIG_DOCKER=y" >> "$DEFCONFIG_FILE"
          fi
          sed -i '/CONFIG_ANDROID_PARANOID_NETWORK/d' "$DEFCONFIG_FILE"
          echo "# CONFIG_ANDROID_PARANOID_NETWORK is not set" >> "$DEFCONFIG_FILE"

          # runcpatchï¼šä¸¤æ¡å¸¸è§è·¯å¾„éƒ½å°è¯•
          chmod +x utils/runcpatch.sh
          [ -f kernel/cgroup/cgroup.c ] && sh utils/runcpatch.sh kernel/cgroup/cgroup.c || true
          [ -f kernel/cgroup.c ]       && sh utils/runcpatch.sh kernel/cgroup.c       || true

          # xt_qtaguid è¡¥ä¸ï¼ˆå­˜åœ¨åˆ™å°è¯•åº”ç”¨ï¼›å¤±è´¥ä¸è‡´å‘½ï¼‰
          if [ -f net/netfilter/xt_qtaguid.c ] && [ -f utils/xt_qtaguid.patch ]; then
            patch -p0 < utils/xt_qtaguid.patch || true
          fi

          echo "âœ… LXC è¡¥ä¸å®‰è£…å®Œæˆï¼"

      - name: Build kernel (LLVM=${{ inputs.llvm_version }})
        working-directory: kernel-src
        shell: bash
        run: |
          set -eux
          export ARCH="${{ inputs.arch }}"
          export SUBARCH="${{ inputs.arch }}"
          # ä½¿ç”¨ 10G å·¥ä½œç©ºé—´ä½œä¸º O= è¾“å‡ºç›®å½•
          make O="${{ steps.ws.outputs.O_OUT }}" ARCH="${ARCH}" LLVM=-${{ inputs.llvm_version }} "${{ steps.defcfg.outputs.DF_TARGET }}"
          make -j"$(nproc)" O="${{ steps.ws.outputs.O_OUT }}" ARCH="${ARCH}" LLVM=-${{ inputs.llvm_version }}

      - name: Build modules (optional)
        working-directory: kernel-src
        shell: bash
        run: |
          set -eux
          export ARCH="${{ inputs.arch }}"
          make -j"$(nproc)" O="${{ steps.ws.outputs.O_OUT }}" ARCH="${ARCH}" LLVM=-${{ inputs.llvm_version }} modules || true

      - name: Locate kernel images
        id: locateimg
        working-directory: kernel-src
        shell: bash
        run: |
          set -eux
          ARCH_DIR="${{ steps.ws.outputs.O_OUT }}/arch/${{ inputs.arch }}/boot"
          KIMG=$(ls ${ARCH_DIR}/Image*.lz4-dtb ${ARCH_DIR}/Image*.gz-dtb ${ARCH_DIR}/Image*-dtb ${ARCH_DIR}/Image.gz ${ARCH_DIR}/Image 2>/dev/null | head -n 1 || true)
          DTBO=$(ls ${ARCH_DIR}/dtbo.img 2>/dev/null || true)
          if [ -z "$KIMG" ]; then
            echo "No kernel image found under ${ARCH_DIR}" >&2
            exit 1
          fi
          echo "KIMG=$KIMG" >> $GITHUB_OUTPUT
          echo "DTBO=$DTBO" >> $GITHUB_OUTPUT

      - name: Clone AnyKernel3
        shell: bash
        run: |
          set -eux
          git clone --depth=1 -b "${{ inputs.anykernel3_branch }}" "${{ inputs.anykernel3_repo }}" AnyKernel3

      - name: Prepare AnyKernel3 payload
        shell: bash
        run: |
          set -eux
          cp "kernel-src/${{ steps.locateimg.outputs.KIMG }}" AnyKernel3/
          if [ -n "${{ steps.locateimg.outputs.DTBO }}" ]; then
            cp "kernel-src/${{ steps.locateimg.outputs.DTBO }}" AnyKernel3/
          fi
          if [ -d "${{ steps.ws.outputs.O_OUT }}/lib/modules" ]; then
            mkdir -p AnyKernel3/modules
            rsync -a "${{ steps.ws.outputs.O_OUT }}/lib/modules/" AnyKernel3/modules/ || true
          fi

      - name: Patch anykernel.sh
        working-directory: AnyKernel3
        shell: bash
        run: |
          set -eux
          if grep -q '^kernel.string=' anykernel.sh; then
            sed -i "s|^kernel.string=.*|kernel.string=Kernel for ${{ inputs.device_codename }} (LLVM ${{ inputs.llvm_version }})|" anykernel.sh
          else
            sed -i "1ikernel.string=Kernel for ${{ inputs.device_codename }} (LLVM ${{ inputs.llvm_version }})" anykernel.sh
          fi
          if grep -q '^device.name1=' anykernel.sh; then
            sed -i "s|^device.name1=.*|device.name1=${{ inputs.device_codename }}|" anykernel.sh
          else
            sed -i "1idevice.name1=${{ inputs.device_codename }}" anykernel.sh
          fi

      - name: Make flashable ZIP
        id: makezip
        working-directory: AnyKernel3
        shell: bash
        run: |
          set -eux
          DATESTR="$(date +%Y%m%d-%H%M)"
          ZIPNAME="AK3-${{ inputs.device_codename }}-${DATESTR}.zip"
          zip -r9 "../${ZIPNAME}" .
          echo "ZIPPATH=${ZIPNAME}" >> $GITHUB_OUTPUT
          echo "DATESTR=${DATESTR}" >> $GITHUB_OUTPUT

      - name: Create Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag != '' && inputs.release_tag || format('ak3-{0}-{1}', inputs.device_codename, steps.makezip.outputs.DATESTR) }}
          name: "AnyKernel3 for ${{ inputs.device_codename }} (LLVM ${{ inputs.llvm_version }})"
          body: |
            - Device: ${{ inputs.device_codename }}
            - Kernel repo: ${{ inputs.kernel_repo_url }} @ ${{ inputs.kernel_branch }}
            - Defconfig: ${{ inputs.defconfig_path }}
            - Arch: ${{ inputs.arch }}
            - Toolchain: LLVM/Clang ${{ inputs.llvm_version }} via apt.llvm.org
            - LXC patches: Docker enabled, runcpatch applied, xt_qtaguid patched (if present)
            - Build workspace: 10G loopback ext4 mounted at /mnt/workspace
            - Built at: ${{ env.TZ }}
          draft: false
          prerelease: false
          files: |
            AnyKernel3/${{ steps.makezip.outputs.ZIPPATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ¸…ç†ï¼šå¸è½½å·¥ä½œç©ºé—´ï¼Œåˆ é™¤é•œåƒæ–‡ä»¶
      - name: Cleanup build workspace
        if: always()
        shell: bash
        run: |
          set -eux
          sudo umount /mnt/workspace || true
          sudo rm -f /mnt/workspace.img || true
