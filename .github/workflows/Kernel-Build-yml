name: Kernel Matrix Build (Vanilla & SUSFS)

on:
  workflow_dispatch:
    inputs:
      kernel_source_url:
        description: 'å†…æ ¸æºç ä»“åº“åœ°å€ (Git URL)'
        required: true
        default: 'https://github.com/User/repo.git'
      kernel_source_branch:
        description: 'æºç åˆ†æ”¯ (ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤åˆ†æ”¯)'
        required: false
        default: ''
      device_code:
        description: 'æœºå‹ä»£ç  (DEVICE, ä¾‹å¦‚ rosemary)'
        required: true
        default: 'rosemary'
      defconfig_name:
        description: 'Defconfig è·¯å¾„ (ä¾‹å¦‚ vendor/rosemary_defconfig)'
        required: true
        default: 'vendor/rosemary_defconfig'
      enable_lxc:
        description: 'æ˜¯å¦å¯ç”¨ LXC/Docker è¡¥ä¸?'
        required: true
        type: boolean
        default: true

jobs:
  build-kernel:
    name: Build ${{ matrix.variant }}
    runs-on: ubuntu-latest
    
    # ç­–ç•¥çŸ©é˜µï¼šè¿™ä¼šè®©åŒä¸€ä¸ª Job è¿è¡Œä¸¤æ¬¡ï¼Œå˜é‡ matrix.variant åˆ†åˆ«ä¸º vanilla å’Œ susfs
    strategy:
      fail-fast: false # å¦‚æœå…¶ä¸­ä¸€ä¸ªå˜ä½“å¤±è´¥ï¼Œä¸è¦å–æ¶ˆå¦ä¸€ä¸ª
      matrix:
        variant: [vanilla, susfs]

    permissions:
      contents: write

    steps:
    # 1. æ£€å‡ºå½“å‰ä»“åº“ (ä¸ºäº†è·å– build.sh)
    - name: Checkout Builder Repo
      uses: actions/checkout@v4
      with:
        path: builder_tools

    # 2. åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ (é€‚é… ubuntu-latest)
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          bc bison build-essential ccache curl flex g++-multilib gcc-multilib \
          git gnupg gperf imagemagick libncurses-dev libsdl1.2-dev \
          libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool \
          squashfs-tools xsltproc zip zlib1g-dev python3 python3-pip wget unzip \
          lib32readline-dev lib32z1-dev liblz4-tool
        
        # å…¼å®¹æ€§å¤„ç†ï¼šubuntu-latest (24.04) å¯èƒ½ç§»é™¤äº† python2ï¼Œå»ºç«‹ python è½¯é“¾æ¥æŒ‡å‘ python3
        sudo ln -sf /usr/bin/python3 /usr/bin/python

    # 3. ä¸‹è½½ Neutron Clang (æ”¯æŒæœ€æ–°ç¯å¢ƒ)
    - name: Download Neutron Clang
      run: |
        mkdir -p toolchain
        cd toolchain
        git clone --depth=1 https://github.com/Neutron-Clang/neutron-clang.git clang

    # 4. å…‹éš†å†…æ ¸æºç 
    - name: Clone Kernel Source
      run: |
        URL="${{ inputs.kernel_source_url }}"
        BRANCH="${{ inputs.kernel_source_branch }}"
        if [ -z "$BRANCH" ]; then
          echo "Cloning default branch..."
          git clone --depth=1 "$URL" workspace
        else
          echo "Cloning branch $BRANCH..."
          git clone --depth=1 -b "$BRANCH" "$URL" workspace
        fi

    # 5. åº”ç”¨ LXC è¡¥ä¸
    - name: Apply LXC patches
      if: ${{ inputs.enable_lxc == 'true' }}
      working-directory: workspace
      run: |
        set -e
        echo "ğŸ”§ [${{ matrix.variant }}] æ­£åœ¨åº”ç”¨ LXC è¡¥ä¸..."
        
        LXC_URL="https://raw.githubusercontent.com/MIGHTYBLANK001/kernel-build-by-AI/refs/heads/main/Patchs/LXC_utils.zip"
        DEFCONFIG_FILE="arch/arm64/configs/${{ inputs.defconfig_name }}"
        
        wget -q "$LXC_URL" -O LXC_utils.zip
        rm -rf utils && unzip -o LXC_utils.zip -d utils && rm LXC_utils.zip

        # ä¿®æ”¹ Kconfig
        if [ -f "Kconfig" ]; then
            ! grep -q 'source "utils/Kconfig"' Kconfig && echo 'source "utils/Kconfig"' >> Kconfig
        fi

        # ä¿®æ”¹ Defconfig
        if [ -f "$DEFCONFIG_FILE" ]; then
            ! grep -q '^CONFIG_DOCKER=y' "$DEFCONFIG_FILE" && echo "CONFIG_DOCKER=y" >> "$DEFCONFIG_FILE"
            sed -i '/CONFIG_ANDROID_PARANOID_NETWORK/d' "$DEFCONFIG_FILE"
            echo "# CONFIG_ANDROID_PARANOID_NETWORK is not set" >> "$DEFCONFIG_FILE"
        else
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° Defconfig æ–‡ä»¶: $DEFCONFIG_FILE"
            exit 1
        fi

        # è¿è¡Œè¡¥ä¸è„šæœ¬
        chmod +x utils/runcpatch.sh
        [[ -f kernel/cgroup/cgroup.c ]] && sh utils/runcpatch.sh kernel/cgroup/cgroup.c
        [[ -f kernel/cgroup.c ]] && sh utils/runcpatch.sh kernel/cgroup.c
        [[ -f net/netfilter/xt_qtaguid.c && -f utils/xt_qtaguid.patch ]] && patch -p0 < utils/xt_qtaguid.patch || true
        echo "âœ… LXC è¡¥ä¸å®Œæˆ"

    # 6. å‡†å¤‡æ„å»ºè„šæœ¬ (æ³¨å…¥å˜é‡)
    - name: Prepare Build Script
      run: |
        cp builder_tools/build.sh workspace/
        cd workspace
        chmod +x build.sh
        
        # åŠ¨æ€æ›¿æ¢ defconfig
        sed -i 's|DEFCONFIG_NAME="vendor/${DEVICE}_user_defconfig";|DEFCONFIG_NAME="${{ inputs.defconfig_name }}";|g' build.sh
        
        # ç”Ÿæˆ .env.sh
        echo "export DEVICE=${{ inputs.device_code }}" >> .env.sh
        echo "export BUILD_USER=GitHubAction" >> .env.sh
        echo "export BUILD_HOST=GitHub-Runner" >> .env.sh
        # åœ¨å†…æ ¸åç§°ä¸­åŠ å…¥å˜ä½“æ ‡è¯† (ä¾‹å¦‚ Rosemary-Kernel-susfs)
        echo "export KERNEL_STRING=${{ inputs.device_code }}-Kernel-${{ matrix.variant }}" >> .env.sh
        chmod +x .env.sh

    # 7. æ‰§è¡Œæ„å»º (ä½¿ç”¨ matrix.variant åŠ¨æ€ä¼ å‚)
    - name: Run Build (${{ matrix.variant }})
      run: |
        export PATH=$GITHUB_WORKSPACE/toolchain/clang/bin:$PATH
        cd workspace
        
        # è¿™é‡Œä½¿ç”¨äº† ${{ matrix.variant }}ï¼Œå®ƒä¼šè‡ªåŠ¨å˜ä¸º vanilla æˆ– susfs
        bash build.sh --variant ${{ matrix.variant }} cleanbuild

    # 8. ç”Ÿæˆç‹¬ç«‹çš„ Release Tag
    - name: Generate Release Tag
      id: tag_gen
      run: |
        # æ ¼å¼: æœºå‹-å˜ä½“-æ—¥æœŸ
        echo "release_tag=${{ inputs.device_code }}-${{ matrix.variant }}-$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT

    # 9. å‘å¸ƒäº§ç‰©
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: ${{ steps.tag_gen.outputs.release_tag }}
        name: ${{ inputs.device_code }} [${{ matrix.variant }}] - $(date +'%Y%m%d')
        body: |
          ### Kernel Build Info
          - **Variant:** ${{ matrix.variant }}
          - **Device:** ${{ inputs.device_code }}
          - **Source:** ${{ inputs.kernel_source_url }}
          - **LXC Patch:** ${{ inputs.enable_lxc }}
          - **System:** Ubuntu Latest
          
          Automated build via GitHub Actions.
        files: |
          workspace/AnyKernel3/*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
