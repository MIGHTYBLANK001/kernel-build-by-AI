name: Kernel Build (Vanilla Only & Latest Proton Clang)

on:
  workflow_dispatch:
    inputs:
      # --- æ ¸å¿ƒé…ç½® (é€šç”¨æ€§é«˜ï¼Œé»˜è®¤è¾“å…¥ä¸ºç©º) ---
      kernel_source_url:
        description: 'å†…æ ¸æºç ä»“åº“åœ°å€ (owner/repo)'
        required: true
        default: ''
      kernel_source_branch:
        description: 'æºç åˆ†æ”¯ (ç•™ç©ºåˆ™å…‹éš†é»˜è®¤åˆ†æ”¯)'
        required: false
        default: ''
      device_code:
        description: 'æœºåž‹ä»£ç  (DEVICE)'
        required: true
        default: ''
      defconfig_name:
        description: 'Defconfig åç§° (ä¾‹å¦‚: lmi_defconfig)'
        required: true
        default: ''
      
      # --- åŠŸèƒ½å¼€å…³ ---
      enable_lxc:
        description: 'å¯ç”¨ LXC/Docker è¡¥ä¸?'
        required: true
        type: boolean
        default: true

jobs:
  build-vanilla-only:
    name: Build Vanilla Kernel
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    env:
      BUILD_VARIANT: vanilla
      TOOLCHAIN_CLONE_DIR: ${{ github.workspace }}/toolchain/proton-clang
      # é€šç”¨ç¼–è¯‘å‚æ•°ï¼šé€‚ç”¨äºŽç»å¤§å¤šæ•°åŸºäºŽ AOSP/Google æ ‡å‡†çš„å†…æ ¸
      BUILD_ARGS_BASE: "CC=clang ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_COMPAT=arm-linux-gnueabi- CLANG_TRIPLE=aarch64-linux-gnu- LLVM=1 LLVM_IAS=1"

    steps:
    # 1. çŽ¯å¢ƒé…ç½®ä¸Žä¾èµ–å®‰è£…
    - name: Setup Build Environment and Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          bc bison build-essential ccache curl flex g++-multilib gcc-multilib \
          git gnupg gperf imagemagik libncurses-dev libsdl1.2-dev \
          libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool \
          squashfs-tools xsltproc zip zlib1g-dev python3 python3-pip wget unzip \
          lib32readline-dev lib32z1-dev liblz4-tool jq
        sudo ln -sf /usr/bin/python3 /usr/bin/python

    # 2. é…ç½®å·¥å…·é“¾ (Proton Clang æœ€æ–°ç‰ˆæœ¬)
    - name: Download Latest Proton Clang Toolchain
      run: |
        set -e
        CLANG_REPO="https://github.com/kdrag0n/proton-clang"
        mkdir -p "$TOOLCHAIN_CLONE_DIR"
        
        # æ€»æ˜¯å…‹éš†æœ€æ–°ç‰ˆæœ¬ (é»˜è®¤åˆ†æ”¯)
        git clone --depth=1 "$CLANG_REPO" "$TOOLCHAIN_CLONE_DIR" || { echo "âŒ Clang å…‹éš†å¤±è´¥"; exit 1; }
        
        # è®¾ç½® PATH çŽ¯å¢ƒå˜é‡
        echo "PATH=${TOOLCHAIN_CLONE_DIR}/bin:$PATH" >> $GITHUB_ENV
        echo "âœ… Proton Clang å·¥å…·é“¾ä¸‹è½½å¹¶è®¾ç½® PATH å®Œæ¯•ã€‚"
        
    # 3. ä¸‹è½½å†…æ ¸æºç 
    - name: Clone Kernel Source
      run: |
        URL="${{ inputs.kernel_source_url }}"
        BRANCH="${{ inputs.kernel_source_branch }}"
        
        if [ -z "$BRANCH" ]; then
          git clone --depth=1 "$URL" workspace
        else
          git clone --depth=1 -b "$BRANCH" "$URL" workspace
        fi

    # 4. åº”ç”¨ LXC è¡¥ä¸
    - name: Apply LXC patches
      if: ${{ inputs.enable_lxc }}
      working-directory: workspace
      run: |
        set -e
        echo "ðŸ”§ æ­£åœ¨åº”ç”¨ LXC è¡¥ä¸..."
        LXC_URL="https://raw.githubusercontent.com/MIGHTYBLANK001/kernel-build-by-AI/refs/heads/main/Patchs/LXC_utils.zip"
        DEFCONFIG_FILE="arch/arm64/configs/${{ inputs.defconfig_name }}"
        
        wget -q "$LXC_URL" -O LXC_utils.zip
        rm -rf utils && unzip -o LXC_utils.zip -d utils && rm LXC_utils.zip

        if [ -f "Kconfig" ]; then
            grep -q 'source "utils/Kconfig"' Kconfig || echo 'source "utils/Kconfig"' >> Kconfig
        fi
        
        if [ -f "$DEFCONFIG_FILE" ]; then
            grep -q '^CONFIG_DOCKER=y' "$DEFCONFIG_FILE" || echo "CONFIG_DOCKER=y" >> "$DEFCONFIG_FILE"
            sed -i '/CONFIG_ANDROID_PARANOID_NETWORK/d' "$DEFCONFIG_FILE"
            echo "# CONFIG_ANDROID_PARANOID_NETWORK is not set" >> "$DEFCONFIG_FILE"
        fi
        
        chmod +x utils/runcpatch.sh
        [[ -f kernel/cgroup/cgroup.c ]] && sh utils/runcpatch.sh kernel/cgroup/cgroup.c
        [[ -f kernel/cgroup.c ]] && sh utils/runcpatch.sh kernel/cgroup.c
        [[ -f net/netfilter/xt_qtaguid.c && -f utils/xt_qtaguid.patch ]] && patch -p0 < utils/xt_qtaguid.patch || true
        echo "âœ… LXC è¡¥ä¸åº”ç”¨å®Œæˆ"

    # 5. æ£€æŸ¥ LXC è¡¥ä¸é…ç½®æ˜¯å¦æœ‰æ•ˆ (ä¿®å¤ HOSTCC é”™è¯¯)
    - name: Verify Docker/LXC requirements via moby check-config.sh
      if: ${{ inputs.enable_lxc }}
      working-directory: workspace
      run: |
        set -e
        OUT_PATH="../out/${{ inputs.device_code }}/${{ env.BUILD_VARIANT }}"
        echo "ðŸ” æ­£åœ¨æ£€æŸ¥ LXC/Docker ä¾èµ–é…ç½®..."

        # ã€ä¿®å¤ç‚¹ 1ã€‘æ·»åŠ  HOSTCC=gcc æ¥ç¼–è¯‘ä¸»æœºå·¥å…· (fixdep, etc.)
        make ${BUILD_ARGS_BASE} O=$OUT_PATH ${{ inputs.defconfig_name }} HOSTCC=gcc
        
        # ä¸‹è½½å¹¶è¿è¡Œ moby è„šæœ¬è¿›è¡Œæ£€æŸ¥
        curl -fsSL https://raw.githubusercontent.com/moby/moby/master/contrib/check-config.sh -o /tmp/check-config.sh
        chmod +x /tmp/check-config.sh
        /tmp/check-config.sh $OUT_PATH/.config
        echo "âœ… é…ç½®æ£€æŸ¥é€šè¿‡ã€‚"
        
    # 6. ç¼–è¯‘å†…æ ¸ï¼Œç„¶åŽæ‰“åŒ… (ä¿®å¤ HOSTCC é”™è¯¯)
    - name: Build and Package Kernel (Vanilla)
      working-directory: workspace
      run: |
        set -e
        
        # --- å˜é‡å®šä¹‰ ---
        DEVICE="${{ inputs.device_code }}"
        DEFCONFIG_NAME="${{ inputs.defconfig_name }}"
        BUILD_VARIANT="${{ env.BUILD_VARIANT }}"
        THREAD=$(nproc --all)
        OUT="../out/$DEVICE/$BUILD_VARIANT"
        ANYKERNEL_DIR="AnyKernel3"
        DEFCONFIG_FULL_PATH="arch/arm64/configs/$DEFCONFIG_NAME"
        
        # ã€ä¿®å¤ç‚¹ 2ã€‘åœ¨ BUILD_ARGS ä¸­æ·»åŠ  HOSTCC=gcc
        BUILD_ARGS="$BUILD_ARGS_BASE O=$OUT -j$THREAD KBUILD_BUILD_USER=GitHubAction KBUILD_BUILD_HOST=GitHub-Runner KBUILD_CFLAGS+='-Wno-unused-command-line-argument' HOSTCC=gcc" 

        # --- 1. æ¸…ç†å’Œé…ç½® ---
        echo "--- 1. CLEANING AND CONFIGURING ---"
        # ã€ä¿®å¤ç‚¹ 3ã€‘æ¸…ç†å‘½ä»¤ä¹Ÿå¿…é¡»åŒ…å« HOSTCC=gcc
        make -s mrproper -j$THREAD HOSTCC=gcc
        make -s clean -j$THREAD HOSTCC=gcc
        rm -rf "$OUT"
        
        # æ‰§è¡Œ Defconfig
        make $BUILD_ARGS "$DEFCONFIG_NAME" 
        
        # --- 2. æ ¸å¿ƒç¼–è¯‘ï¼šç¼–è¯‘ Image å’Œæ‰€æœ‰ DTBs ---
        echo "--- 2. BUILDING KERNEL IMAGE AND DTBS ---"
        make $BUILD_ARGS Image dtbs 

        # --- 3. é“¾æŽ¥ DTB æ–‡ä»¶ (é€šç”¨å…¼å®¹æ¨¡å¼) ---
        echo "--- 3. LINKING DTB FILES (Generic) ---"
        TARGET_KERNEL_DTB="arch/arm64/boot/dtb"
        # åœ¨æ•´ä¸ª dts ç›®å½•ä¸­é€’å½’æŸ¥æ‰¾å¹¶åˆå¹¶æ‰€æœ‰ *.dtb æ–‡ä»¶ï¼Œå¢žå¼ºé€šç”¨æ€§
        find "$OUT/arch/arm64/boot/dts" -name '*.dtb' -exec cat {} + > "$OUT/$TARGET_KERNEL_DTB"
        
        # --- 4. ç”Ÿæˆå¯åˆ·å†™åŒ… ---
        echo "--- 4. GENERATING FLASHABLE ZIP ---"
        
        mkdir -p "$OUT"
        cd "$OUT"
        
        git clone --depth=1 https://github.com/august-aosp/AnyKernel3.git "$ANYKERNEL_DIR"

        # èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
        TARGET_KERNEL_NAME=$(cat "../../$DEFCONFIG_FULL_PATH" | grep CONFIG_LOCALVERSION= | cut -d = -f 2 | sed 's/"//g' | sed 's/^-//')
        TARGET_KERNEL_VERSION=$(make -C . -f "../../Makefile" kernelversion O="$OUT")
        GIT_COMMIT=$(git rev-parse --short HEAD)

        TARGET_PACKAGED_KERNEL_NAME="Kernel-${DEVICE}-${BUILD_VARIANT}-${GIT_COMMIT}.zip"
        
        # å¤åˆ¶æ–‡ä»¶åˆ° AnyKernel3
        TARGET_KERNEL_FILE="arch/arm64/boot/Image"
        TARGET_KERNEL_DTBO="arch/arm64/boot/dtbo.img"
        cp "../$TARGET_KERNEL_FILE" "$ANYKERNEL_DIR/Image"
        cp "$TARGET_KERNEL_DTB" "$ANYKERNEL_DIR/"
        if [ -f "$TARGET_KERNEL_DTBO" ]; then 
          cp "$TARGET_KERNEL_DTBO" "$ANYKERNEL_DIR/"
        fi

        # æ‰“åŒ…
        cd "$ANYKERNEL_DIR"
        zip -q -r "$TARGET_PACKAGED_KERNEL_NAME" *
        cd ../..
        echo "ZIP_FILENAME=$TARGET_PACKAGED_KERNEL_NAME" >> $GITHUB_ENV
        
    # 7. ç”Ÿæˆ Release Tag
    - name: Generate Release Tag
      id: tag_gen
      run: |
        TAG_NAME="${{ inputs.device_code }}-${{ env.BUILD_VARIANT }}-$(date +'%Y%m%d-%H%M')"
        echo "release_tag=$TAG_NAME" >> $GITHUB_OUTPUT

    # 8. ä¸Šä¼ åˆ° Release
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: ${{ steps.tag_gen.outputs.release_tag }}
        name: ${{ inputs.device_code }} [${{ env.BUILD_VARIANT }}] Build ${{ steps.tag_gen.outputs.release_tag }}
        body: |
          Automated Build Details:
          - Device: ${{ inputs.device_code }}
          - Source Branch: ${{ inputs.kernel_source_branch || 'default' }}
          - Toolchain: Latest Proton Clang
          - LXC Patch: ${{ inputs.enable_lxc && 'Enabled' || 'Disabled' }}
        files: workspace/../out/${{ inputs.device_code }}/${{ env.BUILD_VARIANT }}/AnyKernel3/${{ env.ZIP_FILENAME }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
