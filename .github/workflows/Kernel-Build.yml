name: Build kernel (AOSP) â€“ æœ€ç»ˆç²¾ç®€ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      kernel_repo:
        description: "ç›®æ ‡å†…æ ¸æºç ä»“åº“ï¼ˆowner/repoï¼‰"
        default: ""
        required: true
      kernel_branch:
        description: "è¦æž„å»ºçš„åˆ†æ”¯ï¼›ç•™ç©ºåˆ™ä½¿ç”¨ä»“åº“é»˜è®¤åˆ†æ”¯"
        default: ""
        required: false
      device_code:
        description: "ç›®æ ‡è®¾å¤‡ä»£ç  (å¦‚ lmi)"
        default: ""
        required: true
      defconfig_sub_path:
        description: "Defconfig æ–‡ä»¶ç›¸å¯¹äºŽ arch/arm64/configs/ çš„å­è·¯å¾„ (å¦‚ lmi_defconfig æˆ– vendor/lmi_defconfig)"
        default: ""
        required: true
      enable_lxc_patch:
        description: "æ˜¯å¦åº”ç”¨ LXC/Docker è¡¥ä¸"
        type: boolean
        default: false
        required: true

permissions:
  contents: write    # éœ€è¦åˆ›å»º/æ›´æ–° Release ä¸ŽæŽ¨é€ tag

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      TARGET_DEVICE: ${{ inputs.device_code }}
      # DEFCONFIG è·¯å¾„åŸºç¡€å·²ç¡¬ç¼–ç 
      DEFCONFIG_SUB_PATH: ${{ inputs.defconfig_sub_path }}
      BUILD_AOSP: "1"
      # MAKE_ARGS ä¾èµ–äºŽåŽç»­ Toolchain æ­¥éª¤è®¾ç½®çš„ PATH
      MAKE_ARGS: "ARCH=arm64 SUBARCH=arm64 O=out CC=clang CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- CROSS_COMPILE_COMPAT=arm-linux-gnueabi- CLANG_TRIPLE=aarch64-linux-gnu-"

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # è®¡ç®—å®‰å…¨çš„ä»“åº“çŸ­åã€åˆ†æ”¯åå’Œå½“å‰æ—¶é—´
      - name: Prepare safe names and timestamp
        id: names
        shell: bash
        run: |
          set -e
          KREPO="${{ inputs.kernel_repo }}"
          KBRANCH="${{ inputs.kernel_branch }}"
          SAFE_REPO="$(echo "${KREPO}" | sed 's#/#-#g')"
          [[ -z "${KBRANCH}" ]] && KBRANCH="default"
          CURRENT_TIME="$(date +%Y%m%d%H%M)"
          
          echo "safe_repo=${SAFE_REPO}" >> $GITHUB_OUTPUT
          echo "safe_branch=${KBRANCH}" >> $GITHUB_OUTPUT
          echo "current_time=${CURRENT_TIME}" >> $GITHUB_OUTPUT

      # æ£€å‡ºç›®æ ‡å†…æ ¸æºç 
      - name: Checkout target kernel repo to kernel-src
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.kernel_repo }}
          ref: ${{ inputs.kernel_branch }}
          path: kernel-src
          submodules: recursive
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison flex libssl-dev \
            zip unzip git patch \
            build-essential make \
            binutils-aarch64-linux-gnu binutils-arm-linux-gnueabi

      - name: ðŸ› ï¸ Fetch Latest Proton Clang (Toolchain)
        run: |
          # å…‹éš†æœ€æ–°ç¨³å®šç‰ˆ Proton Clang å¹¶é…ç½® PATH
          git clone --depth=1 https://github.com/kdrag0n/proton-clang $HOME/proton-clang
          TOOLCHAIN_PATH=$HOME/proton-clang/bin
          echo "PATH=$TOOLCHAIN_PATH:$PATH" >> $GITHUB_ENV
          clang --version

      - name: Clean working tree
        working-directory: kernel-src
        run: |
          git reset --hard HEAD
          git clean -fd

      - name: Preflight checks (defconfig & Patchs)
        working-directory: kernel-src
        run: |
          set -e
          DEFCONFIG_FULL_PATH="arch/arm64/configs/${DEFCONFIG_SUB_PATH}"
          
          if [[ ! -f "${DEFCONFIG_FULL_PATH}" ]]; then
            echo "::error::æœªæ‰¾åˆ° defconfig: ${DEFCONFIG_FULL_PATH}"
            exit 1
          fi
          if [[ ! -d "Patchs" ]]; then
            echo "::error::æœªæ‰¾åˆ° Patchs/ ç›®å½•ï¼ˆåº”ä½äºŽä»“åº“æ ¹è·¯å¾„ï¼‰"
            exit 1
          fi
          echo "DEFCONFIG_FULL_PATH=${DEFCONFIG_FULL_PATH}" >> $GITHUB_ENV # å¯¼å‡ºå®Œæ•´è·¯å¾„

      - name: Apply LXC patches (enable Docker, qtaguid, runcpatch)
        if: ${{ inputs.enable_lxc_patch }}
        working-directory: kernel-src
        run: |
          set -e
          DEFCONFIG_FULL_PATH="${{ env.DEFCONFIG_FULL_PATH }}"
          echo "ðŸ”§ æ­£åœ¨ä¸ºå†…æ ¸å®‰è£… LXC è¡¥ä¸..."
          
          curl -fsSL https://raw.githubusercontent.com/MIGHTYBLANK001/kernel-build-by-AI/refs/heads/main/Patchs/LXC_utils.zip -o Patchs/LXC_utils.zip
          
          rm -rf utils && unzip -o Patchs/LXC_utils.zip -d utils
          if ! grep -q 'source "utils/Kconfig"' Kconfig; then
            echo 'source "utils/Kconfig"' >> Kconfig
          fi
          
          if ! grep -q '^CONFIG_DOCKER=y' "${DEFCONFIG_FULL_PATH}"; then
            echo "CONFIG_DOCKER=y" >> "${DEFCONFIG_FULL_PATH}"
          fi
          sed -i '/CONFIG_ANDROID_PARANOID_NETWORK/d' "${DEFCONFIG_FULL_PATH}"
          echo "# CONFIG_ANDROID_PARANOID_NETWORK is not set" >> "${DEFCONFIG_FULL_PATH}"

          chmod +x utils/runcpatch.sh
          [[ -f kernel/cgroup/cgroup.c ]] && sh utils/runcpatch.sh kernel/cgroup/cgroup.c
          [[ -f kernel/cgroup.c ]] && sh utils/runcpatch.sh kernel/cgroup.c
          if [[ -f net/netfilter/xt_qtaguid.c && -f utils/xt_qtaguid.patch ]]; then
            patch -p0 < utils/xt_qtaguid.patch || true
          fi
          echo "âœ… LXC è¡¥ä¸å®‰è£…å®Œæˆï¼"

      - name: Prepare & Load config
        working-directory: kernel-src
        run: |
          set -e
          DEFCONFIG_FULL_PATH="${{ env.DEFCONFIG_FULL_PATH }}"
          GIT_COMMIT_ID="$(git rev-parse --short=8 HEAD)"
          local_version_str="-perf"
          local_version_date_str="-$(date +%Y%m%d)-${GIT_COMMIT_ID}-perf"
          
          # 1. åµŒå…¥æœ¬åœ°ç‰ˆæœ¬å·åˆ° Defconfig æ–‡ä»¶ä¸­
          sed -i "s/${local_version_str}/${local_version_date_str}/g" "${DEFCONFIG_FULL_PATH}"
          
          # 2. å¤åˆ¶ Defconfig åˆ° out/.config å¹¶åŠ è½½é…ç½®
          mkdir -p out
          cp "${DEFCONFIG_FULL_PATH}" out/.config
          make ${MAKE_ARGS} olddefconfig

      - name: Apply optimized configurations via scripts/config
        working-directory: kernel-src
        run: |
          set -e
          scripts/config --file out/.config \
            -e KALLSYMS -e KALLSYMS_ALL -e KPROBES -e HAVE_KPROBES -e KPROBE_EVENTS \
            -e TMPFS_XATTR=y -e TMPFS_POSIX_ACL \
            -e IP_NF_TARGET_TTL -e IP6_NF_TARGET_HL -e IP6_NF_MATCH_HL \
            -e UCLAMP_TASK \
            -e TCP_CONG_ADVANCED -e TCP_CONG_BIC -e TCP_CONG_CUBIC -e TCP_CONG_WESTWOOD -e TCP_CONG_HTCP \
            -e TCP_CONG_HSTCP -e TCP_CONG_HYBLA -e TCP_CONG_VEGAS -e TCP_CONG_NV -e TCP_CONG_SCALABLE \
            -e TCP_CONG_LP -e TCP_CONG_VENO -e TCP_CONG_YEAH -e TCP_CONG_ILLINOIS -e TCP_CONG_DCTCP \
            -e TCP_CONG_CDG -e TCP_CONG_BBR -e DEFAULT_BBR \
            -e NET_SCHED -e NET_SCH_HTB -e NET_SCH_HFSC -e NET_SCH_PRIO -e NET_SCH_MULTIQ -e NET_SCH_RED \
            -e NET_SCH_SFB -e NET_SCH_SFQ -e NET_SCH_TEQL -e NET_SCH_TBF -e NET_SCH_CBS -e NET_SCH_ETF \
            -e NET_SCH_TAPRIO -e NET_SCH_GRED -e NET_SCH_NETEM -e NET_SCH_DRR -e NET_SCH_MQPRIO \
            -e NET_SCH_SKBPRIO -e NET_SCH_CHOKE -e NET_SCH_QFQ -e NET_SCH_CODEL -e NET_SCH_FQ_CODEL \
            -e NET_SCH_CAKE -e NET_SCH_FQ -e NET_SCH_HHF -e NET_SCH_PIE -e NET_SCH_FQ_PIE \
            -e NET_SCH_INGRESS -e NET_SCH_PLUG -e NET_SCH_ETS -e NET_SCH_FIFO -e NET_SCH_DEFAULT -e DEFAULT_FQ \
            -e MQ_IOSCHED_DEADLINE -e MQ_IOSCHED_KYBER -e IOSCHED_BFQ -e BFQ_GROUP_IOSCHED \
            -e ENERGY_MODEL -e CPU_IDLE -e CPU_IDLE_GOV_MENU -e CPU_IDLE_GOV_TEO -e ARM_PSCI_CPUIDLE \
            -e CPU_FREQ -e CPU_FREQ_STAT -e CPU_FREQ_TIMES -e CPU_FREQ_GOV_POWERSAVE -e CPU_FREQ_GOV_CONSERVATIVE \
            -e CPU_FREQ_GOV_USERSPACE -e CPU_FREQ_GOV_ONDEMAND \
            -e ZRAM -e ZSMALLOC -e ZRAM_WRITEBACK \
            -e CRYPTO_LZ4 -e CRYPTO_LZ4HC -e CRYPTO_LZ4K -e CRYPTO_LZ4KD -e CRYPTO_ZSTD -e CRYPTO_842 \
            -e CRYPTO_LZO -e CRYPTO_DEFLATE -e ZRAM_DEF_COMP_LZ4KD \
            -e SWAP -e ZSWAP \
            -e ANDROID_SIMPLE_LMK \
            -e CPU_FREQ_GOV_SCHEDHORIZON -e CPU_FREQ_DEFAULT_GOV_SCHEDHORIZON \
            --set-val LITTLE_CPU_MASK 15 \
            --set-val BIG_CPU_MASK 112 \
            --set-val PRIME_CPU_MASK 128 \
            -e LRU_GEN -e LRU_GEN_ENABLED \
            -e NTFS_FS -e NTFS_RW -e EXFAT_FS \
            -e EROFS_FS -e EROFS_FS_XATTR -e EROFS_FS_ZIP \
            -d ANDROID_PARANOID_NETWORK \
            -e PSTORE_LAST_KMSG

      - name: Build kernel
        working-directory: kernel-src
        run: |
          set -e
          make ${MAKE_ARGS} -j$(nproc)
          [[ -f out/arch/arm64/boot/Image ]] || { echo "::error::æœªç”Ÿæˆ out/arch/arm64/boot/Image"; exit 1; }
          echo "âœ… Build OK: out/arch/arm64/boot/Image"

      - name: Generate dtb (concatenate *.dtb)
        working-directory: kernel-src
        run: |
          set -e
          find out/arch/arm64/boot/dts -name '*.dtb' -exec cat {} + > out/arch/arm64/boot/dtb

      - name: Pack AnyKernel3 zip
        working-directory: kernel-src
        run: |
          set -e
          rm -rf anykernel/kernels/ && mkdir -p anykernel/kernels/
          cp out/arch/arm64/boot/Image anykernel/kernels/
          cp out/arch/arm64/boot/dtb anykernel/kernels/
          GIT_COMMIT_ID="$(git rev-parse --short=8 HEAD)"
          
          SAFE_REPO="${{ steps.names.outputs.safe_repo }}"
          SAFE_BRANCH="${{ steps.names.outputs.safe_branch }}"
          CURRENT_TIME="${{ steps.names.outputs.current_time }}"
          
          ZIP_FILENAME="${TARGET_DEVICE}-${SAFE_REPO}-${SAFE_BRANCH}-${CURRENT_TIME}_anykernel3_${GIT_COMMIT_ID}.zip"
          
          (cd anykernel && zip -r9 "${ZIP_FILENAME}" ./* -x .git .gitignore out/ ./*.zip)
          mv anykernel/${ZIP_FILENAME} .
          echo "ZIP_FILENAME=${ZIP_FILENAME}" >> $GITHUB_ENV
          echo "KERNEL_COMMIT=${GIT_COMMIT_ID}" >> $GITHUB_ENV
          echo "Done. The flashable zip is: ./${ZIP_FILENAME}"

      - name: Restore defconfig local version string
        working-directory: kernel-src
        run: |
          git restore --source=HEAD -- "${{ env.DEFCONFIG_FULL_PATH }}" || true

      # ====== å‘å¸ƒåˆ° Artifacts ======

      - name: Upload artifacts (zip, Image, dtb)
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ steps.names.outputs.safe_repo }}-${{ steps.names.outputs.safe_branch }}-${{ inputs.device_code }}-aosp-${{ github.run_id }}
          path: |
            kernel-src/${{ env.ZIP_FILENAME }}
            kernel-src/anykernel/kernels/Image
            kernel-src/anykernel/kernels/dtb
            kernel-src/out/arch/arm64/boot/Image
            kernel-src/out/arch/arm64/boot/dts/**/*.dtb
          if-no-files-found: warn

      # ====== å‘å¸ƒåˆ° Releaseï¼ˆåˆ›å»º tag å¹¶ä¸Šä¼  AnyKernel ZIPï¼‰ ======

      - name: Prepare release tag/name
        id: relmeta
        shell: bash
        run: |
          TAG="${{ inputs.device_code }}-${{ steps.names.outputs.current_time }}"
          NAME="Kernel AOSP ${{ inputs.device_code }} (${TAG}) [kernel commit: ${KERNEL_COMMIT}]"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "name=${NAME}" >> $GITHUB_OUTPUT

      - name: Create and push tag
        run: |
          set -e
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag "${{ steps.relmeta.outputs.tag }}"
          git push origin "${{ steps.relmeta.outputs.tag }}"

      - name: Create GitHub Release & upload AnyKernel ZIP
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.relmeta.outputs.tag }}
          name: ${{ steps.relmeta.outputs.name }}
          generate_release_notes: true
          files: |
            kernel-src/${{ env.ZIP_FILENAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
