name: Kernel Build (Single Variant Select)

on:
  workflow_dispatch:
    inputs:
      # --- æ ¸å¿ƒé…ç½® ---
      kernel_source_url:
        description: 'å†…æ ¸æºç ä»“åº“åœ°å€'
        required: true
        default: ''
      kernel_source_branch:
        description: 'æºç åˆ†æ”¯ (ç•™ç©ºé»˜è®¤)'
        required: false
        default: ''
      device_code:
        description: 'æœºå‹ä»£ç  (DEVICE)'
        required: true
        default: ''
      defconfig_name:
        description: 'Defconfig è·¯å¾„'
        required: true
        default: ''
      
      # --- ç¼–è¯‘ç‰ˆæœ¬é€‰æ‹© (ä¸‹æ‹‰èœå•) ---
      build_variant:
        description: 'é€‰æ‹©ç¼–è¯‘ç‰ˆæœ¬'
        required: true
        type: choice
        options:
          - vanilla
          - susfs
        default: vanilla

      # --- åŠŸèƒ½å¼€å…³ ---
      enable_lxc:
        description: 'å¯ç”¨ LXC/Docker è¡¥ä¸?'
        required: true
        type: boolean
        default: true

jobs:
  # åªæœ‰ä¸€ä¸ª Jobï¼Œæ ¹æ®ä¸‹æ‹‰èœå•çš„é€‰æ‹©æ‰§è¡Œä¸€æ¬¡
  build-selected-variant:
    name: Build ${{ inputs.build_variant }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    # 1. ç¯å¢ƒé…ç½®
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          bc bison build-essential ccache curl flex g++-multilib gcc-multilib \
          git gnupg gperf imagemagick libncurses-dev libsdl1.2-dev \
          libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool \
          squashfs-tools xsltproc zip zlib1g-dev python3 python3-pip wget unzip \
          lib32readline-dev lib32z1-dev liblz4-tool
        sudo ln -sf /usr/bin/python3 /usr/bin/python

    # 2. ä¸‹è½½å·¥å…·é“¾
    - name: Download Neutron Clang
      run: |
        mkdir -p toolchain
        cd toolchain
        git clone --depth=1 https://github.com/Neutron-Clang/neutron-clang.git clang

    # 3. ä¸‹è½½å†…æ ¸æºç 
    - name: Clone Kernel Source
      run: |
        URL="${{ inputs.kernel_source_url }}"
        BRANCH="${{ inputs.kernel_source_branch }}"
        if [ -z "$BRANCH" ]; then
          git clone --depth=1 "$URL" workspace
        else
          git clone --depth=1 -b "$BRANCH" "$URL" workspace
        fi

    # 4. åº”ç”¨ LXC è¡¥ä¸
    - name: Apply LXC patches
      if: ${{ inputs.enable_lxc }}
      working-directory: workspace
      run: |
        set -e
        # ä½¿ç”¨ inputs.build_variant ä»£æ›¿ matrix.variant
        echo "ğŸ”§ [${{ inputs.build_variant }}] æ­£åœ¨åº”ç”¨ LXC è¡¥ä¸..."
        LXC_URL="https://raw.githubusercontent.com/MIGHTYBLANK001/kernel-build-by-AI/refs/heads/main/Patchs/LXC_utils.zip"
        DEFCONFIG_FILE="arch/arm64/configs/${{ inputs.defconfig_name }}"
        
        wget -q "$LXC_URL" -O LXC_utils.zip
        rm -rf utils && unzip -o LXC_utils.zip -d utils && rm LXC_utils.zip

        # ä¿®æ”¹ Kconfig
        if [ -f "Kconfig" ]; then
            if ! grep -q 'source "utils/Kconfig"' Kconfig; then
                echo 'source "utils/Kconfig"' >> Kconfig
            fi
        fi

        # ä¿®æ”¹ Defconfig
        if [ -f "$DEFCONFIG_FILE" ]; then
            if ! grep -q '^CONFIG_DOCKER=y' "$DEFCONFIG_FILE"; then
                echo "CONFIG_DOCKER=y" >> "$DEFCONFIG_FILE"
            fi
            sed -i '/CONFIG_ANDROID_PARANOID_NETWORK/d' "$DEFCONFIG_FILE"
            echo "# CONFIG_ANDROID_PARANOID_NETWORK is not set" >> "$DEFCONFIG_FILE"
        else
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° Defconfig: $DEFCONFIG_FILE"; exit 1
        fi

        chmod +x utils/runcpatch.sh
        [[ -f kernel/cgroup/cgroup.c ]] && sh utils/runcpatch.sh kernel/cgroup/cgroup.c
        [[ -f kernel/cgroup.c ]] && sh utils/runcpatch.sh kernel/cgroup.c
        [[ -f net/netfilter/xt_qtaguid.c && -f utils/xt_qtaguid.patch ]] && patch -p0 < utils/xt_qtaguid.patch || true
        echo "âœ… è¡¥ä¸å®Œæˆ"

    # 5. ç”Ÿæˆ build.sh è„šæœ¬
    - name: Generate Build Script
      working-directory: workspace
      run: |
        cat << 'EOF' > build.sh
        #!/usr/bin/env bash
        source .env.sh
        THREAD=$(nproc --all);
        TARGET_KERNEL_FILE=arch/arm64/boot/Image;
        TARGET_KERNEL_DTB=arch/arm64/boot/dtb;
        TARGET_KERNEL_DTBO=arch/arm64/boot/dtbo.img
        DEFCONFIG_PATH=arch/arm64/configs
        DEFCONFIG_NAME="vendor/${DEVICE}_user_defconfig";
        START_SEC=$(date +%s);
        TARGET_KERNEL_NAME=$(cat $DEFCONFIG_PATH/$DEFCONFIG_NAME | grep CONFIG_LOCALVERSION= | cut -d = -f 2 | sed 's/"//g' | sed 's/^-//')
        TARGET_KERNEL_VERSION=$(make kernelversion);
        GIT_COMMIT=$(git rev-parse --short HEAD);
        ANYKERNEL_PATH=AnyKernel3;

        declare -A BUILD_VARIANTS_MAP=(
            ["vanilla"]=""
            ["susfs"]="vendor/kernelsu.config"
            ["debug"]="vendor/debug.config"
        )
        BUILD_VARIANT="vanilla"

        parse_args(){
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    -v|--variant)
                    if [[ -n "${BUILD_VARIANTS_MAP[$2]}" || "$2" == "vanilla" ]]; then
                        BUILD_VARIANT="$2"; shift 2
                    else
                        exit 1
                    fi ;;
                    *) shift 1 ;;
                esac
            done
        }
        parse_args "$@";

        OUT="../out/$DEVICE/$BUILD_VARIANT"
        build_args="CC=clang ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_COMPAT=arm-linux-gnueabi- CLANG_TRIPLE=aarch64-linux-gnu- LLVM=1 LLVM_IAS=1 LD=ld.lld O=$OUT -j$THREAD KBUILD_BUILD_USER=$BUILD_USER KBUILD_BUILD_HOST=$BUILD_HOST";
        TARGET_PACKAGED_KERNEL_NAME=$TARGET_KERNEL_NAME-$TARGET_KERNEL_VERSION-$BUILD_VARIANT-$GIT_COMMIT;

        link_all_dtb_files(){ find $OUT/arch/arm64/boot/dts/vendor/qcom -name '*.dtb' -exec cat {} + > $OUT/arch/arm64/boot/dtb; }

        make_defconfig(){
            echo " Building Kernel Defconfig.."
            FRAGMENT="${BUILD_VARIANTS_MAP[$BUILD_VARIANT]}"
            if [[ -n "$FRAGMENT" ]]; then
                DEFCONFIG_NAME="$DEFCONFIG_NAME $FRAGMENT"
            fi
            make $build_args $DEFCONFIG_NAME;
        }

        build_kernel(){
            echo " Building Kernel ...........";
            make $build_args;
        }

        patch_kernel_properties(){
            sed -i -e "s|\${KERNEL_STRING}|${KERNEL_STRING}|g" -e "s|\${DEVICE}|${DEVICE}|g" -e "s|\${SUPPORTED_VERSIONS}|${SUPPORTED_VERSIONS}|g" $ANYKERNEL_PATH/anykernel.sh;
        }

        generate_flashable(){
            echo " Generating Flashable Kernel";
            cd $OUT;
            if [ ! -d $ANYKERNEL_PATH ]; then
                git clone --depth=1 https://github.com/august-aosp/AnyKernel3.git $ANYKERNEL_PATH;
                patch_kernel_properties;
            fi
            rm -rf $ANYKERNEL_PATH/$TARGET_KERNEL_NAME*;
            cp -r $TARGET_KERNEL_FILE $ANYKERNEL_PATH/;
            cp -r $TARGET_KERNEL_DTB $ANYKERNEL_PATH/;
            if [ -f "$TARGET_KERNEL_DTBO" ]; then cp -r $TARGET_KERNEL_DTBO $ANYKERNEL_PATH/; fi
            cd $ANYKERNEL_PATH;
            zip -q -r $TARGET_PACKAGED_KERNEL_NAME.zip *;
        }

        clean(){
            make mrproper -j$THREAD;
            make clean -j$THREAD;
            rm -rf $OUT;
        }

        main(){
            clean; make_defconfig; build_kernel; link_all_dtb_files; generate_flashable;
        }
        main;
        EOF
        chmod +x build.sh

    # 6. é…ç½®å¹¶æ‰§è¡Œæ„å»º
    - name: Run Build (${{ inputs.build_variant }})
      working-directory: workspace
      run: |
        export PATH=$GITHUB_WORKSPACE/toolchain/clang/bin:$PATH
        
        sed -i 's|DEFCONFIG_NAME="vendor/${DEVICE}_user_defconfig";|DEFCONFIG_NAME="${{ inputs.defconfig_name }}";|g' build.sh
        
        echo "export DEVICE=${{ inputs.device_code }}" >> .env.sh
        echo "export BUILD_USER=GitHubAction" >> .env.sh
        echo "export BUILD_HOST=GitHub-Runner" >> .env.sh
        # ä½¿ç”¨ inputs.build_variant
        echo "export KERNEL_STRING=${{ inputs.device_code }}-${{ inputs.build_variant }}" >> .env.sh
        echo "export SUPPORTED_VERSIONS=11,12,13,14,15" >> .env.sh
        chmod +x .env.sh
        
        # è¿è¡Œæ„å»ºè„šæœ¬ (ä¼ å…¥é€‰æ‹©çš„å˜ä½“å‚æ•°)
        bash build.sh --variant ${{ inputs.build_variant }} cleanbuild

    # 7. ç”Ÿæˆ Release Tag
    - name: Generate Release Tag
      id: tag_gen
      run: |
        # ä½¿ç”¨ inputs.build_variant
        echo "release_tag=${{ inputs.device_code }}-${{ inputs.build_variant }}-$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT

    # 8. ä¸Šä¼ äº§ç‰©
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: ${{ steps.tag_gen.outputs.release_tag }}
        # ä½¿ç”¨ inputs.build_variant
        name: ${{ inputs.device_code }} [${{ inputs.build_variant }}]
        body: |
          Automated Build
          - Device: ${{ inputs.device_code }}
          - Variant: ${{ inputs.build_variant }}
          - LXC Patch: ${{ inputs.enable_lxc }}
        files: workspace/AnyKernel3/*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
